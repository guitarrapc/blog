---
Title: git pull をサブディレクトリでまとめて実行するスクリプト
Category:
- Git
Date: 2023-05-11T03:34:56+09:00
URL: https://tech.guitarrapc.com/entry/2023/05/11/000000
EditURL: https://blog.hatena.ne.jp/guitarrapc_tech/guitarrapc-tech.hatenablog.com/atom/entry/4207575160647825178
Draft: true
CustomPath: 2023/05/11/000000
---

リポジトリが30ほどある時に、そのすべてのローカルGit を更新したいことがまれによくあります。
Windows、macOS、Linux 各種でサブディレクトリにあるローカルGit で git pull を一気に行う必要があったのでスクリプトをおいておきます。

[:contents]

# tl;dr;

* バッチファイル、PowerShellスクリプト、シェルスクリプトで同様にパラメーターを受け取り、動作するスクリプトが用意できる。
* OS に応じて手元にあると便利、かもしれない。

gist においておきます。

> https://gist.github.com/guitarrapc/2623623a0e1bc7fe86b5cf56e0c70d88

# やりたいこと

現在のフォルダ以下に次のように複数の Gitリポジトリがクローンされた状態で、まとめてすべて git pull したいことがあります。

```
$ tree -L 1
.
├── Bar
├── Foo
├── Piyo
├── Hoge
├── ... # なにかいろいろ 30個ぐらい
└── NanikaSugoiRepo
```

コミットしていない変更があるリポジトリがあったりを考えると、それぞれのリポジトリで git pullをすると時間がいくらあっても足りません。
そんな時にリポジトリをとりあえず今の ref に対して最新に更新したいよねというものです。

```bash
cd ./Bar && git pull && cd - # stash や git reset --hard をしたいかもしれない
cd ./Foo && git pull && cd -
...
# と並べるのはやりたくない
```

# 書いてみよう

ワンライナーで書くのもいいですが、各種OS でサクッとやりたいので、バッチファイル、PowerShellスクリプト、シェルスクリプトで同じような引数を受け取って同じように動作するように書いてみましょう。

やりたくなることを見越して、パラメーターで `git stash` と `git reset --hard` もやるか選べるようにしましょう。`git stash` はデフォルト有効でパラメーターでしないことを指定 (`--no-stash`)、`git reset --hard` はデフォルトは行わずパラメーターですることを指定できる (`--force`)、とします。

つまりこんな感じをイメージして書きます。

```bash
# Windows バッチファイル
git-pull.bat --force --no-stash

# PowerShell スクリプト
./git-pull.ps1 -Force --NoStash

# シェルスクリプト
bash ./git-pull.sh --force --no-stash
```

さっそく見てみましょう。


## Windowsバッチファイル

git-pull.bat

```bat
:: Script to run `git pull` inside all subdirectories which are git repositories.
:: usage 1: keep local changes, then up to date.
::   > git-pull.bat
:: usage 2: abort local changes, reset if possible, then up to date.
::   > git-pull.bat --force --no-stash
:: usage 3: try keep local changes, reset if possible, then up to date.
::   > git-pull.bat --force

@echo off

setlocal
:parse
    IF "%~1"=="" GOTO endparse
    IF "%~1"=="--force" set _FORCE=true
    IF "%~1"=="--no-stash" set _NO_STASH=true
    SHIFT
    GOTO parse
:endparse

for /f "tokens=* delims=" %%i in ('dir /ad /b "."') do (
    echo --- Working on %cd%\%%i
    pushd "%cd%\%%i"
        if NOT EXIST ".git\" (
            echo   x: \"%cd%\%%i\" is not a git repository, continue next directory.
        ) else (
            if not "%_NO_STASH%"=="true" ( git stash --quiet )
            if "%_FORCE%"=="true" ( git reset --hard )
            git pull
            if not "%_NO_STASH%"=="true" ( git stash apply --quiet )
        )
    popd
)

endlocal
```

## PowerShellスクリプト

git-pull.ps1

```ps1
# Script to run `git pull` inside all subdirectories which are git repositories.
# usage 1: keep local changes, then up to date.
#   PS> ./git-pull.ps1
# usage 2: abort local changes, reset if possible, then up to date.
#   PS> ./git-pull.ps1 -Force -NoStash
# usage 3: try keep local changes, reset if possible, then up to date.
#   PS> ./git-pull.ps1 -Force

param(
    [Switch]$Force,
    [Switch]$NoStash
)

foreach ($dir in Get-ChildItem -Directory) {
    try {
        pushd $dir.FullName
            echo "--- Working on ""$($dir.FullName)"""

            if ((Get-ChildItem -Force -Directory).Name -notcontains ".git") {
                echo "  x: ""$($dir.FullName)"" is not a git repository, continue next directory."
                continue
            }

            if (!$NoStash) { git stash --quiet }
            if ($Force) { git reset --hard }
            git pull
            if (!$NoStash) { git stash apply --quiet }
    } finally {
        popd
    }
}
```

## シェルスクリプト

git-pull.sh

```bash
#!/bin/bash
set -o pipefail

# Script to run `git pull` inside all subdirectories which are git repositories.
# usage 1: keep local changes, then up to date.
#   $ bash ./git-pull.sh
# usage 2: abort local changes, reset if possible, then up to date.
#   $ bash ./git-pull.sh --force --no-stash
# usage 3: try keep local changes, reset if possible, then up to date.
#   $ bash ./git-pull.sh --force

while [ $# -gt 0 ]; do
    case $1 in
        --force) _FORCE=true; shift 1; ;;
        --no-stash) _NO_STASH=true; shift 1; ;;
        *) shift ;;
    esac
done

## find is not a good way to control. Additionally, this include CURRENT directory and it is unexpected.
# find . -maxdepth 1 -type d -exec bash -c 'echo "Working on $(realpath $1)"; git reset --force; git pull' shell {} \;

for dir in ./*/; do
    echo "--- Working on \"$(realpath "${dir}")\""
    pushd "$(realpath "${dir}")" > /dev/null
        if [[ ! -d ".git" ]]; then
            echo "  x: \"$(realpath "${dir}")\" is not a git repository, continue next directory."
            popd > /dev/null
            continue
        fi
        if [[ "${_NO_STASH:=false}" != "true" ]]; then git stash --quiet; fi
        if [[ "${_FORCE:=false}" == "true" ]]; then git reset --hard; fi
        git pull
        if [[ "${_NO_STASH:=false}" != "true" ]]; then git stash apply --quiet; fi
    popd > /dev/null
done

```

# メモ

どのスクリプトも、フォルダが git フォルダじゃない場合は次に行きます。
また、エラーが出ても止まらないようにしています。これは、`set -e` (シェルスクリプト) や `$ErrorActionPreference = "Stop"` (PowerShell)、あるいは`%errorlevel%` を都度チェック (Windowsバッチファイル) でできます。

**Windowsバッチファイル**

パラメーター引数を受け取るのは [Window バッチファイルでパラメーター入力を受け付ける](https://tech.guitarrapc.com/entry/2023/05/10/000000) で紹介したやり方です。
サブディレクトリで何かコマンドを実行するとなると、やはり `for` を使うのがいいのかなぁと思いますが、Ctrl+C でのキャンセルで Y を選ばないとまとめてキャンセルできなくなるのがいやですね。
地味に echo でクォートが使えないのが不便です。

**PowerShellスクリプト**

try/finally を使えば、コマンドキャンセルでもフォルダ移動しっぱなしが防げます。地味に便利。
パラメーター受け取りから制御処理まで、全体的に小細工がなく、素直に書けばそのまま動くのは PowerShell えらい。
PowerShell 7移行がデファクトになれば...

**シェルスクリプト**

引数受け取りは `while` + `case` + `shift` がシンプルかつパラメーター調整しやすいのでよく使っています。
フォルダ一覧とるなら`find`を使いたいところですが、`-exec` でコマンド並べるのは厳しいので雑に glob で。
シェルスクリプトあるあるなことしかしないようにしていますが、もう少しいい書き方があればいいんですが。

# 参考

* 似た処理で参考にしたもの: https://gist.github.com/phette23/7620214
