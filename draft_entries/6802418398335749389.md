---
Title: EKS AutoModeã¯é€šå¸¸ãƒ¢ãƒ¼ãƒ‰ã¨ä½•ãŒé•ã†ã®ã‹
EditURL: https://blog.hatena.ne.jp/guitarrapc_tech/guitarrapc-tech.hatenablog.com/atom/entry/6802418398335749389
PreviewURL: https://tech.guitarrapc.com/draft/entry/ln7wiHg0Cs_VGd1Q8TUWIQBJH6k
Draft: true
---

2024/12/1ã«re:Inventã§[ç™ºè¡¨](https://aws.amazon.com/jp/about-aws/whats-new/2024/12/amazon-eks-auto-mode/)ã•ã‚ŒãŸEKS AutoModeã¨é€šå¸¸ãƒ¢ãƒ¼ãƒ‰ã®é•ã„ã«ã¤ã„ã¦ã¾ã¨ã‚ã¾ã™ã€‚
AWSã¨ã—ã¦ã¯ã€EKS AutoModeã‚’ä»Šå¾ŒEKSã‚’æ§‹ç¯‰ã™ã‚‹æ™‚ã®ã‚¹ã‚¿ãƒ³ãƒ€ãƒ¼ãƒ‰ã«ã—ã¦ã„ããŸã„ã‚“ã ã‚ã†ãªã¨æ„Ÿã˜ã¾ã™ã€‚ãŸã ã€AutoModeã¯EKS Addonã‚„Karpenterã‚’ã¯ã˜ã‚ã€çµ„ã¿è¾¼ã¿ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãŒéš è”½ã•ã‚Œã¦ãŠã‚Šé•ã„ã‚’çŸ¥ã£ã¦ãŠã‹ãªã„ã¨æˆ¸æƒ‘ã†æ„Ÿã˜ãŒã‚ã‚Šã¾ã™ã€‚

æœ¬è¨˜äº‹ã§ã¯EKS AutoModeã‚’æ§‹ç¯‰ã€é€šå¸¸ãƒ¢ãƒ¼ãƒ‰ã§çµ„ã‚€ã‚ˆã†ãªKarpenteræ“ä½œã‚’åŠ ãˆã¦é•ã„ã‚’è¦‹ã¦ã„ãã¾ã™ã€‚

[:contents]

# EKS AutoModeã®ã‚³ãƒ³ã‚»ãƒ—ãƒˆ

EKS AutoModeã¯ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ç®¡ç†ã‚’AWSã«[ã‚ªãƒ•ãƒ­ãƒ¼ãƒ‰ã—ã¦ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³é–‹ç™ºã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹](https://aws.amazon.com/jp/blogs/containers/getting-started-with-amazon-eks-auto-mode/)ã¨ã„ã†ã®ãŒã‚³ãƒ³ã‚»ãƒ—ãƒˆã¨ã•ã‚Œã¦ã„ã¾ã™ã€‚

ãã®ä¾‹ã¨ã—ã¦ã€æ¬¡ã®å›³ãŒç¤ºã•ã‚Œã¦ã„ã¾ã™ã€‚ã“ã‚Œã¾ã§ã®EKSã§ã¯AddOnsã‚„EC2ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†ã—ã¦ã„ãŸã®ã«å¯¾ã—ã¦ã€Auto Modeã¯ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸/ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ãƒˆ/ãƒ­ãƒ¼ãƒ‰ãƒãƒ©ãƒ³ã‚µãƒ¼ç®¡ç†ã‚’AWSãŒæ‹…ä¿ã—EC2ã«ã‚‚é–¢ä¸ã™ã‚‹ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ã€‚

> ![image](https://github.com/user-attachments/assets/7199547b-cfd5-4db4-a4da-7fa790fcbe63)
>
> Before Auto Mode

> ![image](https://github.com/user-attachments/assets/431bfd3e-b446-44a8-9c33-97ea5d83a61b)
>
> After Auto Mode

# ã‚³ãƒ³ã‚»ãƒ—ãƒˆã‹ã‚‰å—ã‘ã‚‹å°è±¡ã¨å®Ÿæƒ…

EKS AutoModeã¯ã“ã®ã‚³ãƒ³ã‚»ãƒ—ãƒˆå›³ã‹ã‚‰æ¬¡ã®ã‚ˆã†ãªå°è±¡ã‚’å¾—ã¾ã™ã€‚

* EKS Addonsã¯AWSãŒç®¡ç†ã™ã‚‹ãŸã‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯å°å…¥ä¸è¦ã«ãªã£ãŸ
* EC2ã®ã‚ªãƒ¼ãƒˆã‚¹ã‚±ãƒ¼ãƒ«ã¯AWSã«å®Œå…¨ãŠä»»ã›ã§ãã‚‹
* Ingressã‹ã‚‰LBä½œæˆã‚„ç®¡ç†ã€TargetGroupç´ã¥ã‘ã‚‚ä»»ã›ã‚‰ã‚Œã‚‹
* ä½œæˆã•ã‚ŒãŸALBã‚„EBSã€EC2ã¯å¼•ãç¶šããƒ¦ãƒ¼ã‚¶ãƒ¼ãŒé–¢ä¸ã§ãã‚‹

å®Ÿéš›ä½¿ã£ã¦ã¿ã‚‹ã¨æœŸå¾…ã«è¿‘ã„ã‚‚ã®ã®ã€å¾“æ¥ã®EKSç®¡ç†ã‹ã‚‰è¦‹ã‚‹ã¨ãã“ã¾ã§æ¥½ã«ãªã£ãŸã‹ã¯æ‚©ã¾ã—ã„å´é¢ã‚‚ã‚ã‚Šã¾ã™ã€‚ã¾ãŸã€ä»¥ä¸‹2ç‚¹ã¯ã‚³ãƒ³ã‚»ãƒ—ãƒˆã‹ã‚‰èª­ã¿è§£ã‘ãªã„ã§ã—ã‚‡ã†ã€‚

* helmã¯ã©ã†ãªã‚‹ã®ã‹
* podã®æ°´å¹³ã‚¹ã‚±ãƒ¼ãƒ«ãŒã©ã†ãªã‚‹ã®ã‹

## EKS Addonsã¯AWSãŒç®¡ç†ã™ã‚‹ãŸã‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯å°å…¥ä¸è¦ã«ãªã£ãŸ

ã“ã‚Œã¯å—ã‘ãŸå°è±¡ãã®ã¾ã¾ã§ã™ã€‚EKS Addonã‚’è¿½åŠ ä¸è¦ã€Podã‚‚è¦‹ãˆãªããªã£ãŸã®ã§ãƒãƒãƒ¼ã‚¸ãƒ‰ã ãªã¨ã„ã†å°è±¡ã¨å®Ÿæ„ŸãŒæƒã£ã¦ã„ã¾ã™ã€‚

* âœ”ï¸: ã“ã‚Œã¾ã§EKSã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã§å¿…é ˆã¨ã„ã£ã¦ã‚‚ã‚ˆã‹ã£ãŸCoreDNSã€kube-proxyã€VPC CNIã¯AutoModeã§ã¯å°å…¥ä¸è¦
* âœ”ï¸: Node LocalDNSã‚‚çµ„ã¿è¾¼ã¿ã«ãªã£ãŸ
* âœ”ï¸: CoreDNSã€kube-proxyã€VPC CNIã®Podã‚„ãƒªã‚½ãƒ¼ã‚¹ã¯Auto ModeãªEKSã§ã¯kubectlã§è¦‹ãˆãªã„
* âš ï¸: ã‚µãƒ¼ãƒ‰ãƒ‘ãƒ¼ãƒ†ã‚£EKS Addonã®æ–°Kubernetesãƒãƒ¼ã‚¸ãƒ§ãƒ³å¯¾å¿œã¯å¼•ãç¶šãå¾…ã¤å¿…è¦ãŒã‚ã‚‹

ã“ã‚Œã‚‰ã®Addonã‚„ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã¯EKSã§å¿…é ˆãªã‚ã‚Šã«æ‰‹å½“ãŒå…¨ç„¶ãªãã¦ã—ã‚“ã©ã•ã—ã‹ãªã£ãŸã®ã§ã€éå¸¸ã«å¥½ã¾ã—ã„å¯¾å¿œã§ã™ã€‚æœ€é«˜!

ãŸã ã€3rdãƒ‘ãƒ¼ãƒ†ã‚£ã®EKS AddonãŒåˆ©ç”¨ã§ãã‚‹ã‹ã¯EKSã®Kubernetesã«ä¾å­˜ã—ã¾ã™ã€‚ä¾‹ãˆã°ã€ç¾åœ¨EKS 1.32ãŒæœ€æ–°ã§ã™ãŒ3rdãƒ‘ãƒ¼ãƒ†ã‚£EKS Addonã®å¤šãã¯å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚æ‚²ã—ã„ã€‚

## EC2ã®ã‚ªãƒ¼ãƒˆã‚¹ã‚±ãƒ¼ãƒ«ã¯AWSã«å®Œå…¨ãŠä»»ã›ã§ãã‚‹

å®Œå…¨ãŠä»»ã›ã«ã¯ã§ãã¾ã›ã‚“ãŒã€æ¬¡ã®é™å®šçš„ãªã‚·ãƒ¼ãƒ³ã§ã¯ãŠä»»ã›ã§ãã¾ã™ã€‚

* âœ”ï¸: EKS AutoModeã¯Karpenterã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ã‚’çµ„ã¿è¾¼ã¿ã§æŒã£ã¦ã„ã‚‹
* âœ”ï¸: ä»»ã›ã‚‹å ´åˆã€SPOTã¯ä½¿ã‚ãªã„ã€amd64ã§ã—ã‹ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å‹•ä½œã—ãªã„ã€ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚µã‚¤ã‚ºã¯80GBå›ºå®šã€ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚¿ã‚¤ãƒ—ã‚‚ä»»ã›ã‚‹
* âš ï¸: ä¸Šã‚’ä¸€ã¤ã§ã‚‚å¤‰ãˆãŸã„å ´åˆã€è‡ªåˆ†ã§Karpenterã®NodeClass[^1]ã€NodePoolå®šç¾©ã‚’æ›¸ãå¿…è¦ãŒã‚ã‚‹
* âš ï¸: AMIã¯å¸¸ã«æœ€æ–°ãŒåˆ©ç”¨ã•ã‚Œã‚‹(è‡ªå‹•ãƒ‘ãƒƒãƒ)
* âš ï¸: EKS AutoModeç®¡ç†ã®Karpenterã§ä½œã‚‰ã‚ŒãŸEC2ã¯è¿½åŠ æ–™é‡‘ãŒã‹ã‹ã‚‹(+11-12%ç¨‹åº¦)

EKS AutoModeã®ãƒãƒ¼ãƒ‰æ°´å¹³ã‚¹ã‚±ãƒ¼ãƒ«ã¯ã»ã¼Karpenterãã®ã¾ã¾ãªã®ã§ã€Karpenter 1.2ä»¥ä¸Šã‚’ä½¿ã£ã¦ã„ã‚‹äººãªã‚‰æˆ¸æƒ‘ã†ã“ã¨ãªãè‡ªåˆ†ã®NodeClassã‚„NodePoolå®šç¾©ã‚’æ›¸ãã“ã¨ãŒã§ãã¾ã™ã€‚

NodeClassã¯EC2NodeClassã¨é•ã£ã¦amiSelectorãŒãªããªã£ã¦ã„ã¾ã™ã€‚ãã®ãŸã‚ã€AMIã‚’æŒ‡å®šã›ãšã¨ã‚‚æœ€æ–°ãŒä½¿ã‚ã‚Œã‚‹ä¸€æ–¹ã§ã€AMIã‚’å›ºå®šã™ã‚‹ã“ã¨ãŒã§ããªããªã£ã¦ã„ã‚‹ã®ã§æ³¨æ„ãŒå¿…è¦ã§ã™ã€‚

æ°—ã«ãªã‚‹ç‚¹ã¯ã‚³ã‚¹ãƒˆã§ã™ã€‚EKS AutoModeã®çµ„ã¿è¾¼ã¿Karpenterã§èµ·å‹•ã—ãŸEC2ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã¯è¿½åŠ æ–™é‡‘ãŒ11-12%ç¨‹åº¦ã‹ã‹ã‚Šã¾ã™ã€‚ã‚ªãƒ³ãƒ‡ãƒãƒ³ãƒ‰ãƒ»ã‚¹ãƒãƒƒãƒˆã«ã‹ã‹ã‚ã‚‰ãšå›ºå®šé‡‘é¡ã‹ã‹ã‚‹ã®ã§ã€å˜ç´”ã«EKS AutoModeã«ã™ã‚‹ã¨ã‚³ã‚¹ãƒˆãŒ12%ç¨‹åº¦ä¸ŠãŒã‚‹ã¨è€ƒãˆã¦ã‚‚å·®æ”¯ãˆãªã„ã§ã—ã‚‡ã†[^2]ã€‚

**EC2ã‚³ã‚¹ãƒˆå¢—åŠ åˆ†ã®å€‹äººçš„æ‰€æ„Ÿ**

Karpenterã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ãƒ»å¾“æ¥EKS Addonã®PodãŒè¦‹ãˆãªã„ã“ã¨ã‹ã‚‰ã€EC2ã‚³ã‚¹ãƒˆè¿½åŠ æ–™é‡‘ã¯ã“ã‚Œã‚‰ã®ç¨¼åƒåˆ†ã¨ã—ã¦ã‹ã‹ã£ã¦ã„ã‚‹ã®ã‹ãªã¨æ„Ÿã˜ã¾ã™ã€‚ã—ã‹ã—ã€Karpenterã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ã§2Podå‹•ä½œãƒ»EKSAddonå„ç¨®ã§6-10podç¨‹åº¦å¢—ãˆã‚‹ç¨‹åº¦ãªã®ã§å…¨EC2ãƒãƒ¼ãƒ‰ã«11-12%ã‚³ã‚¹ãƒˆä¸Šä¹—ã›ã™ã‚‹ã®ã¯ã¡ã‚‡ã£ã¨ç´å¾—æ„Ÿã‚ã‚Šã¾ã›ã‚“ã€‚

SPã‚„RIã€ã‚¹ãƒãƒƒãƒˆã§ã‚‚å¤‰ã‚ã‚‰ãªã„1å°å½“ãŸã‚Šè¿½åŠ æ–™é‡‘ãªã®ã§ã€è²»ç”¨ä½æ¸›ç­–ã‚’ã—ã¦ã„ã‚‹ã»ã©é‡ããªã‚Šã¾ã™ã‚ˆã­ã€‚

## Ingressã‹ã‚‰LBä½œæˆã‚„ç®¡ç†ã€TargetGroupç´ã¥ã‘ã‚‚ä»»ã›ã‚‰ã‚Œã‚‹

å®Œå…¨ãŠä»»ã›ã«ã¯ã§ãã¾ã›ã‚“ãŒã€æ¬¡ã®é™å®šçš„ãªã‚·ãƒ¼ãƒ³ã§ã¯ãŠä»»ã›ã§ãã¾ã™ã€‚

* âœ”ï¸: EKS AutoModeã¯Elastiï½ƒ Load Balancingã‚’ç®¡ç†ã™ã‚‹ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ã‚’çµ„ã¿è¾¼ã¿ã§æŒã£ã¦ã„ã‚‹
* âœ”ï¸: ALBã‚„NLBã‚’Ingress/Serviceã§ç®¡ç†ã™ã‚‹å ´åˆã¯ä»»ã›ã‚‰ã‚Œã‚‹
* âš ï¸: æ—¢å­˜ã®ALBã‚’EKS AutoModeã«ç›´æ¥ãƒã‚¤ã‚°ãƒ¬ãƒ¼ãƒˆã§ããªã„
* ğŸ†–: [TargetGroupBindingã«å¯¾å¿œã—ã¦ã„ãªã„](https://github.com/aws/containers-roadmap/issues/2508)

EKS AutoModeã§ã¯AWS LoadBalancer Controllerã‚’çµ„ã¿è¾¼ã¿ã§æŒã£ã¦ã„ã‚‹ã¨è¨€åŠã—ã¦ãŠã‚‰ãšã‚¿ã‚°ãŒé•ã£ã¦ã„ãŸã‚Šã€annotationsã§ã¯ãªãIngressClassParamsã§æ§‹æˆèª¿æ•´ã«ãªã£ã¦ã„ã‚‹ã®ã§ç‹¬è‡ªã®ä»•çµ„ã¿ã«ãªã£ã¦ãã†ã§ã™ã€‚

ã‚‚ã—ã‚‚AWS LoadBalancer Controllerã‚’ä½¿ã£ã¦ã„ã‚‹æ—¢å­˜EKSã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã‚’Auto Modeã«å¤‰æ›´ã—ã¦ALBç®¡ç†ã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹å ´åˆã€[ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://docs.aws.amazon.com/eks/latest/userguide/migrate-auto.html)ã«æ²¿ã£ã¦DNSãƒ™ãƒ¼ã‚¹ã®ãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯ã‚·ãƒ•ãƒˆ(Route53ã®åŠ é‡ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°)ã‚’ä½¿ã†ã®ãŒã„ã„ã§ã—ã‚‡ã†ã€‚[^3]

## ä½œæˆã•ã‚ŒãŸALBã‚„EBSã€EC2ã¯å¼•ãç¶šããƒ¦ãƒ¼ã‚¶ãƒ¼ãŒé–¢ä¸ã§ãã‚‹

çµ„ã¿è¾¼ã¿Karpenterã§ä½œã‚‰ã‚ŒãŸEC2(AutoModeç®¡ç†ãƒãƒ¼ãƒ‰)ã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®é–¢ä¸ãŒå¯èƒ½ãªå´é¢ã¨ã§ããªããªã£ãŸå´é¢ãŒã‚ã‚Šã¾ã™ã€‚EC2ã‚’ç›´æ¥æ¶ˆã›ãªããªã£ãŸã®ã¯å®‰å…¨ã§ã™ãŒã€ä¸€æ–¹ã§å¤œé–“åœæ­¢ãªã©ã®ã‚¢ãƒ—ãƒ­ãƒ¼ãƒæ–¹æ³•ãŒä¸€ã¤æ¸›ã‚Šã¾ã—ãŸã€‚[^4]

* âœ”ï¸: EKS AutoModeã§ä½œæˆã•ã‚ŒãŸEC2ã€ALBã€NLBã€EBSãªã©ã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®AWSã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§ç¢ºèªã§ãã‚‹ã€‚
* âš ï¸: AutoModeç®¡ç†ãƒãƒ¼ãƒ‰ã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæ¶ˆã›ãªã„ã€ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢è¿½åŠ ã§ããªã„ã€SSHã§ããªã„
* âš ï¸: AutoModeç®¡ç†ãƒãƒ¼ãƒ‰ã¯æœ€å¤§21æ—¥å¯¿å‘½ã ãŒPDBã§åˆ¶å¾¡ãŒå¿…è¦

ãƒãƒãƒ¼ã‚¸ãƒ‰ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®[ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://docs.aws.amazon.com/eks/latest/userguide/automode-learn-instances.html)ã«ã‚ã‚‹é€šã‚Šã€EKS AutoModeã§èµ·å‹•ã—ãŸEC2ã¯EKSç®¡ç†ä¸‹ã«ãªã‚‹ãŸã‚ãƒ‘ãƒƒãƒã‚ã¦ã€ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã€sshã¯ã§ããªããªã£ã¦ã„ã¾ã™ã€‚

ç‰¹ã«æœ€å¤§21æ—¥å¯¿å‘½ãªã®ã¯ãƒ¯ãƒ¼ã‚¯ãƒ­ãƒ¼ãƒ‰ã‚’é¸ã³ã¾ã™ã€‚ã‚²ãƒ¼ãƒ ã‚µãƒ¼ãƒãƒ¼ã§ã‚ˆãã‚ã‚‹ã€Œã‚¤ãƒ³ãƒ¡ãƒ¢ãƒªã«ãƒ‡ãƒ¼ã‚¿ã‚’æŒã¤ã‚µãƒ¼ãƒãƒ¼ã€ã¯ã€æ™‚ã«ãƒ¯ãƒ¼ãƒ«ãƒ‰ã‚µãƒ¼ãƒãƒ¼ã¨å‘¼ã°ã‚Œã‚‹å¤§é‡å¸¸æ™‚æ¥ç¶šã‚’ã•ã°ãã€é•·æ™‚é–“èµ·å‹•ã—ã£ã±ãªã—ã«ã™ã‚‹ã‚±ãƒ¼ã‚¹ãŒã‚ã‚Šã¾ã™ã€‚ã“ã®ã‚±ãƒ¼ã‚¹ã§ã¯ãƒ¯ãƒ¼ãƒ«ãƒ‰ã‚µãƒ¼ãƒãƒ¼ã®åœæ­¢ã¯ã‚²ãƒ¼ãƒ ã®åœæ­¢ã‚’æ„å‘³ã™ã‚‹ãŸã‚ã€ã‚µãƒ¼ãƒãƒ¼ã®å…¥ã‚Œæ›¿ãˆã‚‚ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã‚’é¸ã¶ã“ã¨ã«ãªã‚Šã¾ã™ã€‚ãã†ã€å¯¿å‘½æ—¥æ•°ã¨ãƒãƒ¼ãƒ‰ãƒªãƒŸãƒƒãƒˆã•ã‚Œã‚‹ã®ã¨è‡´å‘½çš„ã«ç›¸æ€§ãŒæ‚ªã„ã‚“ã§ã™ã­ã€‚

## helmã¯ã©ã†ãªã‚‹ã®ã‹

AutoModeã«ãªã£ã¦ã‚‚ã€Helmã¯å¼•ãç¶šããƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†ã§ã™ã€‚ãã‚Œã¯ãã†ã€‚ãã—ã¦ã€EKSã§ä¸€ç•ªã¤ã‚‰ã„ã®ã¯å®Ÿã®ã¨ã“ã‚Helmã§ã‚‚ã‚ã‚‹ã®ã§ãã¤ã•ã¯ä½•ã‚‚è»½æ¸›ã—ã¦ã„ã¾ã›ã‚“ã€‚Helmã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ã¯åœ°ç„å®‰å®šã€‚

* âš ï¸: EKS AutoModeã§ã‚‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè‡ªåˆ†ã§å°å…¥ã—ãŸHelmã¯è‡ªåˆ†ã§ç®¡ç†ãŒå¿…è¦

3rdãƒ‘ãƒ¼ãƒ†ã‚£EKS Addonã«ã™ã‚Œã°æ¥½ã«ãªã‚‹ã¨ã‹æ€ã£ã¦ã—ã¾ã„ãã†ã§ã™ãŒã€EKS Addoã”ã¨ã«Kubernetesãƒãƒ¼ã‚¸ãƒ§ãƒ³å¯¾å¿œã‚’å¾…ã¤å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚Kubernetes 1.32ã¸ã®å¯¾å¿œãŒ3/15æ™‚ç‚¹ã§ã‚‚ã‚ã¾ã‚Šé€²ã‚“ã§ãªã„ç¾çŠ¶ã‹ã‚‰ã™ã‚‹ã¨ã€å¼•ãç¶šãè‡ªå‰Helmã§ã®å°å…¥ã¯å¿…è¦ãªã‚±ãƒ¼ã‚¹ã¯å¤šã„ã§ã—ã‚‡ã†ã€‚ãŒã‚“ã°ã‚Šã¾ã—ã‚‡ã†ã€‚

## podã®æ°´å¹³ã‚¹ã‚±ãƒ¼ãƒ«ãŒã©ã†ãªã‚‹ã®ã‹

AutoModeã¯Podã®æ°´å¹³ã‚¹ã‚±ãƒ¼ãƒ«ã«é–¢ä¸ã—ã¾ã›ã‚“ã€‚Podã¯ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãŒã‚„ã‚‹ã¹ãã“ã¨ã§ã™ã‹ã‚‰å½“ç„¶ã§ã™ã­ã€‚ã¨ã¯ã„ãˆKEDAãã‚‰ã„ã¯å…¥ã‚Œã¦ã»ã—ã‹ã£ãŸã€‚HPAã¯å³ã—ã„ã€‚

* âš ï¸: EKS AutoModeã§ã‚‚HPAä»¥å¤–ã¯ãªã„ã€‚KEDAã‚’ä½¿ã†ãªã‚‰è‡ªå‰Helmå°å…¥ãŒå¿…è¦ã€‚

# EKS AutoModeã®ç·è©•

å°è¦æ¨¡ãªç’°å¢ƒ(é–‹ç™ºã‚„æ¤œè¨¼ç’°å¢ƒãªã©)ã§EKS AutoModeã¯ä½¿ã„ã‚„ã™ã„ã¨æ„Ÿã˜ã‚‹ä¸€æ–¹ã§ã€å¤§è¦æ¨¡ãªç’°å¢ƒ(æœ¬ç•ªç’°å¢ƒãªã©)ã§EKS AutoModeã¯ã‚³ã‚¹ãƒˆé¢ã‹ã‚‰èª¬å¾—åŠ›ã¯æŒã¡ã«ããã†ã§ã™ã€‚é–‹ç™ºã§EKS AutoModeã€æœ¬ç•ªã§EKS AutoModeã¨ã—ã¦ã‚‚ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ã‚„å®šç¾©ã®ç®¡ç†ã‹ã‚‰ã™ã‚‹ã¨å…±é€šåŒ–ã§ããšå¬‰ã—ããªã„ã®ã‚‚ãƒšã‚¤ãƒ³ãƒã‚¤ãƒ³ãƒˆã§ã™ã€‚

EKS AutoModeã®ã‚³ã‚¹ãƒˆã•ãˆèª¬å¾—åŠ›ã‚’æŒãŸã›ã‚‰ã‚Œã‚Œã°ã„ã„ã®ã§ã™ãŒã€ç¾æ™‚ç‚¹ã§å¤§è¦æ¨¡ç’°å¢ƒã§EKS AutoModeã‚’æ¡ç”¨ã™ã‚‹å‹•æ©Ÿä»˜ã‘ã¯é›£ã—ã„ã¨æ„Ÿã˜ã¾ã™ã€‚

## EKS AutoModeãŒå®Ÿç¾ã—ã¦ã„ã‚‹ã“ã¨

EKSãŒãƒãƒãƒ¼ã‚¸ãƒ‰ã¨ã„ã£ã¦ã‚‚ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒ—ãƒ¬ãƒ¼ãƒ³ãƒ»AWS-Kubernetesã‚¢ã‚¯ã‚»ã‚¹ç®¡ç†ãƒ»ãƒ­ã‚°å›ã‚Šã ã‘ã˜ã‚ƒãªã„ã‹ã¨ã„ã†æ„Ÿã˜ã‹ã‚‰ã™ã‚‹ã¨ã€AutoModeã¯ã‚ˆã‚ŠAWSçµ±åˆã‚’å¼·ã‚ã¦ã„ã¾ã™ã€‚å¿…é ˆEKS AddonãŒè€ƒæ…®ä¸è¦ã«ãªã‚Šã¾ã—ãŸã€‚ã¾ãŸã€Nodeæ°´å¹³ã‚¹ã‚±ãƒ¼ãƒ«ã‚¢ã‚¦ãƒˆã‚‚çµ„ã¿è¾¼ã¿Karpenterã«ä»»ã›ã‚‹ã“ã¨ãŒã§ãã€AMIç®¡ç†ã‚„EC2ã®è‡ªå‹•æ›´æ–°ã‚‚ä»»ã›ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ALB/NLBã¨ã®çµ±åˆã‚‚ä»»ã›ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

## EKS AutoModeã®ãƒšã‚¤ãƒ³ãƒã‚¤ãƒ³ãƒˆ

EC2ä¸€å°ã‚ãŸã‚Šã®ã‚³ã‚¹ãƒˆã¯+11-12%ç¢ºå®šã§ä¸ŠãŒã‚Šã¾ã™ã€‚ALBã®å®‰å®šä¿æŒã®ãŸã‚IaCã§ALBã‚’ä½œã£ã¦ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã¨TargetGroupBindingã§ã¤ãªãå®‰å…¨ç­–ãŒå–ã‚Œã¾ã›ã‚“ã€‚EC2ã¯æœ€å¤§21æ—¥å¯¿å‘½ã§å…¥ã‚Œæ›¿ãˆã‚¿ã‚¤ãƒŸãƒ³ã‚°ã¯åˆ¶å¾¡å›°é›£ã§ã™ã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼è‡ªèº«ãŒExternalDNSã‚„ExternalSecretsã®ã‚ˆã†ãªå„ç¨®ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ã‚’Helmã§å°å…¥ã—ã¦ã„ã‚‹å ´åˆã€Helmæ›´æ–°æ™‚ã®æ‰‹é–“ã¯è»½æ¸›ã—ã¦ã„ã¾ã›ã‚“ã€‚Podã‚¹ã‚±ãƒ¼ãƒ«ã‚¢ã‚¦ãƒˆã¯PDBã—ã‹æŒã£ã¦ã„ãªã„ãŸã‚ã€æ™‚é–“ã‚¹ã‚±ãƒ¼ãƒ«ã‚„0 replicasãªã©ãŒå¿…è¦ãªã‚‰KEDAã‚’å…¥ã‚Œã–ã‚‹ã‚’å¾—ã¾ã›ã‚“ã€‚

## EKS AutoModeã®æ¡ç”¨åŸºæº–

Kubernetesã¨AWSçµ±åˆéƒ¨åˆ†ãŒæ¥½ã«ãªã£ãŸä¸€æ–¹ã§ã‚³ã‚¹ãƒˆãŒä¸ŠãŒã‚‹ãŸã‚ã€å¤§é‡ã®EC2ãŒå¿…è¦ãªãƒ¯ãƒ¼ã‚¯ãƒ­ãƒ¼ãƒ‰ã§ã¯ã‚³ã‚¹ãƒˆå¢—åŠ ãŒå—ã‘å…¥ã‚Œã‚‰ã‚Œã‚‹ã‹ã¯ã‚«ã‚®ã«ãªã‚‹ã§ã—ã‚‡ã†ã€‚ã¾ãŸã€å¾“æ¥Karpenterã‚„AWS LoadBalancer Controller(ALBC)ã‚’ã¯ã˜ã‚ã¨ã—ã¦è¤‡æ•°Helmã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ã‚’åˆ©ç”¨ã—ã¦ã„ãŸãƒãƒ¼ãƒ ã«ã¨ã£ã¦ã¯ã€Karpenter/ALBCã®ç®¡ç†ãŒä¸è¦ã«ãªã£ã¦ã‚‚ä»–ã®Helmç®¡ç†ã¯æ®‹ã‚‹ãŸã‚æ¥½ã«ãªã£ãŸã¨ã¯æ„Ÿã˜ã‚‰ã‚Œãªã„[^5]ã®ãŒæ­£ç›´ãªã¨ã“ã‚ã§ã™ã€‚

AWSã‚³ãƒ³ãƒ†ãƒŠç³»ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã§è¦‹ãŸã¨ãã«ã€ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ãƒãƒ¼ã‚¸ãƒ§ãƒ³å«ã‚ãŸç®¡ç†ã®æ¥½ã•ã§`ECS Fargate > ECS EC2 >> EKS AutoMode > EKS`ã€ã‚³ã‚¹ãƒˆé¢ã§`ECS EC2 > EKS > EKS AutoScale > ECS Fargate`[^6]ã¨ã„ã†æ„Ÿè§¦ã§ã™ã€‚

```mermaid
[ãƒ•ãƒ­ãƒ¼ç”¨æ„ã—ãŸã„]
```


# EKS AutoModeã‚’è¦‹ã‚‹

EKS AutoModeãŒå¾“æ¥ã¨æ±ºå®šçš„ã«é•ã†ã®ã¯æ¬¡ã®ãƒã‚¤ãƒ³ãƒˆã§ã™ã€‚

1. çµ„ã¿è¾¼ã¿ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãŒã‚ã‚‹
2. çµ„ã¿è¾¼ã¿NodeGroupãŒã‚ã‚‹
3. çµ„ã¿è¾¼ã¿Karpenterã§å‹•ä½œã•ã›ã‚‹EC2ã¯è¿½åŠ æ–™é‡‘ãŒã‹ã‹ã‚‹
4. æ±‚ã‚ã‚‰ã‚Œã‚‹IAMãƒãƒªã‚·ãƒ¼ãŒç•°ãªã‚‹
5. EKS Nodeã®æœ€å¤§Podæ•°ãŒ110ã«åˆ¶é™ã•ã‚Œã¦ã„ã‚‹
6. Pod SecurityGroupãŒéã‚µãƒãƒ¼ãƒˆ[^10]
7. ã‚«ã‚¹ã‚¿ãƒ ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚­ãƒ³ã‚°ãŒéã‚µãƒãƒ¼ãƒˆ[^10]

ä¸€æ–¹ã§ã€é€šå¸¸ãƒ¢ãƒ¼ãƒ‰ã¨AutoModeã§å…±é€šã—ã¦ã„ã‚‹ã®ã¯æ¬¡ã®ãƒã‚¤ãƒ³ãƒˆã§ã™ã€‚

* EKSã®èªè¨¼æ–¹æ³•ã¯å¤‰ã‚ã‚‰ãªã„
* KEDAã®ã‚ˆã†ãªPodã‚ªãƒ¼ãƒˆã‚¹ã‚±ãƒ¼ãƒ«ã¯çµ„ã¿è¾¼ã¾ã‚Œã¦ã„ãªã„

é †ç•ªã«è¦‹ã¦ã„ãã¾ã—ã‚‡ã†ã€‚

## çµ„ã¿è¾¼ã¿ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãŒã‚ã‚‹

EKS AutoModeã¯

https://docs.aws.amazon.com/eks/latest/userguide/auto-upgrade.html

* KarpenterãŒçµ„ã¿è¾¼ã¿ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ãŠã‚Šã€Karpenterã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ã¯éš è”½ã•ã‚Œã¦ã„ã‚‹
* AWS LoadBalancer ControllerãŒçµ„ã¿è¾¼ã¿ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ãŠã‚Šã€ALB Ingress Controllerã¯éš è”½ã•ã‚Œã¦ã„ã‚‹
* AWS EBS CSI DriverãŒçµ„ã¿è¾¼ã¿ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã‚‹
* å¿…é ˆEKS Addonã ã£ãŸkube-proxy/CoreDNS/Amazon VPC CNIãŒçµ„ã¿è¾¼ã¿ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã€Podã¯éš è”½ã•ã‚Œã¦ã„ã‚‹
* EKS Pod Identity AgentãŒå„ãƒãƒ¼ãƒ‰ã§ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã‚‹

## çµ„ã¿è¾¼ã¿ãƒãƒ¼ãƒ‰ã‚°ãƒ«ãƒ¼ãƒ—ãŒã‚ã‚‹

EKS AutoModeã¯`system`ã¨`general-purpose`ã¨ã„ã†çµ„ã¿è¾¼ã¿NodeGroupãŒã‚ã‚Šã¾ã™ã€‚å¾“æ¥ã®NodeGroupã¨ã¯ç•°ãªã‚Šåå‰ãŒæ±ºã‚ã‚‰ã‚Œã¦ãŠã‚Šã€ä½¿ã†ã‹ã©ã†ã‹ã¯ä»»æ„ã§ã™ã€‚

1. çµ„ã¿è¾¼ã¿ãƒãƒ¼ãƒ‰ã‚°ãƒ«ãƒ¼ãƒ—ã¯Karpenterã§å‹•ä½œã™ã‚‹
2. çµ„ã¿è¾¼ã¿ãƒãƒ¼ãƒ‰ã‚°ãƒ«ãƒ¼ãƒ—ã®Karpenterå®šç¾©ã¯å¤‰æ›´ã§ããªã„

## çµ„ã¿è¾¼ã¿Karpenterã§å‹•ä½œã•ã›ã‚‹EC2ã¯è¿½åŠ æ–™é‡‘ãŒã‹ã‹ã‚‹

EKS AutoModeãŒç®¡ç†ã™ã‚‹Nodeã«å¯¾ã—ã¦è¿½åŠ æ–™é‡‘ãŒã‹ã‹ã‚Šã¾ã™ã€‚ä¸€æ–¹ã§Managed Node Groupåˆ†ã«ã¯è¿½åŠ æ–™é‡‘ãŒã‹ã‹ã‚‰ãªã„ã‚ˆã†ã§ã™ã€‚

> Amazon EKS Auto Mode ã®æ–™é‡‘ã¯ã€EKS Auto Mode ã«ã‚ˆã£ã¦èµ·å‹•ãŠã‚ˆã³ç®¡ç†ã•ã‚Œã‚‹ Amazon EC2 ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®æœŸé–“ã¨ã‚¿ã‚¤ãƒ—ã«åŸºã¥ã„ã¦ãŠæ”¯æ‰•ã„ã„ãŸã ãã¾ã™ã€‚ä»¥ä¸‹ã® Amazon EKS Auto Mode ã®æ–™é‡‘ã¯ã€EC2 ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹è‡ªä½“ã‚’å¯¾è±¡ã¨ã™ã‚‹ Amazon EC2 ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹æ–™é‡‘ã«åŠ ãˆã¦è«‹æ±‚ã•ã‚Œã¾ã™ã€‚EC2 ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹æ–™é‡‘ã¨åŒæ§˜ã«ã€EKS Auto Mode ã®æ–™é‡‘ã¯ 1 ç§’å˜ä½ã§èª²é‡‘ã•ã‚Œã€1 åˆ†é–“åˆ†ã®æœ€ä½æ–™é‡‘ãŒã‹ã‹ã‚Šã¾ã™ã€‚ã‚ªãƒ³ãƒ‡ãƒãƒ³ãƒ‰ã€1 å¹´ãŠã‚ˆã³ 3 å¹´ã®ãƒªã‚¶ãƒ¼ãƒ–ãƒ‰ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã€Compute Savings Plansã€ã‚¹ãƒãƒƒãƒˆã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãªã©ã€EKS Auto Mode ã§ã¯ Amazon EC2 ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹è³¼å…¥ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ã™ã¹ã¦åˆ©ç”¨ã§ãã¾ã™ãŒã€EKS Auto Mode ã®æ–™é‡‘ã¯ EC2 ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹è³¼å…¥ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã¨ã¯ç„¡é–¢ä¿‚ã§ã™ã€‚
>
> å¼•ç”¨: https://aws.amazon.com/jp/eks/pricing/

ã¾ã¨ã‚ã‚‹ã¨æ¬¡ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚EKS AutoModeç®¡ç†ã®NodeClassã‚’ä½¿ã†ã¨ã‚«ã‚¦ãƒ³ãƒˆã•ã‚Œã‚‹ã‚ˆã†ãªã®ã§ã€é€ƒã’é“ãŒäº‹å®Ÿä¸Šãªãã¦å³ã—ã„ã‚‚ã®ã‚’æ„Ÿã˜ã¾ã™ã€‚

| èµ·å‹•ã‚¿ã‚¤ãƒ— | è¿½åŠ ã‚³ã‚¹ãƒˆãŒå¿…è¦ |
| --- | --- |
| EKS AutoModeã®Built-in node poolsã§èµ·å‹•ã—ãŸEC2 | å¿…è¦ |
| EKS AutoModeã§è‡ªå‰Node Classã¨NodePoolã§èµ·å‹•ã—ãŸEC2 | å¿…è¦ |
| EKS AutoModeã®Managed Node Groupã§èµ·å‹•ã—ãŸEC2 | ä¸è¦ |
| EKS AutoModeã«OSS Karpenterã‚’å…¥ã‚Œã¦EC2NodeClassã¨NodePoolã§èµ·å‹•ã—ãŸEC2 | ä¸è¦ |

è¿½åŠ åˆ†ã®ã‚³ã‚¹ãƒˆã¯Cost Explorer > API operationã§EKSAutoUsageã¨ã—ã¦è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚(Serviceåˆ†é¡ã¯`Elastic Container Service for Kubernetes`)

è¿½åŠ æ–™é‡‘ã‚’è©¦ç®—ã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚ä¾‹ãˆã°EKS AutoModeã®Built-in node pools`system`ãŒæœ‰åŠ¹ãªçŠ¶æ…‹ã§ã€EKS Addonã®`Metrics Server`ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹ã¨`c6g.large`ãŒ2å°[^11]èµ·å‹•ã—ã¾ã™ã€‚ap-northeast-1ã§èµ·å‹•ã—ãŸå ´åˆã€EKS AutoModeã§èµ·å‹•ã—ãŸ`c6g.large`ã®ã‚³ã‚¹ãƒˆã¯`$0.0856 (EC2ã‚ªãƒ³ãƒ‡ãƒãƒ³ãƒ‰æ–™é‡‘) + $0.01027 (EKS AutoModeè¿½åŠ åˆ†) = $0.09587/h`ã¨å…ƒã®ä¾¡æ ¼ã‹ã‚‰è¦‹ã¦119.9ï¼…ã§ã™ã€‚
AWSã®ä¾‹ç¤ºã™ã‚‹æ–™é‡‘ä¾‹ã‚’è¦‹ã¦ã‚‚ã€ãŠãŠã‚€ã­+11-12ï¼…ç¨‹åº¦ã®è¿½åŠ EC2æ–™é‡‘ã«ãªã‚‹ã¨è¦‹è¾¼ã‚€ã“ã¨ã«ãªã‚Šãã†ã§ã™ã€‚

![image](https://github.com/user-attachments/assets/12718e9d-d206-497a-81ce-150c9cd0f113)

![image](https://github.com/user-attachments/assets/6de4f6f6-9bd0-4942-aec1-505a776b3065)

EKS AutoModeãŒç®¡ç†ã™ã‚‹ã‹ã©ã†ã‹ã¯ã€EC2ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãªã‚‰`Managed`ã«TrueãŒã¤ã„ã¦ã„ã‚‹ã‹ã€Nodeãªã‚‰`eks.amazonaws.com/compute-type: auto`ãƒ©ãƒ™ãƒ«ãŒã‚ã‚‹ã‹ã§åˆ¤åˆ¥ã§ãã¾ã™ã€‚

![image](https://github.com/user-attachments/assets/2193595c-021a-4d4b-8dac-fb90c9e44e1e)

Nodeã«ãƒ©ãƒ™ãƒ«ãŒã‚ã‚‹ã®ã§ã€nodeSelectorã‚„tains/tolerationsã§åˆ¶å¾¡ã¯ã§ãã¾ã™ã­ã€‚

```yaml
nodeSelectcor:
  eks.amazonaws.com/compute-type: auto
```

**çµ„ã¿è¾¼ã¿ãƒãƒ¼ãƒ‰ã‚°ãƒ«ãƒ¼ãƒ—ã®Karpenterå®šç¾©ã¯å¤‰æ›´ã§ããªã„**

ãã‚Œãã‚Œã®NodeGroupã¯ç•°ãªã‚‹Karpenterå®šç¾©ã«ãªã£ã¦ã„ã¾ã™ã€‚

**Auto ModeãŒç®¡ç†ã™ã‚‹EC2ã¯æ¶ˆã›ãªã„**

Terminate Instanceã—ã‚ˆã†ã¨ã—ã¦ã‚‚å®Ÿè¡Œå¤±æ•—ã—ã¾ã™ã€‚

![image](https://github.com/user-attachments/assets/14108830-2a86-4a87-9f8b-5aacac986a66)

> Failed to terminate (delete) an instance: You are not authorized to perform this operation. User: arn:aws:sts::1234567801234:assumed-role/foo-role/bar is not authorized to perform: ec2:TerminateInstances on resource: arn:aws:ec2:ap-northeast-1:1234567801234:instance/i-04df53f6f7a5bc3d0 with an explicit deny in a resource-based policy. Encoded authorization failure message: ppuIku-çœç•¥...


## æ±‚ã‚ã‚‰ã‚Œã‚‹IAMãƒãƒªã‚·ãƒ¼ãŒç•°ãªã‚‹

æ¨™æº–EKSã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼æ§‹ç¯‰æ™‚ã¯ã€EKS Clusterç”¨IAMãƒ­ãƒ¼ãƒ«ã€EKS Nodeç”¨IAMãƒ­ãƒ¼ãƒ«ãŒæ±‚ã‚ã‚‰ã‚Œã¾ã™ã€‚



### çµ„ã¿è¾¼ã¿Karpenterã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼

ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚­ãƒ¼ã®ã„ãã¤ã‹ã¯ã€Karpenterã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‹ã‚‰å¤‰ã‚ã£ã¦ã„ã¾ã™ã€‚
https://docs.aws.amazon.com/eks/latest/userguide/create-node-pool.html

çµ„ã¿è¾¼ã¿ã®NodeClass `default`

```sh
$ kubetl get nodeclass default -o yaml | kubetl neat
apiVersion: eks.amazonaws.com/v1
kind: NodeClass
metadata:
  annotations:
    eks.amazonaws.com/nodeclass-hash: "3399735243323253970"
    eks.amazonaws.com/nodeclass-hash-version: v1
  labels:
    app.kubernetes.io/managed-by: eks
  name: default
spec:
  ephemeralStorage:
    iops: 3000
    size: 80Gi
    throughput: 125
  networkPolicy: DefaultAllow
  networkPolicyEventLogs: Disabled
  role: automode-eks-AmazonEKSAutoNodeRole
  securityGroupSelectorTerms:
  - id: sg-1234567890
  snatPolicy: Random
  subnetSelectorTerms:
  - id: subnet-1234567890123
  - id: subnet-1234567890234
```

çµ„ã¿è¾¼ã¿ã®NodePool `system`

```sh
$ kubectl get nodepool system -o yaml | kubectl neat
apiVersion: karpenter.sh/v1
kind: NodePool
metadata:
  annotations:
    karpenter.sh/nodepool-hash: "4982684901400657622"
    karpenter.sh/nodepool-hash-version: v3
  labels:
    app.kubernetes.io/managed-by: eks
  name: system
spec:
  disruption:
    budgets:
    - nodes: 10%
    consolidateAfter: 30s
    consolidationPolicy: WhenEmptyOrUnderutilized
  template:
    spec:
      expireAfter: 336h
      nodeClassRef:
        group: eks.amazonaws.com
        kind: NodeClass
        name: default
      requirements:
      - key: karpenter.sh/capacity-type
        operator: In
        values:
        - on-demand
      - key: eks.amazonaws.com/instance-category
        operator: In
        values:
        - c
        - m
        - r
      - key: eks.amazonaws.com/instance-generation
        operator: Gt
        values:
        - "4"
      - key: kubernetes.io/arch
        operator: In
        values:
        - amd64
        - arm64
      - key: kubernetes.io/os
        operator: In
        values:
        - linux
      taints:
      - effect: NoSchedule
        key: CriticalAddonsOnly
      terminationGracePeriod: 24h0m0s
```

çµ„ã¿è¾¼ã¿ã®NodePool `general-purpose`

```sh
$ kubectl get nodepool general-purpose -o yaml | kubectl neat
apiVersion: karpenter.sh/v1
kind: NodePool
metadata:
  annotations:
    karpenter.sh/nodepool-hash: "4012513481623584108"
    karpenter.sh/nodepool-hash-version: v3
  labels:
    app.kubernetes.io/managed-by: eks
  name: general-purpose
spec:
  disruption:
    budgets:
    - nodes: 10%
    consolidateAfter: 30s
    consolidationPolicy: WhenEmptyOrUnderutilized
  template:
    spec:
      expireAfter: 336h
      nodeClassRef:
        group: eks.amazonaws.com
        kind: NodeClass
        name: default
      requirements:
      - key: karpenter.sh/capacity-type
        operator: In
        values:
        - on-demand
      - key: eks.amazonaws.com/instance-category
        operator: In
        values:
        - c
        - m
        - r
      - key: eks.amazonaws.com/instance-generation
        operator: Gt
        values:
        - "4"
      - key: kubernetes.io/arch
        operator: In
        values:
        - amd64
      - key: kubernetes.io/os
        operator: In
        values:
        - linux
      terminationGracePeriod: 24h0m0s
```

### çµ„ã¿è¾¼ã¿AWS LoadBalancer Controller

https://docs.aws.amazon.com/eks/latest/userguide/auto-networking.html

networking.ingress.ipBlockä»•æ§˜å†…ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã¯TargetGroupBindingã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚

### çµ„ã¿è¾¼ã¿AWS EBS CSI Driver


## EKS Nodeã®æœ€å¤§Podæ•°ã¯110å°åˆ¶é™

ãƒãƒ¼ãƒ‰ãƒªãƒŸãƒƒãƒˆãªåˆ¶é™ã«ãªã£ã¦ã„ã¾ã™ã€‚

https://docs.aws.amazon.com/eks/latest/userguide/choosing-instance-type.html

##

EKS Auto Modeã®NodeClassãƒªã‚½ãƒ¼ã‚¹`default`ã‚’åˆ©ç”¨ã™ã‚‹ã„ãã¤ã‹ã®åˆ¶ç´„ãŒã§ã¾ã™ã€‚ç‰¹ã«ã“ã®è¾ºã‚Šã¯æ³¨æ„ã§ã™ã€‚

* Pod SecurityGroupã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ãªã„
* ã‚«ã‚¹ã‚¿ãƒ ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚­ãƒ³ã‚°ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ãªã„
* conntrackã®ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º(ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ300ç§’)

EKS Auto Modeã®ãƒãƒƒãƒ‰ã¨ãƒãƒ¼ãƒ‰ã®IPã‚¢ãƒ‰ãƒ¬ã‚¹ã¯ã€ŒåŒã˜CIDRãƒ–ãƒ­ãƒƒã‚¯ã‹ã‚‰ã®ã‚‚ã®ã€ã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚[ã‚«ã‚¹ã‚¿ãƒ ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚­ãƒ³ã‚°](https://docs.aws.amazon.com/ja_jp/eks/latest/userguide/cni-custom-network.html)ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ãªã„ã¨ã„ã†ã“ã¨ã¯ã€é‹ç”¨ä¸­ã«VPCã¸è¿½åŠ CIDRã‚’è¨­å®šã€ã‚µãƒ–ãƒãƒƒãƒˆã‚’åˆ‡ã£ã¦Podã‚’èµ·å‹•ã•ã›ã‚‹ã¨ã„ã†ã“ã¨ãŒã§ãã¾ã›ã‚“ã€‚ã‚«ã‚¹ã‚¿ãƒ ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚­ãƒ³ã‚°ã¯IPv4ã§ã—ã‹ã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ãªã‹ã£ãŸæ©Ÿèƒ½ã¨ã¯ã„ãˆã€ã¡ã‚‡ã£ã¨å›°ã‚Šã¾ã™ã­ã€‚

**ãƒ¯ãƒ¼ã‚¯ã‚¢ãƒ©ã‚¦ãƒ³ãƒ‰**

ã‚«ã‚¹ã‚¿ãƒ ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚­ãƒ³ã‚°ãŒåˆ©ç”¨ã§ããªã„åˆ¶ç´„ã¯ã€EKS Auto Modeã®NodeClassãŒEKSã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã¨åŒã˜SubnetIdã‚’å›ºå®šå‚ç…§ã—ã¦ã„ã‚‹ã“ã¨ã«èµ·å› ã—ã¦ã„ã¾ã™ã€‚
ã“ã®ãŸã‚ã€ã‚«ã‚¹ã‚¿ãƒ ã§EC2NodeClassã‚’ä½œæˆã—ã¦`ã‚¿ã‚°ã§ã‚µãƒ–ãƒãƒƒãƒˆã‚’æ¢ç´¢`ã•ã›ã‚Œã°ã“ã®åˆ¶ç´„ã¯å›é¿ã§ãã¾ã™ã€‚



# EKS AutoModeã®å‹•ä½œã‚’è©¦ã™

## ã‚«ã‚¹ã‚¿ãƒ NodeClassã¨NodePoolã‚’å±•é–‹ã™ã‚‹


EBSã‚µã‚¤ã‚ºãŒ20GiBã«ãªã£ã¦ã„ã¾ã™ã­ã€‚

![image](https://github.com/user-attachments/assets/7f300de6-e32f-4f6e-b473-26fa91db131e)


## NodeClassã®æ³¨æ„

**spec.roleã¯64æ–‡å­—æœªæº€ã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚‹**

spec.roleã®IAM Roleåã¯64æ–‡å­—æœªæº€ã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

```sh
$ kubectl apply -f ./k8s/test/automode_nodepool.yaml
The NodeClass "custom-class" is invalid:
* spec.role: Too long: may not be more than 64 bytes
* <nil>: Invalid value: "null": some validation rules were not checked because the object was invalid; correct the existing errors to complete validation
```

[ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://docs.aws.amazon.com/eks/latest/userguide/create-node-class.html)ãŒIAM Role ARNã«ãªã£ã¦ã„ã‚‹ã®ã§ã³ã£ãã‚Šã—ã¾ã™ãŒã€å®Ÿéš›ã¯åå‰ãªã®ã§ã‚»ãƒ¼ãƒ•ã§ã™ã€‚

```yaml
spec:
  # Ã—: ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¯IAM Role ARNè¡¨è¨˜ã«ãªã£ã¦ã„ã‚‹
  role: arn:aws:iam::123456789012:role/MyNodeRole
  # ã€‡: å®Ÿéš›ã¯IAM Role NAmeã§OKã€‚OSS Karpenterã¨åŒã˜
  role: MyNodeRole
```

**è¿½åŠ ã‚¿ã‚°ã‚’è¨­å®šã™ã‚‹ã«ã¯è¿½åŠ æ¨©é™ãŒå¿…è¦**

NodeClaimãŒå±•é–‹å‡ºæ¥ãšdescribeã™ã‚‹ã¨æ¬¡ã®è¡¨ç¤ºã«ãªã£ã¦ã„ã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚

```sh
$ kubectl describe nodeclaim xxxxx

Status:
  Conditions:
    Last Transition Time:  2025-03-12T09:48:38Z
    Message:               object is awaiting reconciliation
    Observed Generation:   1
    Reason:                AwaitingReconciliation
    Status:                Unknown
    Type:                  Initialized
    Last Transition Time:  2025-03-12T09:48:38Z
    Message:               Error getting launch template configs: User is not authorized to perform this operation because no identity-based policy allows it
    Observed Generation:   1
    Reason:                Unauthorized
    Status:                Unknown
    Type:                  Launched
    Last Transition Time:  2025-03-12T09:48:38Z
    Message:               Node not registered with cluster
    Observed Generation:   1
    Reason:                NodeNotFound
    Status:                Unknown
    Type:                  Registered
    Last Transition Time:  2025-03-12T09:48:38Z
    Message:               Initialized=Unknown, Launched=Unknown, Registered=Unknown
    Observed Generation:   1
    Reason:                ReconcilingDependents
    Status:                Unknown
    Type:                  Ready
Events:                    <none>
```

åŸå› ã¯ã€NodeClassã§è¿½åŠ ã‚¿ã‚°ã‚’è¨­å®šã—ã¦ã„ã‚‹ã“ã¨ã§ã™ã€‚ã“ã®å ´åˆã€[è¿½åŠ æ¨©é™](https://docs.aws.amazon.com/eks/latest/userguide/auto-learn-iam.html#tag-prop)ãŒEKS AutoModeã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã®IAM Roleã«å¿…è¦ã§ã™ã€‚

```yaml
apiVersion: eks.amazonaws.com/v1
kind: NodeClass
metadata:
  name: foo
spec:
  # çœç•¥
  tags:
    environment: custom
```

è¨­å®šã™ã‚Œã°ç„¡äº‹ã«NodeClaimãŒå±•é–‹ã•ã‚Œã¦ã€EC2ãŒèµ·å‹•ã€PodãŒã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã•ã‚Œã¾ã™ã€‚

## NodePoolã®æ³¨æ„

**expireAfterã«Neverã¯è¨­å®šã§ããªã„**

spec.template.spec.expireAfterã«Neverã‚’è¨­å®šã™ã‚‹ã¨ã‚¨ãƒ©ãƒ¼ã«ãªã‚Šã¾ã™ã€‚

```sh
$ kubectl apply -f ./k8s/test/automode_nodepool.yaml
Error from server (Invalid): error when creating "./k8s/test/automode_nodepool.yaml": NodePool.karpenter.sh "custom-pool" is invalid: [spec.template.spec: Invalid value: "object": type conversion error from 'string' to 'google.protobuf.Duration' evaluating rule: the sum of expireAfter and terminationGracePeriod may not exceed 21 days, spec.template.spec: Invalid value: "object": expireAfter may not be set to Never]
```


## è¿½åŠ EKS Addonã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹

è¿½åŠ EKS Addonã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹ã¨ã€çµ„ã¿è¾¼ã¿NodeGroupã®`system`ãŒåˆ©ç”¨ã•ã‚Œã¾ã™ã€‚

# å‚è€ƒ

* [Amazon EKS Auto Mode ã®ç™ºè¡¨ | AWS](https://aws.amazon.com/jp/about-aws/whats-new/2024/12/amazon-eks-auto-mode/)
* [EKS Auto Mode | Spearker Deck](https://speakerdeck.com/kashinoki38/eks-auto-mode)
* https://medium.com/@kazioyazi/nodeclaim-has-error-error-getting-launch-template-configs-in-eks-auto-mode-46edca067fba

[^1]: Karpenterã®EC2NodeClassã«ç›¸å½“ã—ã¾ã™ãŒã€EKS AutoModeã§ã¯è¨­å®šã§ãã‚‹ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«åˆ¶é™ãŒã‚ã‚Šã¾ã™
[^2]: ECSã‚‚Fargateã ã¨ãŠé«˜ããªã‚ŠãŒã¡ãªã®ã¨ä¼¼ã¦ã„ã¾ã™ãŒã€ECS EC2ã§ã¯è¿½åŠ ã‚³ã‚¹ãƒˆãªã„ã®ã§å‰²ã¨éå¯¾ç§°ã«ã‚‚æ€ã„ã¾ã™ã€‚
[^3]: è‡ªåˆ†ã§[LCUã‚’è¨­å®šã§ãã‚‹](https://docs.aws.amazon.com/elasticloadbalancing/latest/application/capacity-unit-reservation.html)ã‚ˆã†ã«ãªã£ã¦ã‚ˆã‹ã£ãŸã‚ˆã‹ã£ãŸã€‚
[^4]: Managed NodeGroupã‚’0å°ã«ã—ã¦ã€Karpenterã§èµ·å‹•ã—ãŸEC2ã‚’å¼·åˆ¶çš„ã«Terminateã™ã‚‹ã“ã¨ã§ç°¡å˜ã«å¤œé–“åœæ­¢ã‚’ç”¨æ„ã§ããŸã®ãŒä¸å¯èƒ½ã«ãªã£ãŸ
[^5]: ãã‚‚ãã‚‚Helmã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ã®æ›´æ–°ãŒã¤ã‚‰ã„ã®ã§0ã«ã—ãŸã„
[^6]: EKS with Fargateã¯ã‚³ã‚¹ãƒˆé¢ã§æœ€ã‚‚æ‚ªã„ã§ã™ãŒåŒè»¸ã«ã¯é©ã•ãªã„ã®ã§é™¤å¤–
[^10]: https://docs.aws.amazon.com/eks/latest/userguide/auto-networking.html
[^11]: 2å°èµ·å‹•ã™ã‚‹ã®ã¯ã€Metrics Serverã®podAntiAffinityã§`affinity.podAntiAffinity.preferredDuringSchedulingIgnoredDuringExecution`ã«ã¦`"topologyKey": "kubernetes.io/hostname"`ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹ãŸã‚åŒä¸€Nodeã§ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã•ã‚Œãªã„ãŸã‚



https://dev.classmethod.jp/articles/create-eks-auto-mode-cluster-by-terraform/
https://github.com/terraform-aws-modules/terraform-aws-eks/blob/master/main.tf
https://docs.aws.amazon.com/ja_jp/eks/latest/userguide/create-node-pool.html
https://docs.aws.amazon.com/ja_jp/eks/latest/userguide/automode-get-started-console.html


https://docs.aws.amazon.com/eks/latest/userguide/automode-learn-instances.html
https://aws.amazon.com/jp/ec2/instance-types/
https://docs.aws.amazon.com/eks/latest/userguide/auto-learn-iam.html#tag-prop
https://docs.aws.amazon.com/eks/latest/userguide/auto-networking.html
https://karpenter.sh/docs/concepts/nodeclasses/
https://docs.aws.amazon.com/eks/latest/userguide/automode-workload.html
https://docs.aws.amazon.com/eks/latest/userguide/choosing-instance-type.html
https://dev.classmethod.jp/articles/eks-auto-mode-custom-node-pool/
https://zenn.dev/fy0323/articles/4d64ebd5195cdd
https://speakerdeck.com/kashinoki38/eks-auto-mode?slide=47
https://karpenter.sh/docs/concepts/nodeclasses/
https://docs.aws.amazon.com/eks/latest/userguide/community-addons.html
https://github.com/aws/containers-roadmap/issues/2508
https://docs.aws.amazon.com/eks/latest/userguide/automode-learn-instances.html
