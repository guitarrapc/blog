---
Title: Azure Deployment Environmentのデプロイログがとれるようになった
Category:
- Azure
EditURL: https://blog.hatena.ne.jp/guitarrapc_tech/guitarrapc-tech.hatenablog.com/atom/entry/6802418398335467328
PreviewURL: https://tech.guitarrapc.com/draft/entry/sRu1HRyJSc-VmKYDkjx8Goo_-w8
CustomPath: 2025/03/07/235900
Draft: true
---

Azure Deployment Environmentの最大の難点が、BicepやPulumi、Terraformで環境構築中にエラーが出たときに、エラーログを確認できないことでした。
今回ついにデプロイログがとれるようになったのでメモです。

[:contents]

# Azure Deployment Environmentの問題点

Azure Deployment Environmentは、カスタムイメージで環境構築時にエラーが出ると環境はFailed状態になります。
ただ、従来はIaCの何が原因でエラーになったのか調べようとしても[カスタムイメージのデプロイメントエラー](https://learn.microsoft.com/en-us/azure/deployment-environments/troubleshoot-custom-image-logs-errors)手順で実行ログを確認出来たり、できなかったりしました。

ドキュメントはBicepで展開するときのエラーでエラーが表示されています。

![image](https://github.com/user-attachments/assets/57dcd3b0-096f-42c1-87d1-6e28420457dd)

しかしPulumiやTerraformでAzure Deployment Environmentの環境構築時にエラーが出ても、エラーメッセージが`'null'`と表示されて情報皆無が日常でした。

```
"message": "Operation failed with exit code UnknownError! Additional Error Details: ERROR: 'null' is not a valid ID. warning: A new version of Pulumi is available. To upgrade from version...."
```

これは`az`(Azure CLI)でも同様でした。

```sh
# Get list of operations on the environment, choose the latest operation
$ az devcenter dev environment list-operation --environment-name {YOUR_ENVIRONMENT_NAME} --project {YOUR_PROJECT_NAME}
# Using the latest operation ID, view the operation logs
$ az devcenter dev environment show-logs-by-operation --environment-name {YOUR_ENVIRONMENT_NAME} --project {YOUR_PROJECT_NAME} --operation-id {LATEST_OPERATION_ID}
```

ほしいのはデプロイの実行ログであってエラーログではないというのが問題の根幹にあります。

# デプロイログがとれるようになった

2025年2月になって、Azure Deployment Environmentのデプロイ失敗時に、開発者ポータルからデプロイログとしてPulumiやTerraformの実行ログ(標準出力)がとれるようになりました。開発者ポータルで`失敗した環境 > メニュー > デプロイ ログ`を選択するとデプロイの操作IDが出て、ダウンロードアイコンからログを確認できます。

![image](https://github.com/user-attachments/assets/22dfc433-715b-4a47-b369-0fca231c2c57)

![image](https://github.com/user-attachments/assets/b3f63504-7c15-4692-9738-2aab3a7382e8)

Pulumiで構築している場合、実行ログはPulumiの標準出力がそのまま出ます。最高です!例えば、次のような実行ログを取得できるので、Network Security Groupのルール数が制限を超えていることがわかります。

```
{"timestamp": "02/23/2025 14:24:03", "type": "verbose", "filename": "Deploy", "content": "Initializing runner"}
{"timestamp": "02/23/2025 14:24:06", "type": "verbose", "filename": "Deploy", "content": "Downloading environment state to /ade/storage"}
{"timestamp": "02/23/2025 14:24:07", "type": "verbose", "filename": "Deploy", "content": "Selecting catalog directory: /ade/repository/Environments/PulumiTemplates/this-is-test"}
{"timestamp": "02/23/2025 14:24:08", "type": "verbose", "filename": "Deploy", "content": "Executing script (/scripts/deploy.sh)"}
{"timestamp": "02/23/2025 14:24:09", "type": "log", "filename": "Deploy", "content": ""}
{"timestamp": "02/23/2025 14:24:09", "type": "log", "filename": "Deploy", "content": ">>> Pulumi/.NET/Node/Python Versions..."}
{"timestamp": "02/23/2025 14:24:09", "type": "log", "filename": "Deploy", "content": ""}
{"timestamp": "02/23/2025 14:24:09", "type": "log", "filename": "Deploy", "content": "v3.115.1"}
// ...省略
{"timestamp": "02/23/2025 14:24:15", "type": "log", "filename": "Deploy", "content": ">>> Initializing Pulumi Stack..."}
{"timestamp": "02/23/2025 14:24:15", "type": "log", "filename": "Deploy", "content": ""}
{"timestamp": "02/23/2025 14:24:15", "type": "log", "filename": "Deploy", "content": ""}
{"timestamp": "02/23/2025 14:24:15", "type": "log", "filename": "Deploy", "content": ">>> Setting Pulumi Configuration..."}
{"timestamp": "02/23/2025 14:24:15", "type": "log", "filename": "Deploy", "content": ""}
{"timestamp": "02/23/2025 14:24:16", "type": "log", "filename": "Deploy", "content": ""}
{"timestamp": "02/23/2025 14:24:16", "type": "log", "filename": "Deploy", "content": ">>> Restore dependencies..."}
{"timestamp": "02/23/2025 14:24:16", "type": "log", "filename": "Deploy", "content": ""}
{"timestamp": "02/23/2025 14:24:16", "type": "log", "filename": "Deploy", "content": ""}
{"timestamp": "02/23/2025 14:24:16", "type": "log", "filename": "Deploy", "content": ">>> Running Pulumi Up..."}
{"timestamp": "02/23/2025 14:24:16", "type": "log", "filename": "Deploy", "content": ""}
{"timestamp": "02/23/2025 14:24:16", "type": "log", "filename": "Deploy", "content": "Previewing update (foo):"}
// ... 省略
{"timestamp": "02/23/2025 14:24:49", "type": "log", "filename": "Deploy", "content": "    pulumi:pulumi:Stack this-is-test-foo running 'dotnet build -nologo .' completed successfully"}
{"timestamp": "02/23/2025 14:24:50", "type": "log", "filename": "Deploy", "content": "@ previewing update....."}
{"timestamp": "02/23/2025 14:24:51", "type": "log", "filename": "Deploy", "content": "    pulumi:pulumi:Stack this-is-test-foo  "}
{"timestamp": "02/23/2025 14:24:51", "type": "log", "filename": "Deploy", "content": "Resources:"}
{"timestamp": "02/23/2025 14:24:51", "type": "log", "filename": "Deploy", "content": "    + 21 to create"}
{"timestamp": "02/23/2025 14:24:51", "type": "log", "filename": "Deploy", "content": "    1 unchanged"}
// ... 省略
{"timestamp": "02/23/2025 14:25:00", "type": "log", "filename": "Deploy", "content": "Diagnostics:"}
{"timestamp": "02/23/2025 14:25:00", "type": "log", "filename": "Deploy", "content": "  azure-native:network:NetworkSecurityGroup (foo-nsg):"}
{"timestamp": "02/23/2025 14:25:00", "type": "log", "filename": "Deploy", "content": "    error: Status=400 Code=\"SecurityRuleAddressesOrPortsPerSecurityGroupLimitReached\" Message=\"Network security group /subscriptions/12345678-1234-1234-1234-123456781234/resourceGroups/this-is-test-foo/providers/Microsoft.Network/networkSecurityGroups/foo-sg has 4099 SourceAddressPrefixes. A security group cannot have more than 4000 SourceAddressPrefixes as per the limit MaxSecurityRuleAddressesOrPortsPerSecurityGroup.\""}
{"timestamp": "02/23/2025 14:25:00", "type": "log", "filename": "Deploy", "content": ""}
{"timestamp": "02/23/2025 14:25:00", "type": "log", "filename": "Deploy", "content": "  pulumi:pulumi:Stack (this-is-test-foo):"}
{"timestamp": "02/23/2025 14:25:00", "type": "log", "filename": "Deploy", "content": "    error: update failed"}
```

# まとめ

これでPulumiやTerraformを使ってAzure Deployment Environmentを使っているときに、エラー原因をエスパーしなくてよくなりました!エラーが一度おこると解消が本当に難しかったので、心からうれしいです!ほかにもAzure Deployment Environmentの不満はあるので、今後もよくなっていくといいですね。

なお、現時点でこのデプロイログはAzure CLIからは取得できないようです。Azure CLIから取得できるようになると、エラーが出たときにエラーを自動取得できるのでぜひほしいところです。また、Microsoft Learnのドキュメントに記載を見つけることができていないので、こちらも早くドキュメントに起こしてほしいですね。

# 参考

* [Troubleshooting Custom Image Deployment Errors - Azure Deployment Environments | Microsoft Learn](https://learn.microsoft.com/en-us/azure/deployment-environments/troubleshoot-custom-image-logs-errors)
* [Create and access an environment by using the Azure CLI - Azure Deployment Environments | Microsoft Learn](https://learn.microsoft.com/en-us/azure/deployment-environments/how-to-create-access-environments)
