---
Title: Unity Dream RouterでデュアルNATを回避する
Category:
- Ubiquiti
- Network
Date: 2025-03-30T23:59:00+09:00
EditURL: https://blog.hatena.ne.jp/guitarrapc_tech/guitarrapc-tech.hatenablog.com/atom/entry/6802418398345462352
PreviewURL: https://tech.guitarrapc.com/draft/entry/4PGeBG87CeQLfiQicGFS2UaReU8
CustomPath: 2025/03/30/235900
Draft: true
---

以前、MAP-E方式のIPv6を[UniFi Dream Router](https://tech.guitarrapc.com/entry/2022/12/02/080727)や[UniFi Dream Machine](https://tech.guitarrapc.com/entry/2020/10/17/044555)で利用する方法を紹介しましたが、いずれもホームゲートウェイ(HGW)と組み合わせる際にデュアルNATとなっていました。2024年7月リリースのファームウェア「Network Appklication 8.3」でUDR/UDMのNATを無効にできるようになったので、デュアルNATを回避する方法を試してみました。

果たして速度はよくなるのか、何かトラブルが起こらないんかUDRで見てみましょう。

[:contents]

# 環境

次の環境で行います。

* HGW: RX-600KI
* Router: UDR (UniFi Dream Router)
* UniFi OS: 4.1.22
* Network Application: 9.0.114
* IPv4 over IPv6: MAP-E

## 構成図

デュアルNATの構成は次のようになります。

<details><summary>Mermaidコード</summary>

```mermaid
flowchart TD
    subgraph IPv6 IPoE網
      G[事業者ルーター]
    end
    subgraph "ユーザーLAN(IPv4/IPv6)"
      A([光コンセント])
      B[HGW]
      subgraph "UDR LAN(IPv4/IPv6)"
        C[UDR]
        D[VLAN]
        E[VLAN]
      end
    end

    G -->|IPv4 over IPv6トンネル| A
    A --WAN (NAT)--> B
    B --WAN (NAT)--> C
    C -->|LAN| D
    C -->|LAN| E
```

</details>


![デュアルNATの構成](image.png)

UDRのNATを無効にした構成は次のようになります。

<details><summary>Mermaidコード</summary>

```mermaid
flowchart TD
    subgraph IPv6 IPoE網
      G[事業者ルーター]
    end
    subgraph "ユーザーLAN(IPv4/IPv6)"
      A([光コンセント])
      B[HGW]
      subgraph "UDR LAN(IPv4/IPv6)"
        C[UDR]
        D[VLAN]
        E[VLAN]
      end
    end

    G -->|IPv4 over IPv6トンネル| A
    A --WAN (NAT)--> B
    B --WAN (IPv4はLAN側静的ルーティング)--> C
    C -->|LAN| D
    C -->|LAN| E
```

</details>

![UDRのNATを無効にした構成](image-1.png)

# UDRのNATを無効にする

UDRのNATはネットワークごとに有効/無効を選択できます。そこで従来のネットワークとは別にNATを無効にするネットワーク(及びVLAN)を切り、専用のSSIDも作成します。これでWi-Fiを切り替えるだけで動作を検証できます。従来のWi-FiはデュアルNATのままなので、万が一トラブルがあっても元のWi-Fiにつながっている端末に影響出ません。

手順は次の通りです。

1. (UDR) NATを切るネットワーク`NoNAT`を用意する
2. (UDR) NATを切るネットワークにつなげるSSIDを用意する
3. (UDR) NATのNAT設定で除外ネットワークへ`NoNAT`を指定する
4. (HGW) NATを切るネットワークのCIDR/UDRのWAN側IPアドレスを静的ルーティングする

順番に見ていきましょう。

**(UDR) NATを切るネットワーク`NoNAT`を用意する**

UDRのWeb UIにアクセスし`Settings -> Networks`を開きます。いい感じでネットワークを切ってください。特にこだわるポイントはありません。CIDRは`192.168.13.0/24`とします。

![UDRでネットワークを切る](image-2.png)

**(UDR) NATを切るネットワークにつなげるSSIDを用意する**

作成したネットワークをさくっと試すならWi-Fiがベストです。私が宅内をWi-Fiで統一している理由の1つです。

`Settings -> WiFi`を開き、SSIDを作成します。SSIDは`NoNAT`とでもしておきましょう。

![UDRのWiFi設定](image-4.png)

**(UDR) NATのNAT設定で除外ネットワークへ`NoNAT`を指定する**

重要なポイント1です。

`Settings -> Routing -> NAT`を開き、Global NAT Settingsを`Auto`から`Custom`に変更、Exclude Networksに`NoNAT`を追加します。もしも全てのネットワークを除外したい場合は、Global NAT Settingsを`Off`にしてしまうのも手です。私も安定動作を確認したらOffにする予定です。

![UDRのNAT除外設定](image-4.png)

**(HGW) NATを切るネットワークのCIDR/UDRのWAN側IPアドレスを静的ルーティングする**

重要なポイント2です。

接続先がIPv6[^1]なら、HGWの静的ルーティング設定をせずとも通信できます。しかし接続先がIPv4な場合、上位のHGWでUDR配下の端末当て通信が正しく中継できません。[^2]NATを無効にしたため、インターネットからの戻り通信宛先がローカルPCアドレスのままになってしまうため、HGWがどこに転送すればいいか分からなくなるためです。そこでHGWの静的ルーティングにて、LAN側のネットワーク宛て通信はUDRのWAN側IPアドレスへ転送するよう設定します。

私のHGWはRX-600KIなので、HGWのWeb UIにアクセスし、`詳細設定 -> LAN側静的ルーティング設定`を開きます。宛先IPアドレス/マスク長にNoNATネットワークのCIDRを、次のホストIPアドレスにUDRのWAN側IPアドレスを指定します。

![HGWの静的ルーティング設定](image-5.png)

# 動作試験

これでUDRのNATを無効にしたネットワークができました。さっそく接続してみましょう。

NAT無効なSSIDに接続し、IPアドレスを確認します。意図通り、NAT無効なネットワーク`192.168.13.xxx`のアドレスが割り当てられています。

```sh
$ ipconfig
Wireless LAN adapter WiFi:

   Connection-specific DNS Suffix  . :
   IPv6 Address. . . . . . . . . . . : xxxx:xxxx:xxxx:xxxx::xxx
   IPv6 Address. . . . . . . . . . . : xxxx:xxxx:xxxx:xxxx:xxxx:xxxx:xxxx:xxxx
   Temporary IPv6 Address. . . . . . : xxxx:xxxx:xxxx:xxxx:xxxx:xxxx:xxx:xxxx
   Link-local IPv6 Address . . . . . : fe80::1ecf:2056:38cb:af3c%9
   IPv4 Address. . . . . . . . . . . : 192.168.13.184
   Subnet Mask . . . . . . . . . . . : 255.255.255.0
   Default Gateway . . . . . . . . . : fe80::6222:32ff:feaa:33d9%9
                                       192.168.13.1
```

## 速度チェック

有線接続の速度を確認します。

<details><summary>HGWからの有線LAN</summary>

参考値として、HGWから有線LANで接続したPCからfast.comで速度を測定します。理論上の最速接続です。

![HGW直接の有線LAN](image-8.png)

</details>


UDRのLANポートに接続したPCからfast.comで速度を測定します。

|デュアルNAT | シングルNAT (本記事の構成) |
| --- | --- |
| 450Mbps<br/>![デュアルNATの有線LAN](image-9.png) | 470Mvps<br/>![シングルATの有線LAN](image-10.png) |

無線接続の速度を確認します。UDRのWi-Fiに接続したPCからfast.comで速度を測定します。

| デュアルNAT | シングルNAT (本記事の構成) |
| --- | --- |
| 270Mbps<br/>![デュアルNATのWi-Fi速度](image-6.png) | 320Mvps<br/>![シングルNATのWi-Fi速度](image-7.png) |

なお、運ゲーなので、実行タイミングによってはWi-Fiでも有線ぐらいにはなります。

![Wi-Fi速度の上振れ](image-11.png)

# まとめ

速度差は微々たるもので計測誤差にも感じますが、デュアルNATを回避できるのが大きいです。ただ、構成自体はシンプルですがHGWに追加設定を必要としているのは微妙です。[^3]


# 参考

* [デュアルNATもこれで回避！ Ubiqiti製品の最新ファーム「UniFi Network Application 8.3」を試す【イニシャルB】 - INTERNET Watch](https://internet.watch.impress.co.jp/docs/column/shimizu/1610277.html)

[^1]: 例えばGoogleやXは問題なく接続できるのを確認できます。
[^2]: 行きは良いが、戻り通信を端末に戻せない。
[^3]: デュアルNATよりはましか
