---
Title: AWS CloudWatch Metric Streamを使ったDatadogメトリクス送信とPulumiやTerraformからのCloudFormation Stack呼び出し
Category:
- AWS
- C#
- Pulumi
EditURL: https://blog.hatena.ne.jp/guitarrapc_tech/guitarrapc-tech.hatenablog.com/atom/entry/6802418398331919687
PreviewURL: https://tech.guitarrapc.com/draft/entry/pbp1bcj-AICfN6lqntfZJHAMEj4
CustomPath: 2025/02/23/235900
---

DatadogはAWSのCloudWatchメトリクスの取り込みをPull方式とPush方式の両方サポートしています。いわゆるDatadog AWS IntegrationはPull方式でCloudWatchメトリクスを10分程度のレイテンシーで取り込みます。一方で、AWS CloudWatch Metric StreamはPush方式でCloudWatchメトリクスをDatadogに3-5分程度のレイテンシーで取り込みます。

今回は、Datadogが提供するCloudFormation StackをPulumiやTerraformから呼び出すメモです。

[:contents]

# CloudWatch Metric Streamを使ってDatadogにメトリクスを送信するとは

Datadogは[CloudWatch Metric Streamを使ったPush方式の記事](https://docs.datadoghq.com/ja/integrations/guide/aws-cloudwatch-metric-streams-with-kinesis-data-firehose/?tab=cloudformation)を出しているのでこれを見ると理解できます。記事の図でいうところの赤で囲んだ経路がPull方式、青で囲んだ経路がPush方式です。

![image](https://github.com/user-attachments/assets/ce3688ad-5fbd-4956-ad99-9d2dd0ae91fb)

Pull方式は、DatadogのAWSアカウントからクローラー方式でCloudWatch APIをたたく手法です。コストはCost Explorerで`CW:GMD-Metrics`[^1]として表示されます。IAM RoleでDatadog AWSアカウントを許可しつつ権限を渡せば勝手に取り込んでくれる手放し感が便利かつ、DatadogのAWS Integrationから取り込むサービスを絞り込むことができます。Datadog自体はAWS Integrationで追加されるメトリクスにコストがかからないのですが、取り込むサービスが多ければ多いほどAWS側のCloudWatchコストが増えます。

Push方式は、ユーザーがCloudWatch Metric StreamからFirehoseを経由してHTTP EndpointとしてDatadogにメトリクスを投げ込む手法です。コストはCost Explorerで`CW:MetricStreamUsage`、`Firehose:AWS-Out-Bytes`として表示されます。ユーザーが自分でサービスを設定しないといけないので、Datdogが公式にCloudFormation Stackを提供しています。Pull方式と違ってメトリクスの平均値だけでなく、「最小、最大、サンプル数、合計」も収集されるため、`CW:MetricStreamUsage`は`CW:GMD-Metrics`よりリクエスト料金は3/10ですが収集するメトリクスが増えてコストは1.5売程度になります。Pull方式同様全サービスを取り込むのではなく取り込むサービスを見極めたほうがいいです。

ザクっとまとめると以下のようになります。おおむね理解したところで、CloudWatch Metric Streamを使った仕組みを構築してみましょう。

| 項目 | Pull方式 | Push方式 |
| --- | --- | --- |
| ユーザーが設定するもの | IAM Role | CloudWatch Metric Stream<br/>Firehose<br/>IAM Role<br/>CloudWatch Logs<br/>S3 |
| 構築方法 | 公式がCloudFormation提供 | 公式がCloudFormation Stack提供 |
| AWSコストのUsageType | CloudWatch `GMD-Metrics` | CloudWatch `MetricStreamUsage`<br/> Firehose `AWS-Out-Bytes` |
| メトリクスの反映遅延 | 10-15min | 3-5min |

# CloudFormation Stackを使う

先に示した通り、Pull方式ではIAM RoleだけだったのにPush方式は関連するAWSサービスが多すぎです。このため、Datadogが提供するCloudFormation Stackを使って構築するのが簡単です。

先に示した[CloudWatch Metric Streamを使ったPush方式の記事](https://docs.datadoghq.com/ja/integrations/guide/aws-cloudwatch-metric-streams-with-kinesis-data-firehose/?tab=cloudformation)にCloudFormationで展開する方法が書かれています。

Datadog > Integration > AWS > 適当なアカウントを選択 > Metric Collectionの下部を見ると、[CloudFormation Stackのリンク](https://console.aws.amazon.com/cloudformation/home?region=us-east-1#/stacks/quickcreate?stackName=DatadogMetricStreams&templateURL=https://datadog-cloudformation-stream-template.s3.amazonaws.com/aws/streams_main.yaml&param_DdSite=datadoghq.com)があります。

![image](https://github.com/user-attachments/assets/7a257e30-2fdd-423a-9f1f-f853df0c8bde)

リンクをクリックするとCloudFormation Stackの作成画面が開くので`ApiKey`と`Regions`を入力すれば作成できます。

![image](https://github.com/user-attachments/assets/fed2c033-6a5b-46df-ac34-0362d46ddbab)

## IaCからCloudFormation Stackを呼び出す

CloudFormationはいいのですが、すでにPulumiやTerraformを使っている場合は「IaCじゃらCloudFormation Stackを呼び出す」とコード管理が一貫性を保てていいですね。これも簡単に書くことができ舞う。

PulumiからCloudFormation Stackを呼び出すには次のようにします。ここでは東京リージョン(ap-northeast-1)と米国東部リージョン(us-east-1)からメトリクスを送信する例です。割と素直ですね。

```cs
var config = new Config();
var datadogApiKey = config.RequireSecret("DatadogのAPIKey用のコンフィグキー");

var opt = new CustomResourceOptions();
_ = new Pulumi.Aws.CloudFormation.Stack($"datadog-metricstream-stack", new()
{
    Name = "DatadogMetricStreams"
    TemplateUrl = "https://datadog-cloudformation-stream-template.s3.amazonaws.com/aws/streams_main.yaml",
    Capabilities = ["CAPABILITY_NAMED_IAM"],
    // CloudFormationの定義に合わせて指定する
    Parameters = new InputMap<string>
    {
        { "ApiKey", datadogApiKey },
        { "DdSite", "datadoghq.com" }, // US1
        { "Regions", ["ap-northeast-1", "us-east-1"] },
    }
}, opt);
```

Terraformも同様に書けます。

```terraform
resource "aws_cloudformation_stack" "datadog_metricstream_stack" {
  name = "DatadogMetricStreams"
  template_url = "https://datadog-cloudformation-stream-template.s3.amazonaws.com/aws/streams_main.yaml"
  capabilities = ["CAPABILITY_NAMED_IAM"]
  parameters = {
    ApiKey = var.datadog_api_key
    DdSite = "datadoghq.com"
    Regions = ["ap-northeast-1", "us-east-1"]
  }
}
```

## IaCを使ったCloudFormation Stackの注意

この構成はシンプルですがおおむねほとんどのケースでは十分でしょう。ただし使っていて分かったCloudFormation Stackに起因する制約があります。

* エッジケースで引っかかるIAM Roleの権限不足
* テンプレートのメトリクスストリームのInclude/Excludeの設定上限が3つ

### エッジケースで引っかかるIAM Roleの権限不足

テンプレートから生成されるIAM Role `DatadogMetricStreamRole`に`logs:ListTagLogRoup`アクションがないため、リソースのタグ変更があったときに、CloudFormationのROLLBACKエラーが起こります。タグ回りで変更があったりすると引っかかり、テンプレートを書き換えるかスタックを作り直すしか回避策がないので注意です。

また、Issueでは`s3:PutBucketTagging`と`cloudwatch:TagResource`が足りないケースも[報告](https://github.com/DataDog/cloudformation-template/issues/125)されています。

CloudFormation Stackは[GitHubで公開](https://github.com/DataDog/cloudformation-template)されています。ここに修正PRを出してもいいのですが取り込みが放置されており、ちょっと出すのを躊躇しています。

### テンプレートのメトリクスストリームのInclude/Excludeの設定上限

Metric Streamにすると、リクエスト短歌は下がっても取り込むメトリクス種別が増えるため、CloudWatchコストが増えることに触れました。これに対する対応は「単純に取り込むNamespaceを絞ること」が第一選択肢ですが、CloudFormationはYAML定義敵に3つまでしかInclude/Excludeを[渡せない作り](https://github.com/DataDog/cloudformation-template/blob/302ec20f596e988c7a2091f95a9c505a1663b8db/aws_streams/streams_single_region.yaml#L174-L203)です。3つ以上設定するには、CloudFormation Stackのテンプレートを手元で管理に切り替えて修正する必要があります。

幸いテンプレートは[公開されている](https://github.com/DataDog/cloudformation-template/tree/master/aws_streams)ので、頑張るのもいいでしょう。

# まとめ

Datadogが想定している基本動作は大事なので、CloudFormationから作成してみて動作を確認するのがいいでしょう。次回はPulumiでCloudFormationを丸っとポートしてみましょう。

# 参考

* [Amazon Data Firehose を使用した AWS CloudWatch メトリクスストリーム](https://docs.datadoghq.com/ja/integrations/guide/aws-cloudwatch-metric-streams-with-kinesis-data-firehose/?tab=cloudformation)
* [DataDog/cloudformation-template | Github](https://github.com/DataDog/cloudformation-template)
* [Amazon CloudWatchの費用を半額削減した話 - Studyplus Engineering Blog](https://tech.studyplus.co.jp/entry/2023/10/16/100000)

[^1]: UsageTypeでCloudWatch Serviceを絞り込んでください。GMD-Metrics=Bulk Get Metric Dataを指します。
