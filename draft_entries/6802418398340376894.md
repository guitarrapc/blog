---
Title: PowerShellの-PassThruパラメータについて
Category:
- PowerShell
Date: 2013-01-24T20:01:15+09:00
EditURL: https://blog.hatena.ne.jp/guitarrapc_tech/guitarrapc-tech.hatenablog.com/atom/entry/6802418398340376894
PreviewURL: https://tech.guitarrapc.com/draft/entry/M7gNJhXTAeDE5DuoNIiVv0uMQ9s
CustomPath: 2013/01/24/200115
---

<!--
Date: 2013-01-24T20:01:15+09:00
URL: https://tech.guitarrapc.com/entry/2013/01/24/200115
-->

前回の第一回シェル芸への挑戦で牟田口先生から以下の別解をいただきました。

[牟田口大介さん (@mutaguchi) 1月 24, 2013](https://twitter.com/mutaguchi/status/294253558868635649)

さて、-PassThreパラメータ…コレがようやく理解出来たので記事にしたいと思います。 さらにPowerShell V3.0では-PassThruも強化されていますのでぜひぜひ。

## そもそも-PassThruって何するの

一番分かりやすい説明はコレでしょうか。

<a href="http://blogs.technet.com/b/heyscriptingguy/archive/2011/11/18/use-the-powershell-passthru-parameter-and-get-back-objects.aspx" target="_blank">Hey, Scripting Guy! Blog - Use the PowerShell Passthru Parameter and Get Back Objects</a>

以下の記述があります。
So, what does passthru do for me? For example, there are many Windows PowerShell cmdelts that simply work, and they do not return any data. An example is the Start-Process cmdlet. Here is an example of using the Start-Process cmdlet to start Notepad. Notice, that the line following the command is empty~中略~ If I add the passthru switched parameter to the end of the command, a Process object returns to the Windows PowerShell console.
要約すると、**「返戻値を持たないコマンドレットであっても、当該コマンドのオブジェクトを返してくれる」**ということです。
## -PassThruパラメータの指定方法
コマンドの最後にパラメータを付けます。 -PassThruパラメ－タは引数を持たないスイッチなので、以下のような要領で使用します。

```ps1
Start-Service -Name 'wuauserv' -PassThru
```

-PassThruパラメータを指定しないとこうですね。

```ps1
Start-Service -Name 'wuauserv'
```

## -PassThruがやっていること

以下のような記事があります。

<a href="http://stackoverflow.com/questions/6931873/powershell-how-to-implement-standard-switches" target="_blank">Powershell: how to implement standard switches?</a>

`[CmdltBinding()]` attributeを使わずに、-PassThruを実装するにはという内容です。 興味深いのでよろしければ。

## -PassThruパラメータをつけると出力がどう変わるの?

コマンドによって、出力が変化します。 ここでは、以下のコマンドでの出力の違いを紹介します。

```ps1
Start-Process
Start-Service
Out-GridView
Compare-Object
Add-Member
```

### Start-Processの例

Hey, Scripting Guy! Blogで例に挙げられているStart-Processコマンドレットの事例です。 Start-Processは、通常Processを開始するのみで返戻値を持ちません。 以下のコマンドを-PassThruパラメータなしで実行すると返戻値を持たないことが分かります。

```ps1
Start-Process notepad
```

ところが、-PassThruパラメータをコマンドの末尾に付けることで、プロセスを実行しつつ、自身のProcess-Objectを返してくれます。

```ps1
Start-Process notepad -PassThru
```

-PassThruする事で、そのプロセスの実行結果を返してパイプラインにつなげるため、Get-Processなどで取得する事の労力が省かれ非常に有益となります。 たとえば、プロセスを実行してから、そのプロセスの完了をWaite-Processで待機する間に処理を挟むなどです。

```ps1
$firefox = Start-Process firefox -PassThru
# {...入れたい処理....}
Wait-Process -Id ($firefox.Id)
```

### Start-Serviceの例

では、Start-Serviceではどうなるのでしょうか。 Start-ServiceもStart-Processと同様に、通常は実行したサービスの状態を返しませんが…-PassThruを指定すると返しています。

```ps1
Start-Service -Name 'wuauserv' -PassThru
```

### Out-GridViewの例

PowerShell 3.0での-PassThruの例として以下の記事があります。

<a href="http://www.computerperformance.co.uk/powershell/powershell3-passthru.htm" target="_blank">PowerShell 3.0 -PassThru</a>

ここで、なんとOut-Gridで-PassThruを指定すると、選んだ項目を返してくれるとあります。 たとえば、現在のプロセス一覧をGUI表示し、選んだ結果を返す例です。 まずは-PassThruなしで実行してみますが……ただ表示するだけで、プロセスを選んでいても返されません。

```ps1
Get-Process | Out-GridView
```

一方、Out-GridViewに-PassThruパラメータを指定するとOKボタンが出来ています。 OKを押すと、その際選択していたプロセス情報が標準出力に返されます。

```ps1
Get-Process | Out-GridView -PassThru
```

Out-GridViewで選択していたプロセスが標準出力に返されました。


```ps1
Compare-Objectの例```
```

そして、今回のきっかけとなったCompare-Object (diff)です。
出力が値だけに変化したことが分かります。 -PassThruすることで扱いやすくなりますね。

### Add-Memberの例

PSObjectでないオブジェクトの拡張を行うとき(メンバーを追加など)に利用するのが`Add-Member`です。

NotePropertyやScriptMethodなどを追加出来るので便利なコマンドです。

さて、Add-Memberする際は、自身が-is PSObejct -eq $trueならいいのですが、そうでない場合にはPSObjectでラップしてあげる必要があります。そこで`-PassThru`パラメータです。

Add-Member実行時に-PassThruを付けることで、Add-Memeberの結果、新しく作られたPSObjectを自身に返します。 この結果、`Add-MeMber`の対象オブジェクトを拡張することが可能になります。

一方Add-Member実行時に-PassThruを付けないとどうなるでしょうか。`Start-Process`などと同様、Add-Memberコマンドレットは実行結果(`Add-Memeber`して新しく作ったPSObject)を返しません。結果、Add-Memberの対象オブジェクトを拡張する事に失敗します。

サンプルとして、NotePropertyにCommentプロパティを追加し値に"Hello"を与えてみます。

**-PassThruがない場合**

```ps1
$sample = "ABC"
$sample -is [PSObject]
$sample | Add-Member NoteProperty Comment "Hello" -Force
$sample.comment
```

結果はこの通り、NotePropertyが表示できません。(Falseは、`-is [PSObject]`の結果です。)

```ps1
False
```

`Get-Memeber`でプロパティを確認すると…NotePropertyの追加に失敗しています。

```ps1
$sample | Get-Member -MemberType Properties | Format-Table -AutoSize

   TypeName: System.String

Name   MemberType Definition
----   ---------- ----------
Length Property   int Length {get;}
```

**-PassThruがある場合**

```ps1
$sample =　"ABC"
$sample -is [PSObject]
$Sample =　$sample | Add-Member NoteProperty Comment "Hello" -Force -PassThru
$sample.comment
```

結果はこの通り、NotePropertyが表示出来ました。(Falseは、`-is [PSObject]`の結果です。)

```ps1
False
Hello
```

`Get-Memeber`でプロパティを確認すると…しっかりNotePropertyの追加ができています。

```ps1
$sample | Get-Member -MemberType Properties | Format-Table -AutoSize


   TypeName: System.String

Name    MemberType   Definition
----    ----------   ----------
Comment NoteProperty System.String Comment=Hello
Length  Property     int Length {get;}
```

## -PassThruパラメータになれよう!!

もっともな一言が<a href="http://www.computerperformance.co.uk/powershell/powershell3-passthru.htm" target="_blank">PowerShell 3.0 -PassThru</a>にありました。

> The best way to learn about PowerShell's -PassThru parameter is by experimenting with examples such as Stop-Process or Out-GridView.

ということで、習うより慣れろってことで。

## 参考資料

* <a href="http://technet.microsoft.com/ja-jp/magazine/hh750381.aspx" target="_blank">Windows PowerShell: オブジェクトをカスタマイズするさまざまな方法</a>
* <a href="http://mtgpowershell.blogspot.jp/2010/07/filterpassthru.html" target="_blank">FilterとPassThruの使い方</a> <a href="http://kogelog.wordpress.com/2013/01/16/20130116-02/" target="_blank">Windows Server 2012のWDACで使用できるPowerShellコマンドレット (Add-OdbcDsn) について</a>

### 牟田口先生からコメントいただきました

[牟田口大介さん (@mutaguchi)](https://twitter.com/mutaguchi/status/294546807172784128")
