---
Title: GitHub ActionsでUbuntu20.04環境を使う
Category:
- CI/CD
Date: 2025-04-02T23:59:00+09:00
EditURL: https://blog.hatena.ne.jp/guitarrapc_tech/guitarrapc-tech.hatenablog.com/atom/entry/6802418398355446501
PreviewURL: https://tech.guitarrapc.com/draft/entry/wAhxhAmmWQ6FYoIhuAgBkWzIkxg
CustomPath: 2025/04/02/235900
Draft: true
---

GitHub ActionsにはホストランナーとしてUbuntuがありますが、Ubuntu 20ランナーイメージは[2025/02/01-04/15まででサポート終了](https://github.blog/changelog/2025-01-15-github-actions-ubuntu-20-runner-image-brownout-dates-and-other-breaking-changes/)です。これ以降は、従来の簡単な使い方ではUbuntu 20.04環境を使うことができなくなります。

今回は2025/4/16以降もUbuntu 20.04環境を使う方法を紹介します。

[:contents]

# なんでUbuntu 20.04環境を使いたいの?

動作環境としてのUbuntu20.04はEOLに合わせて使わないほうがいいですが、Ubuntu 20.04は古いglibcやglibc++を使うことができるので、古いLinux環境で動作するアプリケーションをビルドできます。具体的には、glibcでビルドしたアプリケーションは、ビルドした環境よりglibcが新しい環境では互換性があり動作すると期待できる一方、ビルドした環境より古いglibc環境ではまず動作しません。

各ディストリビューションのglibcバージョンは[次のサイト](https://repology.org/project/glibc/versions)でまとまっています。Ubuntu 20.04はglibc 2.31、Ubuntu 22.04はglibc 2.35です。CentOS Stream 9はglibc 2.34、CentOS Stream 10はglibc 2.39です。このため、Ubuntu 22.04でビルドするとCentOS Stream 9で動作しないと考えられます。

![Ubuntuのglibcバージョン](image-1.png)

![CentOS Streamのglibcバージョン](image-2.png)

glibcのバージョンで見た時Ubuntu22.04のglibc2.35は割と新しく他のディストリビューションで動作しない可能性が高いため、Ubuntu 20.04環境は依存が解決された状態でビルドできる貴重な環境といえます。

Ubuntu 22.04でglibcのバージョンを下げることも検討できますが、glibcのバージョンを下げた時に各種ツールチェインが素直に動くかというと宗でもないので、素直にUbuntu 20.04環境を使うのはアプリケーションのビルドにおいて重要な意味があります。

# これまでのUbuntu 20環境の使い方

2025/4/15までは次のように`runs-on`に`ubuntu-20.04`を指定するだけで、Ubuntu 20.04環境を使うことができました。
例えばこの環境に.NET SDKとRustをインストールする場合は次のように書きます。

```yaml
name: ubuntu-20.04
on:
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-20.04
    timeout-minutes: 30
    steps:
      - uses: actions/setup-dotnet@67a3573c9a986a3f9c594539f4ab511d57bb3ce9 # v4.3.1
        with:
          dotnet-version: '9.0.x'
      - name: check dotnet version
        run: dotnet --list-sdks
      - uses: actions-rust-lang/setup-rust-toolchain@9399c7bb15d4c7d47b27263d024f0a4978346ba4 # v1.11.0
      - name: check rutst version
        run: rustc --version
      - name: check cargo version
        run: cargo --version
```

2025/4/16以降は、`ubuntu-20.04`を指定してもUbuntu 20.04環境は使えません。

```sh
Requested labels: ubuntu-20.04
Job defined at: guitarrapc/ubuntu-glibc/.github/workflows/ubuntu20-old.yaml@refs/pull/2/merge
Waiting for a runner to pick up this job...
Job is waiting for a hosted runner to come online.
Job is completed before starting.
```

![ubuntu-20.04はもう使えない](image.png)

# 2025/4/16以降のUbuntu 20環境の使い方

`runs-on: ubuntu-20.04`を指定してもUbuntu 20.04環境は使えません。代わりに、GitHub ActionsでUbuntu 20.04を使う方法をいくつか考えてみましょう。
この中だとBのジョブをコンテナが、現実的にコスト/手間が小さく、かつ何か変更あっても保守しやすいでしょう。

* A. GitHub Actionsのジョブ中でDocker ComposeなどでUbuntu 20.04コンテナを起動して実行
* B. ジョブをUbuntu 20.04コンテナで実行する
* C. 適当なUbuntu 20.04マシンを用意してセルフホストランナーで実行

## Ubuntuコンテナイメージを選択する

GitHub Actionsには[ジョブをコンテナで実行する方法](https://docs.github.com/en/actions/writing-workflows/choosing-where-your-workflow-runs/running-jobs-in-a-container)[^1]があります。
この方法を使うと、GitHub Actionsをホストランナーではなく指定したコンテナで実行できます。

では、どのコンテナイメージを使うのがいいでしょうか?ぱっと思いつくのは次のイメージ一覧です。
ビルドで使うので、Gitやcurl、build-essential、ca-certificatesなどは入っていて欲しいところです。ホストランナーなら.NET SDKやRustなど各種ランタイムも入っていますが、そこはあきらめるとしてもある程度のセットアップは避けられるなら避けたいものです。

* Docker Hubの公式[Ubuntu](https://hub.docker.com/_/ubuntu/)イメージ
* 自分でビルドしたイメージをghcrにホストして利用
* 他のイメージ

Docker Hubの公式Ubuntuイメージには、curlを始めとして各種aptなどツールは何も入っていません。ショウガナイ。
始めから各種aptが入っている3rdパーティのUbuntuイメージがあれば手間を大きく削減出来そうです。
各種aptなどツールのセットアップに時間がかかるならイメージを自分でビルドしてghcrにホストしておくのが良いでしょう。

いろいろ検討しましたが、基本的に公式Ubuntuイメージを使いつつ都度イメージにツールをセットアップ、ツールのセットアップが長いなら事前にイメージをビルドしてghcrにホストしておくのが良いでしょう。
今回は公式Ubuntuイメージを使いつつ、必要なツールをセットアップする方法を紹介します。

## ジョブをUbuntu 20.04コンテナで実行する

GitHub ActionsのジョブをUbuntu 20.04コンテナで実行するには、`runs-on`に`ubuntu-24.04`[^2]を指定し`container`にUbuntu 20.04イメージを指定します。
後は必要なツールをセットアップして、ビルドに望めばOKです。

```yaml
name: ubuntu-20.04
on:
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-24.04
    container:
      # Needs to lock glibc version to 2.31, ubuntu 20.04 has glibc 2.31
      image: ubuntu:20.04
    timeout-minutes: 30
    steps:
      - name: apt-get
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          apt-get update
          apt-get install -y unzip curl git autoconf build-essential ca-certificates tzdata
      # follow https://learn.microsoft.com/en-us/dotnet/core/install/linux-ubuntu-install?tabs=dotnet8&pivots=os-linux-ubuntu-2004#register-the-ubuntu-net-backports-package-repository
      - name: apt-get (.NET)
        run: |
          apt-get install -y libicu66
      - name: check glibc version
        run: ldd --version
      - uses: actions/setup-dotnet@67a3573c9a986a3f9c594539f4ab511d57bb3ce9 # v4.3.1
        with:
          dotnet-version: '9.0.x'
      - name: check dotnet version
        run: dotnet --list-sdks
      - uses: actions-rust-lang/setup-rust-toolchain@9399c7bb15d4c7d47b27263d024f0a4978346ba4 # v1.11.0
      - name: check rutst version
        run: rustc --version
      - name: check cargo version
        run: cargo --version
```

# コンテナ実行ジョブの注意点

コンテナ実行ならではの注意点があります。公式ドキュメントでは記載がないので参考にどうぞ。
各セクションは次のような意味を持ちます。

* ✔️ DO: 推奨
* ⚠️ CONSIDER: 検討/考慮する
* ❌ AVOID: 避ける

## ✔️ DO: 公式のイメージセットアップを参考にする

Ubuntu 20.04など指定した環境を再現する場合、公式はどうやっているのか、どうやるのを推奨しているのか参考にするのが良いでしょう。

GitHub ActionsホストランナーOSのコンテナイメージは[actions/runner-images](https://github.com/actions/runner-images)で公開されています。また、各種言語のコンテナイメージも多くは公開されています。

* [Ubuntu 20.04](https://github.com/actions/runner-images/blob/38a05d5bbcabb6b72e141c0ecf4f1ad74318096a/images/ubuntu/Ubuntu2004-Readme.md)ホストランナーのイメージセットアップがある
* .NET SDKは[dotnet/dotnet-docker](https://github.com/dotnet/dotnet-docker)にイメージセットアップがある
* .NET SDKは[Ubuntuセットアップ](https://github.com/dotnet/docs/blob/de5fe14527001c6fae236c5a8712537abe7c3e8d/docs/core/install/linux-ubuntu-install.md)にUbuntu 20.04のセットアップがある

## ⚠️ CONSIDER: defaults.run.working-directoryはコンテナに存在するパスか注意する

ジョブで`run`を実行する際、常に指定したパスをカレントディレクトリにして実行するのに`defaults.run.working-directory`を指定することがあります。
ホストマシンの`runs-on`の場合、ホストに存在しないパスを指定していても特にエラーが出ることはありませんでしたが、コンテナにおいては`OCI runtime exec failed`エラーが出ます。
なお、`nodejs`アクションのように`run:`を使っていない場合は、ホストに存在しないパスで実行されてもエラーになりません。

```yaml
jobs:
  build:
    runs-on: ubuntu-24.04
    container:
      # Needs to lock glibc version to 2.31, ubuntu 20.04 has glibc 2.31
      image: ubuntu:20.04
    timeout-minutes: 30
    defaults:
      run:
        working-directory: /foo
    steps:
      - name: apt-get
        run: |
          echo foo
```

```sh
OCI runtime exec failed: exec failed: unable to start container process: chdir to cwd ("/foo") set in config.json failed: no such file or directory: unknown
Error: Process completed with exit code 126.
```

もしリポジトリにあるパスを指定したい場合は、`run`が実行されるステップの前に`checkout`を実行しておくとエラーが出ません。

```yaml
jobs:
  build:
    runs-on: ubuntu-24.04
    container:
      # Needs to lock glibc version to 2.31, ubuntu 20.04 has glibc 2.31
      image: ubuntu:20.04
    timeout-minutes: 30
    defaults:
      run:
        working-directory: /foo
    steps:
      # リポジトリにfoo/が含まれる
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
      - name: apt-get
        run: |
          echo foo
```


## ❌ AVOID: 大きなサイズのパッケージは利用を避ける

GitHub Actionsのコンテナ実行に限った話ではありませんが、なるべく小さいサイズのパッケージを利用するようにしましょう。
毎ビルド時にセットアップするので、パッケージサイズが大きいと失敗する確率が飛躍的に上がります。残念ながらaptはそこまで安定していませんし、.NETインストールスクリプトのホスト先も不安定です。

パッケージサイズを小さくするだけで、ビルドの安定性が上がります。

```sh
# AVOID: サイズの大きなパッケージは避ける
apt-get install -y libicu-dev

# DO: サイズの小さなパッケージを利用する
apt-get install -y libicu66
```

# まとめ

glibcのバージョンに由来してUbuntu 20.04環境を使う、そんなニッチなニーズも世の中にはあります。今回のようにGitHub Actionsは任意のコンテナイメージを利用できるので、小さな努力でやりたいことが実現できるのは素晴らしいですね。

# 参考

* [Versions for glibc](https://repology.org/project/glibc/versions)
* [GitHub Actions: Ubuntu 20 runner image brownout dates and other breaking changes | GitHub Blog](https://github.blog/changelog/2025-01-15-github-actions-ubuntu-20-runner-image-brownout-dates-and-other-breaking-changes/)
* [The Ubuntu 20.04 Actions runner image will begin deprecation on 2025-02-01 and will be fully unsupported by 2025-04-15 #11101 | actions/runner-images](https://github.com/actions/runner-images/issues/11101)
* [Running jobs in a container | GitHub Docs](https://docs.github.com/en/actions/writing-workflows/choosing-where-your-workflow-runs/running-jobs-in-a-container)

[^1]: 似た方法にサービスコンテナがありますが[サービスコンテナ](https://docs.github.com/ja/actions/using-containerized-services/about-service-containers)はジョブの実行環境を提供するものではなく、ジョブの実行環境にサービスを追加するものです。
[^2]: `ubuntu-24.04`でなくても他のイメージでもいいですが、わかりやすく現在の最新ホストランナーにします
