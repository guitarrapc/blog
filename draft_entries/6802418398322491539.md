---
Title: 外部からアクセスできないことを監視するジレンマ
Category:
- Network
EditURL: https://blog.hatena.ne.jp/guitarrapc_tech/guitarrapc-tech.hatenablog.com/atom/entry/6802418398322491539
PreviewURL: https://tech.guitarrapc.com/draft/entry/eFuxq6Lt1OS1Xo78K5yyLuI9xi4
Draft: true
CustomPath: 2025/01/22/235900
---

「〇〇サービスの管理画面が外部からアクセスできるようになっていました」いつ聞いてもドキッとする事例です。
今回は、外部からアクセスできるべきでないサイトを監視するジレンマについて考えてみます。

[:contents]

# 外部からアクセスできないことを担保するとは

パブリックなサイトについて、外部からのアクセスができていることを監視する手段はいくつかあります。HTTPならレスポンスコードで確認できますし、TCPならセッション成立できるかで確認できます。

* HTTP(S)でのアクセス(L7): レスポンスコードで確認
* TCP, UDPでのアクセス(L4): セッション成立で確認
* ICMPでのアクセス(L3): パケットが届くかで確認
* DNS: ドメイン解決できるかの確認

では外部からアクセスさせたくない社内用のサイトなどを、外部からアクセスできないことを担保するにはどうすればいいでしょうか監視サービスに「成功失敗の逆転判定」があれば?一番簡単です、最高!しかしそんな都合のいいことはなく、例えばDatadogのSyntheticMonitoringに逆転判定はありません。

ということで、逆転判定がない場合に外部からアクセスできないことをどう担保するかが今回のテーマです。

# 逆転判定がない状態で外部からアクセスできないことを監視する

外部からアクセスできることは「**アクセスできる**」ことを成功とすればよいのに対して、外部からアクセスできないことは「**アクセスできない**」ことを成功とする必要があります。インフラ管理の視点とアプリケーションの視点で考えてみます。

## インフラ管理の視点でアクセスできないようにする

インフラ管理の視点でアクセスできないようにするなら、**ファイアウォールアクセスを拒否する**が基本です。いわゆるセキュリティグループなどで、TCPに対してIP制限をかけることで外部からのアクセスを拒否します。パブリックネットワークならこのようになります。

* HTTPでのアクセス: TCPで拒否されるのでアクセスできない
* TCPでのアクセス: TCPで拒否されるのでアクセスできない
* ICMPでのアクセス: そもそも許可しないのでアクセスできない
* DNS: ドメイン解決はできる

もう少しネットワークアーキテクチャで解決する方法としては、DNS解決+IP制限という手もあります。例えばVPNや社内からのみアクセスできればよくネットワーク整備できているなら、サイトをプライベートDNSに登録して、プライベートIPでアクセスできるようにするという方法です。そもそも外部からのアクセス経路がないので、外部からアクセスできないことを担保できます。境界型セキュリティの考え方です。

* HTTPでのアクセス: 外部に公開されていない
* TCPでのアクセス: 外部に公開されていない
* ICMPでのアクセス: 外部に公開されていない
* DNS: 社内DNSでのみ解決できる

境界型防御は侵入された場合に弱いため、ポリシーベースでアクセスコントロールを行うことも検討できるでしょう。とはいえ、いったん手法としてはここまでで出そろっていますね。インフラ視点で外部アクセスさせないなら次のようになります。

* TCPレベルでIP制限する
* プライベートネットワークに配置して外部に一切公開しない

なるべく低いレイヤーでアクセスを拒否するというのは、ネットワーク監査もしやすく、AWS Configなどクラウドポリシーチェックツールでも違反検知しやすいので自然な選択でしょう。

## アプリケーションの視点でアクセスできないようにする

アプリケーション支店でアクセスできないようにするなら、アプリケーションの設定でアクセスを拒否することが馴染み深いでしょう。いわゆるWAFやHTTPリスナーなどで、リクエスト元に対してIP制限をかけることをで外部からのアクセスを拒否します。[^1]パブリックネットワークならこのようになります。

* HTTPでのアクセス: WAFで拒否されるのでアクセスできない
* TCPでのアクセス: ロードバランサーやWAFまでセッションが張れる
* ICMPでのアクセス: そもそも許可しないのでアクセスできない
* DNS: ドメイン解決はできる

WAF/HTTPリスナーにきたリクエストに対して制御するので、TCPレベルでは疎通できます。

## アクセスできないことを監視する

視点を把握した上で、逆転判定がない外部アクセス監視サービスを用いて「外部からのアクセス監視ができない」ことを監視する方法を考えます。

**インフラ視点**

TCPレベルでアクセスを拒否しているなら、TCP/HTTP監視ともに失敗します。しかし逆転判定ができない場合、アクセスできないことを監視できません。[^3]
セキュリティグループでアクセスを拒否している場合、TCP接続ができないことを監視できないんですよね。

**アプリケーション視点**

WAFやHTTPリスナーでアクセスを拒否しているなら、HTTPリクエストを送信してレスポンスコードで拒否されたか監視できます。例えば403や404が返ってきたら成功として監視できます。Datadogならこの手法で監視できます。

**頻度問題**

アクセスできないことを担保するのは一定の頻度で実行できる必要があります。事故る時は意図しない時なのが常なので、例えばデプロイ時に1回だけじゃ意味が薄いのですね。常時ある程度の頻度で監視され続けるのがいいです。

# 外部からアクセスできるようにするジレンマ

外部からアクセスできないことを監視できないと、いずれ事故る、事故ったサービスはこれまで数多く見てきて、私の結論は「外部からアクセスできないことを監視するしかない」です。外部からアクセスできないことを担保するにはHTTP(L7)で拒否するしかない。インフラ的にそもそもTCPレベルでアクセスできないようにIP制限すればいいのに!

これが、私が考える外部からアクセスできないことを監視するジレンマです。

WAFでIP制限されても、インフラ視点でみるとTCP的にはIP制限がかかってないので一見するとアクセスできる状態です。いくらWAF/HTTPリスナーでアクセスを拒否していても、TCPレベルでアクセスできるのは納得感がありません。ネットワークセキュリティポリシーは低レイヤーで解決するのが最も効率的で理由も説明しやすいので、「アクセス制限されているか確認したいです」「HTTPリスナー/WAFでIP制限しています」「いや、セキュリティグループあいてますけど、なぜわざわざWAFで?」「アクセスできないことを外部から担保したいので」というやり取りは100回ぐらいすることになります。そして、いずれ疲れてもういいや、セキュリティグループで拒否しよ。となるのですが、アクセスできないことを監視できなくなるので、何か手を見つけないと気づかないうちに「アクセスできる状態になっていました」となります。

## 他にどのような手があるか

**自前監視**

外部からの監視サービスを使うのではなく、自前で監視すればいいです。自前処理なら、セキュリティグループであってもなんでもアクセスできなければ監視失敗として通知できます。ただ、マネージドサービスのようにお任せできなくなります。外部からのアクセスができないことをするサービスが増えるので、それがちゃんと動いているか監視する手間が増えるのはトレードオフです。適当にサーバーレスで実行すればいいものの、作った瞬間から負債です。

マネージドサービスで監視は難しい。

**内部からしかアクセスできない**

外部ネットワークにそもそも公開せず、内部ネットワークに閉じ込めるのもいいですね。最も望ましいですが、クラウド上のサービスならクラウドとオフィスをうまくつなぐなり、何かしらでトンネル掘るなりがんばる必要があります。会社としてレベルの制約がかかりやすいので、なかなか難しいです。

## 軽減案

セキュリティグループなどTCPで不正で、普段の外形監視をあきらめた場合の軽減案も考えてみましょう。

定期的なペネトレーションテストは案として考えられます。頻度問題と同じなのですが、ペネトレーションテストをさくっと簡単に1hや5分に1回できるかあたりが課題です。

セキュリティグループなどの防御層のログ分析もありでしょう。ネットワークフローログ的なものになるとブロックしたログだけ分析する手間が課題です。WAFとかならブロックしたログだけ出せたりしますが、フローログはそうもいかない。分析の定期頻度も課題です。

# まとめ

ジレンマがジレンマすぎる。

[^1]: 認証で拒否するのが真っ先に上がるのですが、アクセスできない = そもそもログイン画面に到達すらさせたくないのが主眼なので、認証は別の話として取り上げません。
[^2]: アプリケーション視点でパブリック/プライベートネットワークを考慮することは少ないので、パブリックネットワークを前提として考えましょう
[^3]: Datadogはここで脱落。Synthetics MonitoringはTCP接続ができないと監視失敗扱い + 逆転判定できない
