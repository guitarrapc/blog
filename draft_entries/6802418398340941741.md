---
Title: PowerShell で 特定のWindows Updateを検索、削除したい
Category:
- PowerShell
Date: 2013-07-25T20:07:54+09:00
EditURL: https://blog.hatena.ne.jp/guitarrapc_tech/guitarrapc-tech.hatenablog.com/atom/entry/6802418398340941741
PreviewURL: https://tech.guitarrapc.com/draft/entry/q6iZE4qGor6H4fhbDYoozEIlN0A
CustomPath: 2013/07/25/200754
---

<!--
Date: 2013-07-25T20:07:54+09:00
URL: https://tech.guitarrapc.com/entry/2013/07/25/200754
-->

以前、 Windows Updateの特定のKBを検索を探すやり方を紹介しました。

[PowerShellで所定のWindows Updateがインストールされているか確認する](http://guitarrapc.wordpress.com/2013/04/17/powershell%e3%81%a7%e6%89%80%e5%ae%9a%e3%81%aewindows-update%e3%81%8c%e3%82%a4%e3%83%b3%e3%82%b9%e3%83%88%e3%83%bc%e3%83%ab%e3%81%95%e3%82%8c%e3%81%a6%e3%81%84%e3%82%8b%e3%81%8b%e7%a2%ba%e8%aa%8d/)

今回は、削除までやってみましょう。
リモート先のサーバーにインストールされた KBも削除できるので、 Windows Update のバグ対応には便利ですよ。



## コード全文

こんな感じで。

```ps1
function Remove-KB{
    param(
      [parameter(
      mandatory,
      position = 0)]
      [string[]]
      $kbs
    )

    $PatchList = Get-WmiObject Win32_QuickFixEngineering | where HotFixId -in $kbs

    foreach ($k in $PatchList)
    {
        # If the HotfixID property contains any text, remove it (some do, some don't)
        $KBNumber = $k.HotfixId.Replace("KB", "")

        # Write-Host $KBNumber
        Write-Host ("Removing update with command: " + $RemovalCommand)

        # Build command line for removing the update
        $RemovalCommand = "wusa.exe /uninstall /kb:$KBNumber /quiet /log /norestart"

        # Invoke the command we built above
        Invoke-Expression $RemovalCommand

        # Wait for wusa.exe to finish and exit (wusa.exe actually leverages
        # TrustedInstaller.exe, so you won't see much activity within the wusa process)
        while (@(Get-Process wusa -ErrorAction SilentlyContinue).Count -ne 0)
        {
          Start-Sleep 1
          Write-Host "Waiting for update removal to finish ..."
        }
    }
}
```


実行するときは、kbを渡します。
KBが付いていてもいいです。無くてもいいです。

```ps1
Remove-KB -kbs "KB2821895"
```


自動的に Windows Updateを削除してくれるので、纏まった台数の削除をする際にはないと困りますね。

## GitHub

https://github.com/guitarrapc/PowerShellUtil/blob/master/Get-KBSearch/Remove-KB.ps1
