---
Title: はてなブログワークフロー利用の課題と自前管理への移行
Category:
- CI/CD
Date: 2025-04-06T23:59:00+09:00
EditURL: https://blog.hatena.ne.jp/guitarrapc_tech/guitarrapc-tech.hatenablog.com/atom/entry/6802418398411400751
PreviewURL: https://tech.guitarrapc.com/draft/entry/dh66pibQbSw7dg4EoH1Ghqq2iOk
CustomPath: 2025/04/06/235900
---

以前、GitHubとはてなブログを連動させている[話](https://tech.guitarrapc.com/entry/2025/01/04/235952)を書きました。はてなブログ提供のボイラーテンプレートを今も使っていますが、はてなワークフローは運用していく中で直接使わないケースも出てきたのでメモです。

[:contents]

# はてなブログのワークフロー想定と使い勝手

[はてなブログのボイラーテンプレート](https://github.com/hatena/Hatena-Blog-Workflows-Boilerplate/)は、はてなが提供しているReusable Workflow[hatena/hatenablog-workflows](https://github.com/hatena/hatenablog-workflows)を使っています。はてな管理のワークフローが実処理を担っているため、利用者はボイラーテンプレートを使うだけで済むという方針ですね。

実際割とよく機能するのですが、私はいくつかのワークフローはコピー&ペーストしてきて自前管理で運用しています。

# はてなワークフローを使い続ける課題

はてなワークフローを使ってみると、いくつかの課題が見えてきました。以下に挙げるものは、私が実際に運用していて感じたことです。

## ワークフローがタグ指定

さて、はてなReusable Workflowはタグで指定しています。このため、昨今のSHA指定でないとまずいという流れを考えると微妙な状況です。
ボイラーテンプレートのREADMEには、`workflowの変更は原則 Reusable workflows を変更するため基本的には更新は不要です`と書いてありますが、それはタグ指定しておりv1から変えないことを暗黙的に示唆しています。

[f:id:guitarrapc_tech:20250506201233p:plain:alt=はてなブログのバージョン]

この方針は2つのシーンで破綻します。

1. Reusable Workflowが使っているアクションで脆弱性があった時にユーザーは回避できない
2. はてなブログワークフロー自身を固定する想定がない

先日のtj-actions/changed-filesの脆弱性CVE-2025-30066が発表されたとき、はてなブログのボイラーテンプレートはこれをタグで指定したため影響を受ける状況でした。脆弱性発生が土曜、[SHAに切り替える修正](https://github.com/hatena/hatenablog-workflows/pull/94)は月曜に入ったのですが、はてなが管理しているため土日は修正されないままでした。[Issue](https://github.com/hatena/hatenablog-workflows/issues/93)で脆弱性共有はあげたものの、PRをあげても週末にマージされないのは分かっていたためこのタイミングで私は自前ワークフローへの変更に切り替えました。なお、現在もはてなブログのボイラーテンプレートからワークフロー参照はv1タグを使っており、SHA指定されていません。

ユーザーがワークフローを固定するときも、v1タグで運用する想定なのはちょっと微妙です。初めからSHA指定にしておいてDependabotで自動更新するようにテンプレート展開すれば、ユーザーは自分で更新する手間を最小にしつつワークフローを更新するか選択できます。

## ワークフローやアクションの修正

Reusable Workflowでやっている処理に手を入れたいとき、方針が一致なければ変更が受け入れられない場合もあります。
私は`tj-actions`を使わないポリシーに変えましたが、はてなブログのボイラーテンプレートは`tj-action/changed-files`をそのまま使う方針です。こういった方針の違いは当然ありますし、その場合はフォークするか自前でワークフローを持つしかないでしょう。それはそういうものです。

## ワークフローの想定利用が狭い

これはAPI設計の話ですが、はてなブログのワークフローはボイラーテンプレートの利用しか想定されていません。このため、ボイラーテンプレートにないワークフローの再利用は試されていないようです。

次に示すものは[修正PR](https://github.com/hatena/hatenablog-workflows/pull/104)が取り込まれていますが、それを感じさせたものでした。[create-draft](https://github.com/hatena/hatenablog-workflows/blob/main/.github/workflows/create-draft.yaml)ワークフローは[create-draft-pull-request](https://github.com/hatena/hatenablog-workflows/blob/main/.github/actions/create-draft-pull-request/action.yaml)アクションを呼び出しています。このアクションは`input`で`title`を受け取りますが、ボイラーテンプレートでは`github.event.inputs.title`を指定してました。このため、呼び出し元のワークフローが`workflow_dispatch`で`title`を指定しないと、タイトルが空になってアクションはエラーになります。

```yaml
uses: peter-evans/create-pull-request@271a8d0340265f705b14b6d32b9829c1cb33d45e # v7
env:
  OWNER_NAME: ${{ steps.set-owner.outputs.OWNER_NAME }}
  ENTRY_ID: ${{ steps.set-entry-variables.outputs.ENTRY_ID }}
  PREVIEW_URL: ${{ steps.set-entry-variables.outputs.PREVIEW_URL }}
with:
  title: ${{ github.event.inputs.title }}
  branch: draft-entry-${{ env.ENTRY_ID }}
  body: |
    ## ${{ github.event.inputs.title }}

    省略
```

アクションに渡したtitleを使うには次のように`inputs.title`を指定する必要があります。

```yaml
    - name: create draft pull request
      uses: peter-evans/create-pull-request@271a8d0340265f705b14b6d32b9829c1cb33d45e # v7
      env:
        OWNER_NAME: ${{ steps.set-owner.outputs.OWNER_NAME }}
        ENTRY_ID: ${{ steps.set-entry-variables.outputs.ENTRY_ID }}
        PREVIEW_URL: ${{ steps.set-entry-variables.outputs.PREVIEW_URL }}
      with:
        title: ${{ inputs.title }}
        branch: draft-entry-${{ env.ENTRY_ID }}
        body: |
          ## ${{ inputs.title }}

          省略
```

# フォークではなくコピー&ペーストで対応

私の運用では、ボイラーテンプレートをフォークして運用するのではなく、コピー&ペーストして頭に`_`をつけて運用しています。自分のポリシーと会わないものだけをコピーして、あとはボイラーテンプレートのものを使うという運用です。

* 自分が使いたくないアクションを差し替える
* できないことを対応する

## 自分が使いたくないアクションを差し替える例

例えば、hatenablog-workflowsから[.github/workflows/push-published-entries.yaml](https://github.com/hatena/hatenablog-workflows/blob/main/.github/workflows/push-published-entries.yaml)ワークフローをもってきて[.github/workflows/_push-published-entries.yaml](https://github.com/guitarrapc/blog/blob/main/.github/workflows/_push-published-entries.yaml)として保持しています。中で他のワークフローを参照していたらそれももって来る感じです。もともと参照していたワークフローはコメントアウトして、いつでも戻せるようにしておきます。

```yaml
# BEFORE: hatena/hatenablog-workflows | .github/workflows/push-published-entries.yaml
name: "[Reusable workflows] push published entries"

on:
  workflow_call:
    secrets:
      OWNER_API_KEY:
        required: true

jobs:
  upload-images:
    if: github.event.pull_request.merged == false
    uses: hatena/hatenablog-workflows/.github/workflows/upload-images.yaml@4cb2032c9665ad3b0eba9835182e2d23a1d49a81 # v1
    secrets:
      OWNER_API_KEY: ${{ secrets.OWNER_API_KEY }}



# AFTER: guitarrapc/blog | _push-published-entries.yaml
name: "[Reusable workflows] push published entries"

on:
  workflow_call:
    secrets:
      OWNER_API_KEY:
        required: true

jobs:
  upload-images:
    if: github.event.pull_request.merged == false
    # uses: hatena/hatenablog-workflows/.github/workflows/upload-images.yaml@v1
    uses: ./.github/workflows/_upload-images.yaml
    secrets:
      OWNER_API_KEY: ${{ secrets.OWNER_API_KEY }}
```

これはupload-images.yamlがtj-actions/changed-filesを使っているため、私のポリシーに合わないからです。変更した際は、外部アクションをすべてSHAに変更しつつ、`tj-actions/changed-files`から`dorny/paths-filter`にしていました。以下は、現在(左)とhatenablog-workflows(右)の差分です。

[f:id:guitarrapc_tech:20250506201242p:plain:alt=upload-images.yaml]

## できないことを対応する

例えば、[.github/actions/create-draft-pull-request/action.yaml](https://github.com/hatena/hatenablog-workflows/blob/72e8330c6e2e03be1be275cd527e4d5db558f928/.github/actions/create-draft-pull-request/action.yaml)はPRボディが固定文字になっています。PULL_REQUEST_TEMPLATE.mdを指定して持ってくるか、文章を変更するかで悩みましたが、後者にしました。本家の1.3.8でPULL_REQUEST_TEMPLATE.mdがあれば指定できるようになる[PR](https://github.com/hatena/hatenablog-workflows/pull/114)が取り込まれているので、1.3.8が出たら戻す予定です。

# まとめ

hatena/hatenablog-workflowsは多くの人が使っていて、ワークフローとして想定があるのでなかなか修正を出しにくいものもあります。API的に問題ない場合はこれからも提示していきますが、合わない割り切って手元管理でいい気持ちもあります。徐々に良くなってきているので、今後も貢献できるものはしたいです。

# 参考

* [GitHubとはてなブログを連動させる - tech.guitarrapc.cóm](https://tech.guitarrapc.com/entry/2025/01/04/235952)
* [hatena/hatenablog-workflows: reusable workflows for hatenablog](https://github.com/hatena/hatenablog-workflows)
* [hatena/Hatena-Blog-Workflows-Boilerplate](https://github.com/hatena/Hatena-Blog-Workflows-Boilerplate)
