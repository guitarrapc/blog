---
Title: AWS IAM Identity CenterをTerraformで構成する
Category:
- AWS
- Terraform
Date: 2025-03-26T23:59:00+09:00
EditURL: https://blog.hatena.ne.jp/guitarrapc_tech/guitarrapc-tech.hatenablog.com/atom/entry/6802418398344771635
PreviewURL: https://tech.guitarrapc.com/draft/entry/3WUHD2q1PEQtJz-7sEx2MLCnj2E
CustomPath: 2025/03/26/235900
Draft: true
---

前回はPulumiを使ってAWS IAM Access Identityを構成しました。
今回はTerraformで同じことをやってみましょう。

[:contents]

# 注意点

全体構成はPulumiと同様とします。

[TODO:URLはる]()

Pulumiで構成したときと同じように、注意点があります。

* グループと権限セットはアカウントごとに分ける
* 管理アカウントで一括管理
* TOTP送信を有効にしておく

# TerraformでAWS IAM Access Identityを構成する

[aws-ia/terraform-aws-iam-identity-center](https://github.com/aws-ia/terraform-aws-iam-identity-center)がいい感じの作りになっているので、これを使うのがお手軽でしょう。
私はこれをベースに一部調整していますが、基本的には同じです。

```terraform
module "aws-iam-identity-center" {
  source = "aws-ia/iam-identity-center/aws"
  version = "1.0.2"

  // Create desired GROUPS in IAM Identity Center
  sso_groups = {
    master_Admin : {
      group_name        = "master_Admin"
      group_description = "Admin IAM Identity Center Group"
    },
    master_ViewOnly : {
      group_name        = "master_ViewOnly"
      group_description = "ReadOnly IAM Identity Center Group"
    },
    serviceA_Admin : {
      group_name        = "serviceA_Admin"
      group_description = "Admin IAM Identity Center Group"
    },
    serviceA_ViewOnly : {
      group_name        = "serviceA_ViewOnly"
      group_description = "ReadOnly IAM Identity Center Group"
    },
  }

  // Create desired USERS in IAM Identity Center
  sso_users = {
    foo : {
      group_membership = ["master_Admin", "serviceA_Admin"]
      user_name        = "foo@example.com"
      given_name       = "Foo"
      family_name      = "Example"
      email            = "foo@example.com"
    },
    suchiha : {
      group_membership = ["master_ViewOnly", "serviceA_ViewOnly"]
      user_name        = "bar@example.com"
      given_name       = "Bar"
      family_name      = "Baz"
      email            = "bar@example.com"
    },
  }

  // Create permissions sets backed by AWS managed policies
  permission_sets = {
    master_Admin = {
      description          = "Provides AWS full access permissions.",
      session_duration     = "PT8H",
      aws_managed_policies = ["arn:aws:iam::aws:policy/AdministratorAccess"]
    },
    master_ViewOnly = {
      description          = "Provides AWS view only permissions.",
      session_duration     = "PT8H",
      aws_managed_policies = ["arn:aws:iam::aws:policy/job-function/ViewOnlyAccess"]
    },
    serviceA_Admin = {
      description          = "Provides AWS full access permissions.",
      session_duration     = "PT8H",
      aws_managed_policies = ["arn:aws:iam::aws:policy/AdministratorAccess"]
    },
    serviceA_ViewOnly = {
      description          = "Provides AWS view only permissions.",
      session_duration     = "PT8H",
      aws_managed_policies = ["arn:aws:iam::aws:policy/job-function/ViewOnlyAccess"]
    },
  }

  // Assign users/groups access to accounts with the specified permissions
  account_assignments = {
    master_Admin : {
      principal_name  = "master_Admin"
      principal_type  = "GROUP"
      principal_idp   = "INTERNAL"
      permission_sets = ["mater_Admin"]
      account_ids = [
      "111111111111", // replace with your desired account id
      ]
    },
    master_ViewOnly : {
      principal_name  = "master_ViewOnly"
      principal_type  = "GROUP"
      principal_idp   = "INTERNAL"
      permission_sets = ["master_ViewOnly"]
      account_ids = [
      "111111111111",
      ]
    },
    serviceA_Admin : {
      principal_name  = "serviceA_Admin"
      principal_type  = "GROUP"
      principal_idp   = "INTERNAL"
      permission_sets = ["serviceA_Admin"]
      account_ids = [
      "222222222222", // replace with your desired account id
      ]
    },
    serviceA_ViewOnly : {
      principal_name  = "serviceA_ViewOnly"
      principal_type  = "GROUP"
      principal_idp   = "INTERNAL"
      permission_sets = ["serviceA_ViewOnly"]
      account_ids = [
      "222222222222",
      ]
    },
  }
}
```

# まとめ

Terraformだとパブリックモジュールを使って実装を余り気にせず構成できます。
パブリックなTerraformのリモートモジュールは状況によって破壊的変更を伴うケースがあるため、個人的には必ずローカルに持ってきて構成しています。
とはいえ使いやすい作りや工夫がこらされている物が多いので、コードリードしながら学びつつ使うといいでしょう。

# 参考

* [aws-ia/terraform-aws-iam-identity-center | GitHub](https://github.com/aws-ia/terraform-aws-iam-identity-center)
