---
Title: DatadogでKubenretesのCPU使用率とメモリ使用率を監視する
Category:
- Observability
- Kubernetes
EditURL: https://blog.hatena.ne.jp/guitarrapc_tech/guitarrapc-tech.hatenablog.com/atom/entry/6802418398333267654
PreviewURL: https://tech.guitarrapc.com/draft/entry/cjXCOWCgOuLY863kZGvTjSuKA2I
CustomPath: 2025/03/01/235900
Draft: true
---

DatadogのKubernetesのCPUは1コア、メモリは1GiBなど値で取得されます。
システム状態としては使用率で監視するほうが便利ですが、どのように考えればいいかメモです。

[:contents]

# Kubernetes Resource Utilization

どのように考えればいいかのヒントは、Datadogの[ドキュメント](https://docs.datadoghq.com/ja/infrastructure/containers/kubernetes_resource_utilization/?tab=cpu)にああります。この画面で、Kubernetes Resource UtilizationでCPUやメモリを使用率で表示しており、次のように定義されています。

```
CPU usage/requests: 使用量の合計をリクエストの合計で割ったパーセンテージ。
Memory usage/requests: 使用量の合計をリクエストの合計で割ったパーセンテージ。
```

ダッシュボードなどで同様にクエリ+式でかけばよいですね。

> ![image](https://github.com/user-attachments/assets/1078fe02-0b06-4905-bb06-ddf46836fedf)
>
> 引用: https://docs.datadoghq.com/ja/infrastructure/containers/kubernetes_resource_utilization/

# Datadogのクエリ

CPU使用率を取得するには次のように書きます。usageとlimitsの単位が異なるので、`1000 * 1000 * 1000`で変換しています。

```
a: avg:kubernetes.cpu.usage.total{*}
b: avg:kubernetes.cpu.limits{*}
formula: a / (b * 1000 * 1000 * 1000) * 100
```

メモリは次のようになります。

```
a: avg:kubernetes.memory.working_set{*}
b: avg:kubernetes.memory.limits{*}
formula: a / b * 100
```

# まとめ

特にKubernetesでは使用しているCPUコアやメモリの値も大事ですが、使用率じゃないと普段の監視がしにくいんですよね。標準で出してくれてもいい気もしますが、算出できるのでまぁよし。

# 参考

* [Kubernetes Resource Utilization | datadog Docs](https://docs.datadoghq.com/ja/infrastructure/containers/kubernetes_resource_utilization/?tab=cpu)
