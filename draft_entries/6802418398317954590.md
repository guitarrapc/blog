---
Title: スケジュールトリガーで動作するGitHub Actionsワークフローの一覧取得
Category:
- Git
EditURL: https://blog.hatena.ne.jp/guitarrapc_tech/guitarrapc-tech.hatenablog.com/atom/entry/6802418398317954590
PreviewURL: https://tech.guitarrapc.com/draft/entry/Bsk2TOrkihl2kfa0iNr4wTjZdfc
Draft: true
---

CI/CDサービスとしてのGitHub Actionsが増え、スケジュールで定期的に実行しているリポジトリを多く観測します。そんな中気になる記事があります。

> [GitHub Actionsで定期実行（cron）のワークフローを組んだユーザーが退職すると、ワークフローは無効化される - shmokmt's blog](https://shmokmt.hatenablog.com/entry/2024/12/26/142250)

無効化されて「定期実行されなくなって困る!」となる前に対処するため、スケジュールトリガーのワークフローの一覧取得する方法を考えてみます。

[:contents]

# どのような問題なの?

スケジュール実行のGitHub ActionsはコミットしたユーザーをTrigger Actorとして実行します。このためリポジトリへのユーザーアクセスができなくなると権限がなくなり、ワークフローも実行ユーザーを取れないので無効化されると推測されます。しかもcronの値を変更ないと再アクティブされないというのが厄介です。

> 最後にワークフローの Cron スケジュールにコミットしたユーザーが組織から削除されると、スケジュールされたワークフローは無効になります。 リポジトリへの write アクセス許可を持つユーザーが Cron スケジュールを変更するコミットする場合、スケジュールされたワークフローが再アクティブ化されます。 この状況では、ワークフロー ファイルの変更によってワークフローが再アクティブ化されることはないことに注意してください。cron 値を変更し、この変更をコミットする必要があります。
>
> ```
> on:
>   schedule:
>     - cron: "15 4,5 * * *"   # <=== Change this value
> ```
> ref: https://docs.github.com/ja/actions/writing-workflows/choosing-when-your-workflow-runs/events-that-trigger-workflows#schedule

これを防いだり対処するには、スケジュールトリガーで動作するGitHub Actionsワークフローの一覧をサクッと確認できればよさそうです。また、最終コミットユーザーが重要なので一覧にこれも必要です。

# ワークフローを取得する方法

GitHub Actionsのワークフロー一覧を取得する方法はいくつかあります。

* クローンして.github/workflowsディレクトリから走査
* GitHub APIを使って取得
* GitHub CLI(gh)コマンドを使って取得

APIを叩くのもいいですが、手元でサクッと実行したいのでGitHub CLI(gh)を使いましょう。GitHub CLIはGitHub Actionsのホストランナーにデフォルトでインストールされているので、手元で動作確認できれば間違いなく動作すると期待できるのもメリットです。[^1]

## .github/workflowsディレクトリから走査

GitHub Actionsワークフローは.github/workflowsに配置する必要があります。これを利用して、リポジトリをクローンしてディレクトリを走査する方法があります。

```sh
# Bash
git clone
find .github/workflows -type f -name "*.yaml"
# あとはよしなに
```

```ps1
# PowerShell
git clone
Get-ChildItem -Path .github/workflows/*.yaml -File
# あとはよしなに
```

## GitHub Actions API

> [REST API endpoints for workflows - GitHub REST API](https://docs.github.com/en/rest/actions/workflows)

GitHub Actions APIを使うと、ワークフローの実行状況やワークフローの定義を取得できます。このAPIを使ってスケジュールトリガーで動作するGitHub Actionsワークフローの一覧と最終コミットユーザーを取得できます。

```cs
// C#ならOctokit + VYamlを使う
using Octokit;
using System.IO;

var dir = Directory.GetCurrentDirectory();
var client = new Octokit.GitHubClient(new ProductHeaderValue("foobar"));
var workflows = await client.Actions.Workflows.List("owner", "repo");
foreach (var workflow in workflows.Workflows)
{
    var yaml = File.ReadAllBytes(Path.Combine(dir, workflow.Path));
    // あとはよしなに
}
```

## GitHub CLI(gh)コマンド

> [cli/cli - GitHub’s official command line tool](https://github.com/cli/cli)

ghコマンドはGitHub CLIの略で、GitHubの操作をCLIから行うためのツールです。このツールを使うと、コマンドから一発でGitHub Actionsのワークフロー一覧を取得したり、Github APIを叩くことができます。簡単なことはコマンドで、ちょっとAPIをいじりたくなってもいい感じにできるので便利です。

```sh
gh workflow list --json name,path,state
# あとはよしなに
```

# スケジュールトリガーで動作するGitHub Actionsワークフローの一覧取得する

先に紹介したGithub CLI(gh)コマンドを使って、スケジュールトリガーで動作するGitHub Actionsワークフローの一覧を取得する方法を紹介します。ghコマンドの認証は事前に済ませておいてください。

> [gh auth login](https://cli.github.com/manual/gh_auth_login)

`git clone`しているリポジトリのルートパスで、次のコマンドを実行してください。マークダウンのテーブル形式で、スケジュール実行しているワークフロー名、ファイル名、スケジュール、最終コミットユーザーを表示します。マークダウンで出力されるので、README.mdに貼ってもいいし、社内Wikiにそのまま貼り付けることができます。これで退職者に影響される問題がでるか事前対処できます。

```sh
echo "| Workflow | File Name | Schedule (UTC) | Last Commit by |"
echo "| ---- | ---- | ---- | ---- |"
repo=$(gh repo view --json owner,name -q ".owner.login + \"/\" + .name")
json=$(gh workflow list --json name,path,state --limit 300)
echo "$json" | jq -c '.[] | select(.state == "active") | {name: .name, path: .path}' | sort | while read -r item; do
  name=$(echo "$item" | jq -r '.name')
  path=$(echo "$item" | jq -r '.path')
  if [[ ! -f "$path" ]]; then continue; fi
  schedule=$(cat "$path" | yq -o=json | jq -r 'select(.on.schedule != null) | [.on.schedule[].cron] | join("<br/>")')
  if [[ -z "$schedule" ]]; then continue; fi
  commiter=$(gh api -X GET "repos/${repo}/commits" -f path="$path" -F per_page=1 | jq -r ".[].committer.login")
  echo "| $name | $path | $schedule | $commiter |"
done
```

例えば[guitarrapc/githubactions-lab](https://github.com/guitarrapc/githubactions-lab)で実行すると次のように表示されます。

```markdown
| Workflow | File Name | Schedule (UTC) | Last Commit by |
| ---- | ---- | ---- | ---- |
| action runner info | .github/workflows/actionrunner-info.yaml | 0 0 * * * | guitarrapc |
| actionlint | .github/workflows/actionlint.yaml | 0 0 * * * | guitarrapc |
| auto dump context | .github/workflows/auto-dump-context.yaml | 0 0 * * * | guitarrapc |
| context github | .github/workflows/context-github.yaml | 0 0 * * * | guitarrapc |
| dotnet lint | .github/workflows/dotnet-lint.yaml | 0 1 * * 1 | guitarrapc |
| dump context | .github/workflows/dump-context.yaml | 0 0 * * * | guitarrapc |
| schedule job | .github/workflows/schedule-job.yaml | 0 0 * * * | guitarrapc |
| stale | .github/workflows/stale.yaml | 0 0 * * * | guitarrapc |
```

# 無効化される問題にどう対応するのがいいのか

退職などユーザーをリポジトリ/Organizationから外すとこの問題がおこることを理解しておけば大きな問題にはなりにくいはずです。先のブログにも書いてある通り、退職フロー(コミッターの除外フロー)にGitHub Actionsで定期実行している最終コミッターかチェックすることを追加するだけで99％の問題は解決します。

この問題はGitHub Actionsの特性を理解して対処することで解決できるので、GitHub Actionsで定期実行している理由に振り返ってみるのもいいですね。[^2]

[^1]: ワークフロー一覧を取得して、そのファイルの最終コミットを取得して...と異なる操作が必要になるのでAPIアクセスできるツールを使いたくなる
[^2]: こういったサービスの理解不足を理由にほかのスケジュール基盤に移行するなら、そもそも他のスケジュール基盤でも似たような問題が発生するのではないでしょうか
