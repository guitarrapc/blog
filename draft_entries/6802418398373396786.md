---
Title: GitHub ActionsのCVE-2025-30066を受けたワークフローの変化
Category:
- CI/CD
Date: 2025-04-05T23:59:00+09:00
EditURL: https://blog.hatena.ne.jp/guitarrapc_tech/guitarrapc-tech.hatenablog.com/atom/entry/6802418398373396786
PreviewURL: https://tech.guitarrapc.com/draft/entry/Kc53P5y5ZmeEXucwetdqoul38bw
CustomPath: 2025/04/05/235900
Draft: true
---

2025年3月28日にあったtj-actionやreviewdogのセキュリティインシデント[CVE-2025-30066](https://nvd.nist.gov/vuln/detail/CVE-2025-30066)を受けて、GitHub Actionsワークフローの書き方が変えてしばらく経ちました。

今回はそのメモです。

[:contents]

# CVE-2025-30066の概要

[セキュリティインシデント](https://unit42.paloaltonetworks.com/github-actions-supply-chain-attack/)に詳しいですが、簡単に説明すると[spotbugs/sonar-findbugs](https://github.com/spotbugs/sonar-findbugs)を起点に[reviewdog/action-setup](https://github.com/reviewdog/action-setup)を経由して[tj-action/changed-files](https://github.com/tj-actions/changed-files)のリリースのほとんどが改ざんされました。改ざんコミットは、base64エンコードされたPythonのエクスプロイトコードを取得/実行するもので、GitHub Actionsのランナーで実行されると、GitHub Actionsのシークレットを取得してログ出力します。攻撃者の狙いは[coinbase/agentkit](https://github.com/coinbase/agentkit)だったようですが、tj-action/changed-filesの利用者が多く、影響範囲が広がりました。

分かりやすいユーザーインパクトは、tj-action/changed-filesのタグ指定で利用しているGitHub ActionsワークフローにてGitHub Actionsのランナーで利用しているシークレットがActionログに出力されます。プライベートリポジトリにおいてはCIログは外部から確認できないため限定的ですが、公開リポジトリにおいてはビルドログを第三者が確認できるためGitHub Actionsのシークレットが漏洩します。

なお、CVE発生時にGitHubは次の対応をしています。

* tj-action/changed-filesのリポジトリ/アクションを削除してワークフロー使用できないように変更
* アクションのすべてのリリースがクリーンアップ、悪意あるコードが含まれなくなってからリポジトリを復旧
* 悪意のあるユーザーjurkaofavak/randolzfowの削除
* Gistに公開されていたエクスプロイトで利用されたPythonコードの削除[^1]
* 各ユーザーのGitHub PATを期限切れに設定 (各ユーザーはPATを発行しなおしたはずです)

# CVE-2025-30066の影響を軽減するにはどうすればよいのか

CVE-2025-30066のようなGitHub Actionsのインシデントは今後も起こる可能性が高いです。GitHub Actionsはオープンソースであり誰でもアクションを作成できますし、メンテナのPATが漏洩して意図せず変更される可能性もあるでしょう。
利用者としては改めて認識したポイントは次の通りです。

1. アクションのタグ/リリースは書き換えられる可能性がある
3. 利用者のPersonal Access Token (PAT)やGITHUB Appはアクションで漏れる可能性がある
4. ワークフローやジョブに設定した環境変数はアクションによってCIログに書き出せる
5. ワークフローやジョブの権限が高いほどインパクトが大きい
6. パブリックリポジトリの`pull_request_target`イベントの利用はリスクが高い
7. コミットは別ユーザーで偽れる

利用者として軽減策を考えてみましたが、多いですね。優先度をつけないと大変ですが、静的解析ツールで自動検知できるものから対処していくと良さそうです。

* アクションはタグ/リリースではなくコミットSHAを指定する (pinactで対応可能)
* ワークフローに指定するPATやGITHUB Appは権限を最小限にする
* シークレットを環境変数に設定する場合、ステップの環境変数に設定する (ghalintで検出可能)
* ジョブごとに最小権限を設定する (ghalintで検出可能)
* リポジトリの自動アクショントークンのデフォルト権限を`write`から`read`に設定しなおす[^2]
* パブリックリポジトリで`pull_request_target`イベントは極力避ける (ghalint/zizmorで検出可能)
* Rulesetでコミット署名の必須化を検討する
* Rulesetでタグの更新・削除を禁止
* Rulesetでタグの作成可能なユーザーをorganization adminやrepository adminに限定する

# 事前準備としての静的解析ツール

真っ先に取り組むべきは静的解析ツールによる自動化です。リポジトリを複数管理していると手動でワークフローを調整するのは無理です。時間は有限なので、できるだけ自動化して見落としを防ぎつつ精度を高めましょう。

以下のツールを利用して、ワークフローの静的解析ができます。

| ツール名 | 説明 |
| --- | --- |
| [actionlint](https://github.com/rhysd/actionlint) | ワークフローの構文チェックとShellcheckなど |
| [ghalint](https://github.com/suzuki-shunsuke/ghalint) | ワークフローの簡易的なセキュリティチェック |
| [zizmor](https://github.com/woodruffw/zizmor) | ワークフローのより厳しいセキュリティチェック |

以下のツールを利用して、セキュリティプラクティスをワークフローに自動適用できます。

| ツール名 | 説明 |
| --- | --- |
| [pinact](https://github.com/suzuki-shunsuke/pinact) | タグやブランチ指定されたアクションをSHAに変換する |
| [disable-checkout-persist-credentials](https://github.com/suzuki-shunsuke/disable-checkout-persist-credentials) | checkoutアクションの`persist-credentials`を無効化する |

私のおすすめは、次の流れです。

1. pinactでSHAに変換する
2. disable-checkout-persist-credentialsで`checkout`アクションの`persist-credentials`を無効化する
3. actionlintを実行してワークフロー構文を標準化する
4. ghalintでセキュリティチェックを実行して、出てきたエラー/警告を修正する

## zizmorは厳しすぎるかも

zizmorはチェックが厳しすぎると感じたので、何をチェックしているか確認してから検討することにしました。修正してみて、これをあげられるのは特につらかったポイントを紹介します。

inputsの判定次第でそこまで厳しくする理由がないような...。

```yaml
# ❌: runでinputsを直接使おうとするとhigh levelのエラーが出る
- name: Output foo input
  shell: bash
  run: echo "foo is ${{ inputs.foo != '' && inputs.foo || env.FOO }}"

# ⭕: 環境変数にいれてから環境変数をrunで指定する。
- name: Output foo input
      shell: bash
      run: echo "foo is ${VALUE}"
      env:
        VALUE: ${{ inputs.foo != '' && inputs.foo || env.FOO }}
```

githubコンテキストの判定も厳しすぎると感じます。Issueタイトルはインジェクション余地があるのでまずいのは同意ですが、`event_name`でトラブル想定はちょっと思いつかないです。

```yaml
# ❌: event_nameを直接使おうとするとhigh levelのエラーが出る
- name: file names
  id: file
  run: echo "name=${{ github.event_name }}${{ github.event.action != '' && format('_{0}', github.event.action) || ''}}${{ github.event_name == 'push' && format('_{0}', github.ref_type) || ''}}" | tee -a "$GITHUB_OUTPUT"

# ⭕: 環境変数にいれてから環境変数をrunで指定する。
- name: file names
  id: file
  env:
    EVENT_NAME: ${{ github.event_name }}
    EVENT_ACTION: ${{ github.event.action }}
    REF_TYPE: ${{ github.ref_type }}
  run: |
    ACTION_PART=""
    if [ -n "$EVENT_ACTION" ]; then
      ACTION_PART="_${EVENT_ACTION}"
    fi

    REF_PART=""
    if [ "$EVENT_NAME" = "push" ]; then
      REF_PART="_${REF_TYPE}"
    fi

    FILENAME="${EVENT_NAME}${ACTION_PART}${REF_PART}"
    echo "name=$FILENAME" | tee -a "$GITHUB_OUTPUT"
```

一方で、再利用可能なワークフローで`secrets: inherit`をエラーにするのは割といい指摘に感じます。ついやっちゃいがちですが、パブリックなリポジトリではsecretsをちゃんと明示するほうがいいでしょう。

```yaml
# ❌: secretsをinheritにするとmedium levelのエラーが出る
jobs:
  call-workflow-passing-data:
    uses: ./.github/workflows/_reusable-workflow-called.yaml
    with:
      username: ${{ inputs.username }}
      is-valid: ${{ inputs.is-valid }}
    secrets: inherit

# ⭕: secretsを明示する
jobs:
  call-workflow-passing-data:
    uses: ./.github/workflows/_reusable-workflow-called.yaml
    with:
      username: ${{ inputs.username }}
      is-valid: ${{ inputs.is-valid }}
    secrets:
      APPLES: ${{ secrets.APPLES }}
```

また、actions/checkoutで`persist-credentials: false`が指定されていないとエラーにするのもいい感じです。

```yaml
# ❌: persist-credentialsがtrueだとmedium levelのエラーが出る
- uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

# ⭕: persist-credentialsがfalseだとエラーにならない
- uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
  with:
    persist-credentials: false
```

# 参考

* [NVD - CVE-2025-30066](https://nvd.nist.gov/vuln/detail/CVE-2025-30066)
* [GitHub Actions Supply Chain Attack: A Targeted Attack on Coinbase Expanded to the Widespread tj-actions/changed-files Incident: Threat Assessment (Updated 4/2)](https://unit42.paloaltonetworks.com/github-actions-supply-chain-attack/)
* [Semgrep | 🚨 Popular GitHub Action tj-actions/changed-files is compromised](https://semgrep.dev/blog/2025/popular-github-action-tj-actionschanged-files-is-compromised/)
* [Harden-Runner detection: tj-actions/changed-files action is compromised - StepSecurity](https://www.stepsecurity.io/blog/harden-runner-detection-tj-actions-changed-files-action-is-compromised)



* [tj-actions のインシデントレポートを読んだ](https://zenn.dev/shunsuke_suzuki/articles/tj-actions-incident-2025#fork-network-%E3%81%AE%E6%82%AA%E7%94%A8)
* [GitHub のセキュリティ改善](https://zenn.dev/shunsuke_suzuki/articles/github-security-2025)
* [GitHub Actions を静的検査するツールの紹介 (actionlint/ghalint/zizmor)](https://zenn.dev/kou_pg_0131/articles/gha-static-checker)


[^1]: https://gist.githubusercontent.com/nikitastupin/30e525b776c409e03c2d6f328f254965/raw/memdump.py
[^2]: 新しいリポジトリを作るとデフォルト`read`ですが、以前からのリポジトリはデフォルト`write`になっています
