---
Title: プロジェクトで参照しているNuGetパッケージのライセンス一覧を取得する
Category:
- C#
- .NET
EditURL: https://blog.hatena.ne.jp/guitarrapc_tech/guitarrapc-tech.hatenablog.com/atom/entry/6802418398321492319
PreviewURL: https://tech.guitarrapc.com/draft/entry/lAXZSvLWmVsMokhrQVscapckl6s
Draft: false
CustomPath: 2025/01/18/235900
---

C#プロジェクトで参照しているNuGetパッケージのライセンス一覧を取得する方法が気になって調べたので紹介します。

[:contents]

## ライセンス一覧を取得する方法

ライセンス一覧確認としては、dotnet cliのNuGetパッケージ一覧機能を使うかOSSツールという選択があります。一通り触った感じだと、CycloneDX/cyclonedx-dotnetが一番使いやすかったのですがそれぞれみてみましょう。

* `dotnet list package`コマンドを使って個別にライセンスをチェック
* [sensslen/nuget-license](https://github.com/sensslen/nuget-license)を使う
* [aaronpowell/dotnet-delice](https://github.com/aaronpowell/dotnet-delice)を使う
* [CycloneDX/cyclonedx-dotnet](https://github.com/CycloneDX/cyclonedx-dotnet)を使う

## dotnet list packageとNuGet APIを使う

dotnet cliはNuGetパッケージの一覧を取得する`dotnet list package`コマンドがあります。これを使ってライセンス一覧を取得できます。ほかのツールと違って、Directory.Packages.propsも問題なく動作するのが保障されているので、割と素直に使えるのがいいですね。

まずは対象のソリューションルートで、パッケージ一覧をjsonで出力します。`--include-transitive`でパッケージの依存パッケージまでさかのぼれるので、依存パッケージも含めたライセンス一覧を取得できます。

```sh
dotnet list package --include-transitive --format json > output.json
# あとはjsonを解析
```

JSONでファイルは以下のような感じです。

<details><summary>JSONの例</summary>

```json
{
  "version": 1,
  "parameters": "--include-transitive",
  "problems": [
    {
      "level": "warning",
      "text": "(A) : Auto-referenced package."
    }
  ],
  "projects": [
    {
      "path": "D:/github/guitarrapc/csharp-lab/src/LinuxBuild/ClassLibrary/ClassLibrary.csproj",
      "frameworks": [
        {
          "framework": "net9.0"
        }
      ]
    },
    {
      "path": "D:/github/guitarrapc/csharp-lab/src/LinuxBuild/ConsoleApp/ConsoleApp.csproj",
      "frameworks": [
        {
          "framework": "net9.0"
        }
      ]
    },
    {
      "path": "D:/github/guitarrapc/csharp-lab/src/LinuxBuild/GrpcService/GrpcService.csproj",
      "frameworks": [
        {
          "framework": "net9.0",
          "topLevelPackages": [
            {
              "id": "Grpc.AspNetCore",
              "requestedVersion": "2.67.0",
              "resolvedVersion": "2.67.0"
            }
          ],
          "transitivePackages": [
            {
              "id": "Google.Protobuf",
              "resolvedVersion": "3.27.0"
            },
            {
              "id": "Grpc.AspNetCore.Server",
              "resolvedVersion": "2.67.0"
            },
            {
              "id": "Grpc.AspNetCore.Server.ClientFactory",
              "resolvedVersion": "2.67.0"
            },
            {
              "id": "Grpc.Core.Api",
              "resolvedVersion": "2.67.0"
            },
            {
              "id": "Grpc.Net.Client",
              "resolvedVersion": "2.67.0"
            },
            {
              "id": "Grpc.Net.ClientFactory",
              "resolvedVersion": "2.67.0"
            },
            {
              "id": "Grpc.Net.Common",
              "resolvedVersion": "2.67.0"
            },
            {
              "id": "Grpc.Tools",
              "resolvedVersion": "2.67.0"
            },
            {
              "id": "Microsoft.Extensions.DependencyInjection",
              "resolvedVersion": "6.0.0"
            },
            {
              "id": "Microsoft.Extensions.DependencyInjection.Abstractions",
              "resolvedVersion": "6.0.0"
            },
            {
              "id": "Microsoft.Extensions.Http",
              "resolvedVersion": "6.0.0"
            },
            {
              "id": "Microsoft.Extensions.Logging",
              "resolvedVersion": "6.0.0"
            },
            {
              "id": "Microsoft.Extensions.Logging.Abstractions",
              "resolvedVersion": "6.0.0"
            },
            {
              "id": "Microsoft.Extensions.Options",
              "resolvedVersion": "6.0.0"
            },
            {
              "id": "Microsoft.Extensions.Primitives",
              "resolvedVersion": "6.0.0"
            },
            {
              "id": "System.Diagnostics.DiagnosticSource",
              "resolvedVersion": "6.0.0"
            },
            {
              "id": "System.Runtime.CompilerServices.Unsafe",
              "resolvedVersion": "6.0.0"
            }
          ]
        }
      ]
    },
  ]
}
```

</details>

出力されたjsonを解析して、NuGet APIからライセンスを取得すれば一覧化できるのでサクッと用意します。

<details><summary>JSONを解析してライセンス一覧取得するC#コード</summary>

```cs
using System.Collections.Concurrent;
using System.Text.Json;
using System.Text.Json.Serialization;
using System.Xml.Linq;

var path = @"D:\github\guitarrapc\csharp-lab\output.json";
var bytes = File.ReadAllText(path);
var packages = JsonSerializer.Deserialize<DotnetCliListPackages>(bytes);
ArgumentNullException.ThrowIfNull(packages);
var licenses = new ConcurrentBag<DotnetLicense>();
var nugetLicense = new NuGetLicense();
foreach (var project in packages.Projects)
{
    var Name = project.Path;
    foreach (var framework in project.Frameworks)
    {
        if (framework.TopLevelPackages is not null)
        {
            foreach (var x in framework.TopLevelPackages)
            {
                var licenseInfo = new DotnetLicense
                {
                    Path = Name,
                    LicenseInfo = new PackageInfo
                    {
                        Id = x.Id,
                        Version = x.ResolvedVersion,
                        License = await nugetLicense.GetNuGetLicenseAsync(x.Id, x.ResolvedVersion),
                        IsTransitivePackage = false,
                    }
                };
                licenses.Add(licenseInfo);
            }
        }
        if (framework.TransitivePackages is not null)
        {
            await Parallel.ForEachAsync(framework.TransitivePackages, new ParallelOptions { MaxDegreeOfParallelism = 3 }, async (x, _) =>
            {
                var licenseInfo = new DotnetLicense
                {
                    Path = Name,
                    LicenseInfo = new PackageInfo
                    {
                        Id = x.Id,
                        Version = x.ResolvedVersion,
                        License = await nugetLicense.GetNuGetLicenseAsync(x.Id, x.ResolvedVersion),
                        IsTransitivePackage = true,
                    }
                };
                // debugger checker
                if (licenseInfo.LicenseInfo.License == "")
                {
                    var debuggerLine = "";
                }
                licenses.Add(licenseInfo);
            });
        }
    }
}

Console.WriteLine("# Show all NuGet Packages with Project Path");
// licenses.Dump();
OutputMarkdown(licenses);

Console.WriteLine("");
Console.WriteLine("# Show only NuGet Packages");
var licenseOnly = licenses
    .Select(x => x.LicenseInfo)
    .DistinctBy(x => x.Id + x.Version)
    .OrderBy(x => x.Id);
OutputMarkdown2(licenseOnly);

static void OutputMarkdown(IEnumerable<DotnetLicense> licenses)
{
    Console.WriteLine($"""
        | Path | Id | Version | License | IsTransitive |
        | --- | --- | --- | --- | --- |
        """);
    foreach (var license in licenses)
    {
        Console.WriteLine($"| {license.Path} | {license.LicenseInfo.Id} | {license.LicenseInfo.Version} | {license.LicenseInfo.License} | {license.LicenseInfo.IsTransitivePackage} |");
    }
}

static void OutputMarkdown2(IEnumerable<PackageInfo> licenses)
{
    Console.WriteLine($"""
        | Id | Version | License |
        | --- | --- | --- |
        """);
    foreach (var license in licenses)
    {
        Console.WriteLine($"| {license.Id} | {license.Version} | {license.License} |");
    }
}

// var result = await NuGetLicense.GetNuGetLicenseAsync("Grpc.AspNetCore", "2.67.0");
//result.Dump();
public class NuGetLicense
{
    private readonly HttpClient httpClient = new HttpClient();
    private readonly XNamespace ns2013 = "http://schemas.microsoft.com/packaging/2013/05/nuspec.xsd";
    private readonly XNamespace ns2012 = "http://schemas.microsoft.com/packaging/2012/06/nuspec.xsd";
    private readonly XNamespace ns2011 = "http://schemas.microsoft.com/packaging/2011/08/nuspec.xsd";

    private readonly ConcurrentDictionary<string, string> cache = new();

    public async Task<string> GetNuGetLicenseAsync(string packageId, string version)
    {
        var cacheKey = packageId + "-" + version;
        if (cache.TryGetValue(cacheKey, out var license))
        {
            Console.WriteLine($"{cacheKey}: use cache");
            return license;
        }
        else
        {
            // NuGet API Format
            // https://api.nuget.org/v3-flatcontainer/{package-id}/{version}/{package-id}.nuspec
            var response = await httpClient.GetStringAsync($"https://api.nuget.org/v3-flatcontainer/{packageId}/{version}/{packageId}.nuspec");
            var doc = XDocument.Parse(response);
            // doc.Dump(); // for debug
            var licenseValue = doc.Descendants(ns2013 + "metadata")
                .Select(x => x?.Element(ns2013 + "license")?.Value)
                .FirstOrDefault()
                ?? doc.Descendants(ns2012 + "metadata")
                    .Select(x => x?.Element(ns2012 + "license")?.Value)
                    .FirstOrDefault()
                    ?? doc.Descendants(ns2011 + "metadata")
                    .Select(x => x?.Element(ns2011 + "license")?.Value)
                    .FirstOrDefault();
            if (licenseValue is null)
            {
                var licenseUrl = doc.Descendants(ns2013 + "metadata")
                    .Select(x => x?.Element(ns2013 + "licenseUrl")?.Value)
                    .FirstOrDefault()
                    ?? doc.Descendants(ns2012 + "metadata")
                        .Select(x => x?.Element(ns2012 + "licenseUrl")?.Value)
                        .FirstOrDefault()
                        ?? doc.Descendants(ns2011 + "metadata")
                        .Select(x => x?.Element(ns2011 + "licenseUrl")?.Value)
                        .FirstOrDefault();
                licenseValue = "http://go.microsoft.com/fwlink/?LinkId=329770";
            }
            var value = licenseValue ?? "";
            cache.TryAdd(cacheKey, value);
            return value;
        }
    }
}

public record DotnetLicense
{
    public required string Path { get; init; }
    public required PackageInfo LicenseInfo { get; init; }
}
public record PackageInfo
{
    public required string Id { get; init; }
    public required string Version { get; init; }
    public required string License { get; init; }
    public required bool IsTransitivePackage { get; init; }
}

public record DotnetCliListPackages
{
    [JsonPropertyName("projects")]
    public required DotnetCliProjects[] Projects { get; init; }
}

public record DotnetCliProjects
{
    [JsonPropertyName("path")]
    public required string Path { get; init; }
    [JsonPropertyName("frameworks")]
    public required DotnetCliFrameworks[] Frameworks { get; init; }
}

public record DotnetCliFrameworks
{
    [JsonPropertyName("topLevelPackages")]
    public DotnetCliPackageInfo[]? TopLevelPackages { get; init; }

    [JsonPropertyName("transitivePackages")]
    public DotnetCliPackageInfo[]? TransitivePackages { get; init; }
}

public record DotnetCliPackageInfo
{
    [JsonPropertyName("id")]
    public required string Id { get; init; }
    [JsonPropertyName("resolvedVersion")]
    public required string ResolvedVersion { get; init; }
}
```

</details>

マークダウンで出力するので、GitHubのIssueやWikiに貼り付けるといい感じに表示できます。

![image](https://github.com/user-attachments/assets/e4155f9e-ad35-4cf9-975c-b6497a980c1e)


Gistを用意したので、試してみてください。

> [Export NuGet Packages referenced in C# Solution, then list Licenses. - Gist](https://gist.github.com/guitarrapc/28184725cde9d59f51dc655bf84642f9)

## sensslen/nuget-licenseを使う

dotnet global toolとしてnuget-licenseをインストールして使うことができます。

```sh
dotnet tool install --global nuget-license
```

Package一覧はコマンド一発で出力できるので便利です。デフォルトはテーブル表示ですが、jsonに切り替えると解析しやすいのでおすすめです。

```sh
nuget-license -i Csharp-lab.sln --output json
```

出力はコンソールに表示されます。これも便利ですね。

<details><summary>JSON出力の例</summary>

```json
[{"PackageId":"BenchmarkDotNet","PackageVersion":"0.14.0","PackageProjectUrl":"https://github.com/dotnet/BenchmarkDotNet","Copyright":".NET Foundation and contributors","Authors":".NET Foundation and contributors","License":"MIT","LicenseUrl":"https://licenses.nuget.org/MIT","LicenseInformationOrigin":0},{"PackageId":"coverlet.collector","PackageVersion":"6.0.2","PackageProjectUrl":"https://github.com/coverlet-coverage/coverlet","Authors":"tonerdo","License":"MIT","LicenseUrl":"https://licenses.nuget.org/MIT","LicenseInformationOrigin":0},{"PackageId":"FluentAssertions","PackageVersion":"7.0.0","PackageProjectUrl":"https://www.fluentassertions.com/","Copyright":"Copyright Dennis Doomen 2010-2024","Authors":"Dennis Doomen,Jonas Nyrup","License":"Apache-2.0","LicenseUrl":"https://licenses.nuget.org/Apache-2.0","LicenseInformationOrigin":0},{"PackageId":"GitHubActionsTestLogger","PackageVersion":"2.4.1","PackageProjectUrl":"https://github.com/Tyrrrz/GitHubActionsTestLogger","Copyright":"Copyright (C) Oleksii Holub","Authors":"Tyrrrz","License":"MIT","LicenseUrl":"https://licenses.nuget.org/MIT","LicenseInformationOrigin":0},{"PackageId":"Grpc.AspNetCore","PackageVersion":"2.67.0","PackageProjectUrl":"https://github.com/grpc/grpc-dotnet","Copyright":"Copyright 2019 The gRPC Authors","Authors":"The gRPC Authors","License":"Apache-2.0","LicenseUrl":"https://licenses.nuget.org/Apache-2.0","LicenseInformationOrigin":0},{"PackageId":"Grpc.AspNetCore.HealthChecks","PackageVersion":"2.67.0","PackageProjectUrl":"https://github.com/grpc/grpc-dotnet","Copyright":"Copyright 2019 The gRPC Authors","Authors":"The gRPC Authors","License":"Apache-2.0","LicenseUrl":"https://licenses.nuget.org/Apache-2.0","LicenseInformationOrigin":0},{"PackageId":"Grpc.AspNetCore.Server.Reflection","PackageVersion":"2.67.0","PackageProjectUrl":"https://github.com/grpc/grpc-dotnet","Copyright":"Copyright 2019 The gRPC Authors","Authors":"The gRPC Authors","License":"Apache-2.0","LicenseUrl":"https://licenses.nuget.org/Apache-2.0","LicenseInformationOrigin":0},{"PackageId":"IPNetwork2","PackageVersion":"3.0.667","PackageProjectUrl":"https://github.com/lduchosal/ipnetwork","Copyright":"Copyright 2022","Authors":"Luc Dvchosal","License":"https://github.com/lduchosal/ipnetwork/blob/master/LICENSE","LicenseUrl":"https://github.com/lduchosal/ipnetwork/blob/master/LICENSE","LicenseInformationOrigin":1},{"PackageId":"MemoryPack","PackageVersion":"1.21.3","PackageProjectUrl":"https://github.com/Cysharp/MemoryPack","Copyright":"\u00A9 Cysharp, Inc.","Authors":"Cysharp","License":"MIT","LicenseUrl":"https://licenses.nuget.org/MIT","LicenseInformationOrigin":0},{"PackageId":"Microsoft.AspNetCore.Components.WebAssembly","PackageVersion":"9.0.0","PackageProjectUrl":"https://asp.net/","Copyright":"\u00A9 Microsoft Corporation. All rights reserved.","Authors":"Microsoft","License":"MIT","LicenseUrl":"https://licenses.nuget.org/MIT","LicenseInformationOrigin":0},{"PackageId":"Microsoft.AspNetCore.Components.WebAssembly.DevServer","PackageVersion":"9.0.0","PackageProjectUrl":"https://asp.net/","Copyright":"\u00A9 Microsoft Corporation. All rights reserved.","Authors":"Microsoft","License":"MIT","LicenseUrl":"https://licenses.nuget.org/MIT","LicenseInformationOrigin":0},{"PackageId":"Microsoft.AspNetCore.OpenApi","PackageVersion":"9.0.0","PackageProjectUrl":"https://asp.net/","Copyright":"\u00A9 Microsoft Corporation. All rights reserved.","Authors":"Microsoft","License":"MIT","LicenseUrl":"https://licenses.nuget.org/MIT","LicenseInformationOrigin":0},{"PackageId":"Microsoft.CodeAnalysis.Analyzers","PackageVersion":"3.3.4","PackageProjectUrl":"https://github.com/dotnet/roslyn-analyzers","Copyright":"\u00A9 Microsoft Corporation. All rights reserved.","Authors":"Microsoft","License":"MIT","LicenseUrl":"https://licenses.nuget.org/MIT","LicenseInformationOrigin":0},{"PackageId":"Microsoft.CodeAnalysis.Common","PackageVersion":"4.11.0","PackageProjectUrl":"https://github.com/dotnet/roslyn","Copyright":"\u00A9 Microsoft Corporation. All rights reserved.","Authors":"Microsoft","License":"MIT","LicenseUrl":"https://licenses.nuget.org/MIT","LicenseInformationOrigin":0},{"PackageId":"Microsoft.CodeAnalysis.CSharp","PackageVersion":"4.11.0","PackageProjectUrl":"https://github.com/dotnet/roslyn","Copyright":"\u00A9 Microsoft Corporation. All rights reserved.","Authors":"Microsoft","License":"MIT","LicenseUrl":"https://licenses.nuget.org/MIT","LicenseInformationOrigin":0},{"PackageId":"Microsoft.CodeAnalysis.CSharp.SourceGenerators.Testing.XUnit","PackageVersion":"1.1.2","PackageProjectUrl":"https://github.com/dotnet/roslyn-sdk","Copyright":"\u00A9 Microsoft Corporation. All rights reserved.","Authors":"Microsoft","License":"MIT","LicenseUrl":"https://licenses.nuget.org/MIT","LicenseInformationOrigin":0},{"PackageId":"Microsoft.CodeAnalysis.CSharp.Workspaces","PackageVersion":"4.11.0","PackageProjectUrl":"https://github.com/dotnet/roslyn","Copyright":"\u00A9 Microsoft Corporation. All rights reserved.","Authors":"Microsoft","License":"MIT","LicenseUrl":"https://licenses.nuget.org/MIT","LicenseInformationOrigin":0},{"PackageId":"Microsoft.EntityFrameworkCore","PackageVersion":"9.0.0","PackageProjectUrl":"https://docs.microsoft.com/ef/core/","Copyright":"\u00A9 Microsoft Corporation. All rights reserved.","Authors":"Microsoft","License":"MIT","LicenseUrl":"https://licenses.nuget.org/MIT","LicenseInformationOrigin":0},{"PackageId":"Microsoft.EntityFrameworkCore.Analyzers","PackageVersion":"9.0.0","PackageProjectUrl":"https://docs.microsoft.com/ef/core/","Copyright":"\u00A9 Microsoft Corporation. All rights reserved.","Authors":"Microsoft","License":"MIT","LicenseUrl":"https://licenses.nuget.org/MIT","LicenseInformationOrigin":0},{"PackageId":"Microsoft.EntityFrameworkCore.Design","PackageVersion":"9.0.0","PackageProjectUrl":"https://docs.microsoft.com/ef/core/","Copyright":"\u00A9 Microsoft Corporation. All rights reserved.","Authors":"Microsoft","License":"MIT","LicenseUrl":"https://licenses.nuget.org/MIT","LicenseInformationOrigin":0},{"PackageId":"Microsoft.EntityFrameworkCore.Relational","PackageVersion":"9.0.0","PackageProjectUrl":"https://docs.microsoft.com/ef/core/","Copyright":"\u00A9 Microsoft Corporation. All rights reserved.","Authors":"Microsoft","License":"MIT","LicenseUrl":"https://licenses.nuget.org/MIT","LicenseInformationOrigin":0},{"PackageId":"Microsoft.EntityFrameworkCore.Sqlite","PackageVersion":"9.0.0","PackageProjectUrl":"https://docs.microsoft.com/ef/core/","Copyright":"\u00A9 Microsoft Corporation. All rights reserved.","Authors":"Microsoft","License":"MIT","LicenseUrl":"https://licenses.nuget.org/MIT","LicenseInformationOrigin":0},{"PackageId":"Microsoft.Extensions.Caching.StackExchangeRedis","PackageVersion":"9.0.0","PackageProjectUrl":"https://asp.net/","Copyright":"\u00A9 Microsoft Corporation. All rights reserved.","Authors":"Microsoft","License":"MIT","LicenseUrl":"https://licenses.nuget.org/MIT","LicenseInformationOrigin":0},{"PackageId":"Microsoft.Extensions.Hosting","PackageVersion":"9.0.0","PackageProjectUrl":"https://dot.net/","Copyright":"\u00A9 Microsoft Corporation. All rights reserved.","Authors":"Microsoft","License":"MIT","LicenseUrl":"https://licenses.nuget.org/MIT","LicenseInformationOrigin":0},{"PackageId":"Microsoft.Extensions.Logging","PackageVersion":"9.0.0","PackageProjectUrl":"https://dot.net/","Copyright":"\u00A9 Microsoft Corporation. All rights reserved.","Authors":"Microsoft","License":"MIT","LicenseUrl":"https://licenses.nuget.org/MIT","LicenseInformationOrigin":0},{"PackageId":"Microsoft.Extensions.ObjectPool","PackageVersion":"9.0.0","PackageProjectUrl":"https://asp.net/","Copyright":"\u00A9 Microsoft Corporation. All rights reserved.","Authors":"Microsoft","License":"MIT","LicenseUrl":"https://licenses.nuget.org/MIT","LicenseInformationOrigin":0},{"PackageId":"Microsoft.NET.ILLink.Tasks","PackageVersion":"9.0.0","PackageProjectUrl":"https://dot.net/","Copyright":"\u00A9 Microsoft Corporation. All rights reserved.","Authors":"Microsoft","License":"MIT","LicenseUrl":"https://licenses.nuget.org/MIT","LicenseInformationOrigin":0},{"PackageId":"Microsoft.NET.Sdk.WebAssembly.Pack","PackageVersion":"9.0.0","PackageProjectUrl":"https://dot.net/","Copyright":"\u00A9 Microsoft Corporation. All rights reserved.","Authors":"Microsoft","License":"MIT","LicenseUrl":"https://licenses.nuget.org/MIT","LicenseInformationOrigin":0},{"PackageId":"Microsoft.NET.Test.Sdk","PackageVersion":"17.12.0","PackageProjectUrl":"https://github.com/microsoft/vstest","Copyright":"\u00A9 Microsoft Corporation. All rights reserved.","Authors":"Microsoft","License":"MIT","LicenseUrl":"https://licenses.nuget.org/MIT","LicenseInformationOrigin":0},{"PackageId":"NETStandard.Library","PackageVersion":"2.0.3","PackageProjectUrl":"https://dot.net/","Copyright":".NET Foundation and Contributors","Authors":"Microsoft","License":"https://github.com/dotnet/standard/blob/master/LICENSE.TXT","LicenseUrl":"https://github.com/dotnet/standard/blob/master/LICENSE.TXT","LicenseInformationOrigin":1},{"PackageId":"Npgsql.EntityFrameworkCore.PostgreSQL","PackageVersion":"9.0.2","PackageProjectUrl":"https://github.com/npgsql/efcore.pg","Copyright":"Copyright 2024 \u00A9 The Npgsql Development Team","Authors":"Shay Rojansky,Austin Drenski,Yoh Deadfall","License":"PostgreSQL","LicenseUrl":"https://licenses.nuget.org/PostgreSQL","LicenseInformationOrigin":0},{"PackageId":"Pomelo.EntityFrameworkCore.MySql","PackageVersion":"9.0.0-preview.2.efcore.9.0.0","PackageProjectUrl":"https://github.com/PomeloFoundation/Pomelo.EntityFrameworkCore.MySql","Copyright":"Copyright 2024 \u00A9 Pomelo Foundation","Authors":"Laurents Meyer, Caleb Lloyd, Yuko Zheng","License":"MIT","LicenseUrl":"https://licenses.nuget.org/MIT","LicenseInformationOrigin":0},{"PackageId":"StackExchange.Redis","PackageVersion":"2.8.22","PackageProjectUrl":"https://stackexchange.github.io/StackExchange.Redis/","Copyright":"2014 - 2024 Stack Exchange, Inc.","Authors":"Stack Exchange, Inc.,Marc Gravell,Nick Craver","License":"MIT","LicenseUrl":"https://licenses.nuget.org/MIT","LicenseInformationOrigin":0},{"PackageId":"Swashbuckle.AspNetCore","PackageVersion":"7.2.0","PackageProjectUrl":"https://github.com/domaindrivendev/Swashbuckle.AspNetCore","Authors":"domaindrivendev","License":"MIT","LicenseUrl":"https://licenses.nuget.org/MIT","LicenseInformationOrigin":0},{"PackageId":"System.IO.Hashing","PackageVersion":"9.0.0","PackageProjectUrl":"https://dot.net/","Copyright":"\u00A9 Microsoft Corporation. All rights reserved.","Authors":"Microsoft","License":"MIT","LicenseUrl":"https://licenses.nuget.org/MIT","LicenseInformationOrigin":0},{"PackageId":"xRetry","PackageVersion":"1.9.0","PackageProjectUrl":"https://github.com/JoshKeegan/xRetry","Copyright":"Copyright Josh Keegan 2019-2023","Authors":"Josh Keegan","License":"MIT","LicenseUrl":"https://licenses.nuget.org/MIT","LicenseInformationOrigin":0},{"PackageId":"xunit","PackageVersion":"2.9.2","Copyright":"Copyright (C) .NET Foundation","Authors":"jnewkirk,bradwilson","License":"Apache-2.0","LicenseUrl":"https://licenses.nuget.org/Apache-2.0","LicenseInformationOrigin":0},{"PackageId":"xunit.runner.visualstudio","PackageVersion":"2.8.2","Copyright":"Copyright (C) .NET Foundation","Authors":"jnewkirk,bradwilson","License":"Apache-2.0","LicenseUrl":"https://licenses.nuget.org/Apache-2.0","LicenseInformationOrigin":0},{"PackageId":"ZLogger","PackageVersion":"2.5.9","PackageProjectUrl":"https://github.com/Cysharp/ZLogger","Copyright":"\u00A9 Cysharp, Inc.","Authors":"Cysharp","License":"MIT","LicenseUrl":"https://licenses.nuget.org/MIT","LicenseInformationOrigin":0}]
```

</details>


## aaronpowell/dotnet-deliceを使う

dotnet global toolとしてdotnet-deliceをインストールして使うことができます。

```sh
dotnet tool install -g dotnet-delice
```

Package一覧はコマンド一発で出力できるので便利です。デフォルトはツリー表示ですが、jsonに切り替えると解析しやすいのでおすすめです。

```sh
$ dotnet-delice
Project Api.Shared
License Expression: BSD-3-Clause
├── There are 1 occurrences of BSD-3-Clause
├─┬ Conformance:
│ ├── Is OSI Approved: true
│ ├── Is FSF Free/Libre: true
│ └── Included deprecated IDs: false
└─┬ Packages:
  └── Google.Protobuf@3.27.0

License Expression: Apache-2.0
├── There are 8 occurrences of Apache-2.0
├─┬ Conformance:
│ ├── Is OSI Approved: true
│ ├── Is FSF Free/Libre: true

# json出力
$ dotnet-delice --json
```

出力はコンソールに表示されます。先ほどまでの表示と違って、プロジェクトごとにライセンスタイプでパッケージがまとめられます。これはこれで便利。

<details><summary>JSON出力の例</summary>

```json
{
  "projects": [
    {
      "projectName": "Api.Shared",
      "licenses": [
        {
          "expression": "BSD-3-Clause",
          "count": 1,
          "packages": [
            {
              "name": "Google.Protobuf",
              "version": "3.27.0",
              "url": "https://licenses.nuget.org/BSD-3-Clause",
              "displayName": "Google.Protobuf@3.27.0"
            }
          ],
          "isOsi": true,
          "isFsf": true,
          "isDeprecatedType": false
        },
        {
          "expression": "Apache-2.0",
          "count": 8,
          "packages": [
            {
              "name": "Grpc.AspNetCore",
              "version": "2.67.0",
              "url": "https://licenses.nuget.org/Apache-2.0",
              "displayName": "Grpc.AspNetCore@2.67.0"
            },
            {
              "name": "Grpc.AspNetCore.Server",
              "version": "2.67.0",
              "url": "https://licenses.nuget.org/Apache-2.0",
              "displayName": "Grpc.AspNetCore.Server@2.67.0"
            },
            {
              "name": "Grpc.AspNetCore.Server.ClientFactory",
              "version": "2.67.0",
              "url": "https://licenses.nuget.org/Apache-2.0",
              "displayName": "Grpc.AspNetCore.Server.ClientFactory@2.67.0"
            },
            {
              "name": "Grpc.Core.Api",
              "version": "2.67.0",
              "url": "https://licenses.nuget.org/Apache-2.0",
              "displayName": "Grpc.Core.Api@2.67.0"
            },
            {
              "name": "Grpc.Net.Client",
              "version": "2.67.0",
              "url": "https://licenses.nuget.org/Apache-2.0",
              "displayName": "Grpc.Net.Client@2.67.0"
            },
            {
              "name": "Grpc.Net.ClientFactory",
              "version": "2.67.0",
              "url": "https://licenses.nuget.org/Apache-2.0",
              "displayName": "Grpc.Net.ClientFactory@2.67.0"
            },
            {
              "name": "Grpc.Net.Common",
              "version": "2.67.0",
              "url": "https://licenses.nuget.org/Apache-2.0",
              "displayName": "Grpc.Net.Common@2.67.0"
            },
            {
              "name": "Grpc.Tools",
              "version": "2.67.0",
              "url": "https://licenses.nuget.org/Apache-2.0",
              "displayName": "Grpc.Tools@2.67.0"
            }
          ],
          "isOsi": true,
          "isFsf": true,
          "isDeprecatedType": false
        },
        {
          "expression": "MIT",
          "count": 9,
```

</details>

## CycloneDX/cyclonedx-dotnetを使う

dotnet global toolとしてnuget-licenseをインストールして使うことができます。

```sh
dotnet tool install --global CycloneDX
```

他のツールと違って、cyclonedx-dotnetはbom形式で出力されます。

```sh
dotnet-cyclonedx Csharp-lab.sln
```

デフォルトはbom.xmlに出力されます。

<details><summary>BOMのXML出力の例</summary>

```xml
<?xml version="1.0" encoding="utf-8"?>
<bom xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:xsd="http://www.w3.org/2001/XMLSchema" serialNumber="urn:uuid:49d9ed4d-03a0-43fa-8140-2b6000b10d80" version="1" xmlns="http://cyclonedx.org/schema/bom/1.6">
  <metadata>
    <timestamp>2025-01-19T19:38:40.0926615Z</timestamp>
    <tools>
      <tool>
        <vendor>CycloneDX</vendor>
        <name>CycloneDX module for .NET</name>
        <version>4.2.0.0</version>
      </tool>
    </tools>
    <component type="application" bom-ref="Csharp-lab@0.0.0">
      <name>Csharp-lab</name>
      <version>0.0.0</version>
    </component>
  </metadata>
  <components>
    <component type="library" bom-ref="pkg:nuget/BenchmarkDotNet@0.14.0">
      <authors>
        <author>
          <name>.NET Foundation and contributors</name>
        </author>
      </authors>
      <name>BenchmarkDotNet</name>
      <version>0.14.0</version>
      <description>Powerful .NET library for benchmarking</description>
      <scope>required</scope>
      <hashes>
        <hash alg="SHA-512">14BAA1188A311697847A738CDC331DAD8365F40B46E950D683335E730A8EC685FF7D2A4D8E7F4EED19ADFE08D7B86A50E9B4ED4498F64886FE6AAC0D551A7E12</hash>
      </hashes>
      <licenses>
        <license>
          <id>MIT</id>
        </license>
      </licenses>
      <copyright>.NET Foundation and contributors</copyright>
      <purl>pkg:nuget/BenchmarkDotNet@0.14.0</purl>
      <externalReferences>
        <reference type="website">
          <url>https://github.com/dotnet/BenchmarkDotNet</url>
        </reference>
        <reference type="vcs">
          <url>https://github.com/dotnet/BenchmarkDotNet</url>
        </reference>
      </externalReferences>
    </component>
    <component type="library" bom-ref="pkg:nuget/BenchmarkDotNet.Annotations@0.14.0">
      <authors>
        <author>
          <name>.NET Foundation and contributors</name>
        </author>
      </authors>
      <name>BenchmarkDotNet.Annotations</name>
```

</details>

BOM出力はXMLなのであとは適当に解析すればできますね。

```cs
var path = @"D:\github\guitarrapc\csharp-lab\bom.xml";
XNamespace ns = "http://cyclonedx.org/schema/bom/1.6";
var xml = XDocument.Load(path);

// distinct license
Console.WriteLine("# Show License types used in Solution");
var licenses = xml.Descendants(ns + "component")
  .SelectMany(component => component.Descendants(ns + "license"))
  .Select(license => license.Element(ns + "id")?.Value)
  .Where(id => !string.IsNullOrEmpty(id))
  .Distinct();
// licenses.Dump();
OutputMarkdown(licenses);
Console.WriteLine("");

// package name and license
Console.WriteLine("# Show only NuGet Packages");
var licenseList = xml.Descendants(ns + "component")
  .Where(x => x.Attribute("type")?.Value == "library")
  .Select(x =>
  {
      var name = x.Element(ns + "name")?.Value;
      var version = x.Element(ns + "version")?.Value;
      var license = x.Descendants(ns + "license")
        .Select(license => license?.Element(ns + "id")?.Value)
        .FirstOrDefault()
        ?? x.Descendants(ns + "license")
        .Select(license => license?.Element(ns + "name")?.Value)
        .FirstOrDefault();
      var url = x.Descendants(ns + "license")
        .Select(license => license?.Element(ns + "url")?.Value)
        .FirstOrDefault();
      return new NuGetLicenseSummay(name, version, license, url);
  })
  .OrderBy(x => x.Name);
// licenseList.Dump();
OutputMarkdown2(licenseList);

static void OutputMarkdown(IEnumerable<string?> licenses)
{
    Console.WriteLine($"""
        | License |
        | --- |
        """);
    foreach (var license in licenses)
    {
        Console.WriteLine($"| {license} |");
    }
}
static void OutputMarkdown2(IEnumerable<NuGetLicenseSummay> licenses)
{
    Console.WriteLine($"""
        | Name | Version | License |
        | --- | --- | --- |
        """);
    foreach (var license in licenses)
    {
        Console.WriteLine($"| {license.Name} | {license.Version} | {license.License} |");
    }
}

public record NuGetLicenseSummay(string? Name, string? Version, string? License, string? Url);
```

Bom結果からライセンス部分を出力した例です。

![image](https://github.com/user-attachments/assets/586af19c-fb86-40c0-82d0-d255102f7e8d)

# 発展例

パッケージごとのライセンスが解析できれば、パッケージ更新時にライセンスが変わったことも検知できるようになります。ライセンスの変更は著作権にかかわる重要な情報ですが、現在のNuGetではVisual Studioで更新したり、.csprojやDependabotでバージョン更新したときに気づくことが困難です。

Github Actionsで定期的にライセンスを出力して、許可されていないライセンスが含まれていないかをチェックするなどの運用も考えられます。

# まとめ

dotnet cliにパッケージ出力機能がつく前は.csprojの解析が必要で面倒でしたが、今ならパッケージとバージョン一覧を出力できます。推移的解決されたパッケージも出力されるので、ライセンス一覧を取得するのも簡単です。

ツールを使っても、自分で解析しても便利なので使っていくのもいいでしょう。
