---
Title: NuGet Trusted PublishingでOIDCを使ってトークンレスでCIからNuGetパッケージを公開する
category:
- C#
Date: 2025-10-01T21:00:00+09:00
EditURL: https://blog.hatena.ne.jp/guitarrapc_tech/guitarrapc-tech.hatenablog.com/atom/entry/6802888565266579948
PreviewURL: https://tech.guitarrapc.com/draft/entry/UM5d2-dXFa767vmzDkqySM-KfMo
Draft: true
---

NuGet Trusted Publishingが2025年9月22日に公開され、OpenID Connect (OIDC)を使ってトークンレスでCIからNuGetパッケージを公開できるようになりました。

- [New Trusted Publishing enhances security on NuGet.org - .NET Blog](https://devblogs.microsoft.com/dotnet/enhanced-security-is-here-with-the-new-trust-publishing-on-nuget-org/)
- [Trusted Publishing on nuget.org - Microsoft Learn](https://learn.microsoft.com/en-us/nuget/nuget-org/trusted-publishing)

この記事は、NuGet Trusted Publishingを使ってGitHub ActionsからトークンレスでNuGetパッケージを公開する手順を解説します。

[:contents]

## NuGet Trusted Publishingとは

従来、NuGetパッケージを公開するには、APIキーを発行してdotnet nuget pushコマンドに渡す必要がありました。
このやり方はシンプルなのですが、複数の課題を抱えています。

- APIキーが長期間有効であるため、漏洩リスクが高い
- APIキーのローテーションが手動であり、運用コストが高い (最長1年)
- CI/CD環境にAPIキーを安全に保存する必要がある
- APIキーが漏れたらだれでもどこからでもパッケージを公開できてしまう

これらはNuGetに限らず、APIキーベースでパッケージを公開する多くのパッケージシステムで共通した課題といえます。

例えば利用者が特に多いnpmにおいては、パッケージ作者から詐取したAPIキーを使ってマルウェア入りパッケージが公開される事件は過去に何度も発生しています。
この課題に対するnpmをするGitHubの対策は、TOTPからPasskeyベースへの移行 (認証のフィッシング対策強化)、そしてOIDCを使ったトークンレスパッケージ公開です。

npmのTrusted Publishingが先行していているので、参考になる記事を紹介します

- [npm Trusted PublishingでOIDCを使ってトークンレスでCIからnpmパッケージを公開する](https://efcl.info/2025/09/07/npm-oidc/)

OIDCを使ったトークンレスパッケージ公開は、API管理を不要にするため以下のような利点があります。「手元からパッケージ公開せず、基本的にパッケージ公開はCI/CDからのみ行う」、という前提を置く限りかなり有効な手法といえます。

- APIキーが短時間のみ有効な自動発行されたトークンに置き換わるため、漏洩時のリスクが大幅に低減される
- ユーザーによるAPIキーローテーションが不要になる
- CI/CD環境にAPIキーを保存する必要がなくなる
- GitHub ActionsなどのOIDC対応CI/CD環境からのみパッケージを公開できるように制限できる

NuGet Trusted Publishingは、細かい違いはあるものの、おおむねnpm Trusted Publishingと同様の仕組みをNuGetに導入した考えて差し支えないでしょう。

OIDCを使った基本的な仕組みについては、業界で取り組んでいる[OpenSSFイニシアチブ]([OpenSSFイニシアチブ](https://repos.openssf.org/trusted-publishers-for-all-package-repositories))を参照してください。

![alt text](image.png)


## 対応CI/CD環境

現在、NuGet Trusted Publishingは以下のCI/CD環境に対応しています。他のCI/CD環境については、今後対応が追加される可能性があります。

- GitHub Actions

## 設定方法

次のステップでNuGet Trusted Publishingを設定します。

1. nuget.orgでTrusted Publishingを設定
2. CI/CDワークフローの設定
3. ワークフローを実行

### nuget.orgでTrusted Publishingを設定

### CI/CDワークフローの設定

### ワークフローを実行

## 制約

2025年10月1日時点で、Reusable WorkflowでNuGet/Loginを使った場合に、NuGetで登録したポリシーを見つけられないことを確認しています。

```
Error: Token exchange failed (401): No matching trust policy owned by user '***' was found.
```

Reusable Workflowを使わずに、直接ワークフローに記述する場合は問題ないので、こちらを利用することをお勧めします。

再現ワークフローは次の通り

```yaml
# `.github/workflows/nuget-push.yaml@main`
name: Push NuGet
on:
  workflow_call:

jobs:
  create-release:
    permissions:
      contents: write
      id-token: write # required for NuGet Trusted Publish
    runs-on: ubuntu-24.04
    timeout-minutes: 10
    steps:
      - name: NuGet login (OIDC → temp API key)
        uses: NuGet/login@d22cc5f58ff5b88bf9bd452535b4335137e24544 # v1.1.0
        id: login
        with:
          user: my-nuget-user
```

```yaml
# 呼び出し元ワークフロー
name: Build-Release

on:
  workflow_dispatch:

jobs:
  dummy:
    permissions:
      contents: write
      id-token: write # required for NuGet Trusted Publish
    uses: .github/workflows/nuget-push.yaml@main
```
