---
Title: xargsでコマンド実行時にinappropriate ioctl for deviceエラーが出る原因と対処
Category:
- Linux
EditURL: https://blog.hatena.ne.jp/guitarrapc_tech/guitarrapc-tech.hatenablog.com/atom/entry/6802418398325005998
PreviewURL: https://tech.guitarrapc.com/draft/entry/taI8EkJ--_bRfi4TcHdR6VXUAy8
---

コマンドを並列に実行したいときxargsは便利です。今回はxargsなしだとコマンドが実行できるのに、xargsの中でコマンド実行すると`inappropriate ioctl for device`エラーが出たのでその原因と対処についてメモします。

[:contents]

# 再現コード

次の環境下で発生しました。ただ、例えばviなどでも同様のエラーが生じます。

* aquaでインストールしたtenv
* tenvでインストールしたterraform
* argsの中でterraformを実行すると発生

再現コードです。

```sh
$ echo "foo" | xargs -I{} -P 1 -n1 bash -c "terraform --version"
Failure during terraform call : fork/exec /home/guitarrapc/.local/share/aquaproj-aqua/bin/tenv: inappropriate ioctl for device
```

aquaでインストールしたtenvが出していることがわかります。
この状況は、terraformを直接バイナリでインストールしているときには発生しません、またaqua移行前は生じてなかったことからtenvをバイナリインストールしているときにも発生しないようです。

# どのように対処するか

`inappropriate ioctl for device`というエラー自体は、ttyを必要とするプログラムでttyがないときに発生します。xargsは標準入力を受けると子プロセスに渡さないので、子プロセスがttyを必要とするとエラーが発生します。

このため、ほかのコマンドでもttyが必要ならこのエラーは発生します。

```sh
$ echo "sane" | xargs stty
stty: 'standard input': Inappropriate ioctl for device
```

対処法法は、xargsに`-o`を追加します。

```sh
$ xargs --help
  -o, --open-tty               Reopen stdin as /dev/tty in the child process
                                 before executing the command; useful to run an
                                 interactive application.
```

つまりこのようにします。

```sh
$ echo "foo" | xargs -I{} -o -P 1 -n1 bash -c "terraform --version"
Terraform v1.9.8
on linux_amd64

Your version of Terraform is out of date! The latest version
is 1.10.5. You can update by downloading from https://www.terraform.io/downloads.html
```

あるいはこう。

```sh
$ echo "sane" | xargs -o stty
```

# まとめ

aquaは`aqua-proxy`経由で実行するためか、似たような状況が別コマンドでも発生した記憶があります。
今回は対処する必要があったので、なるほどtty...しょうがないのですが、シンボリックリンクで取りまわすとこういうトラブルがまず発生せず好みです。
aquaにaqua-proxyを使わない別オプションがほしい気もするけど、それだと遅延インストール周りが機能しないだろうしコンセプト会わずで難しそうですね。
