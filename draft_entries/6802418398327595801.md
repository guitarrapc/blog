---
Title: C#のコード設定を.editorconfigで統一する
Category:
- C#
EditURL: https://blog.hatena.ne.jp/guitarrapc_tech/guitarrapc-tech.hatenablog.com/atom/entry/6802418398327595801
PreviewURL: https://tech.guitarrapc.com/draft/entry/FITfy2kSJOp7zB3WfIJBIzb-fHs
CustomPath: 2025/02/07/235900
Draft: true
---

.editorconfigは様々な言語でコードの設定を統一するための設定ファイルです。C#も.editorconfigを使うとコードフォーマットやアナライザーの設定できます。今回は私がこれまでC#で.editorconfigを使ってきておすすめ設定と避けたほうがいいと考えている設定を紹介します。

[:contents]

# おすすめ設定

リポジトリルートに配置するベース設定としての.editorconfigを示します。`charset`と`end_of_line`はOSや言語によって考慮が変わるため、その部分は適宜変更する必要があるため後段で補足説明します。

なお、[MicrosoftのC#のコード規約に合わせたルール設定](https://learn.microsoft.com/en-us/dotnet/fundamentals/code-analysis/code-style-rule-options)は含んでいませんが、これも.editorconfigで明示できますし個人のVS/Rider設定に依存しないのでオススメです。

```ini
root = true

# target to global files like .yaml, .json, .md, .gitignore and .gitattributes
[*]
# Change these settings to your own preference
indent_style = space
indent_size = 2

# We recommend you to keep these unchanged
end_of_line = lf
charset = utf-8
trim_trailing_whitespace = true
insert_final_newline = true

[*.cs]
indent_style = space
indent_size = 4

# Depends on your OS
end_of_line = unset # if you want to use git's default
# end_of_line = crlf # NOT RECOMEND, If you checkout on Windows
# end_of_line = lf # NOT RECOMEND, if you never checkout on Windows

# Depends on your language
charset = utf-8-bom # If you use Japanese, use utf-8-bom to avoid garbage character on git by shift-jis
# charset = utf-8 # If you use English only like OSS project

[*.{csproj,props}]
indent_style = space
indent_size = 2

[Dockerfile]
indent_style = space
indent_size = 4

[{appsettings.json,appsettings.*.json}]
indent_style = space
indent_size = 2

[*.cs]

# C# Standards
dotnet_diagnostic.CS1998.severity = none # This async method lacks 'await' operators and will run synchronously. Consider using the 'await' operator to await non-blocking API calls, or 'await Task.Run(...)' to do CPU-bound work on a background thread.

# Nullable Reference Types
dotnet_diagnostic.CS8618.severity = error # Non-nullable field is uninitialized. Consider declaring as nullable.
dotnet_diagnostic.CS8604.severity = error # Possible null reference argument.
dotnet_diagnostic.CS8629.severity = error # Nullable value type may be null.
dotnet_diagnostic.CS8600.severity = error # Converting null literal or possible null value to non-nullable type.
dotnet_diagnostic.CS8603.severity = error # Possible null reference return.
dotnet_diagnostic.CS8610.severity = error # Nullability of reference types in type of parameter doesn't match overridden member.
dotnet_diagnostic.CS8625.severity = error # Cannot convert null literal to non-nullable reference type.
dotnet_diagnostic.CS8606.severity = error # Possible null reference assignment to iteration variable
dotnet_diagnostic.CS8602.severity = error # Dereference of a possibly null reference.
dotnet_diagnostic.CS8601.severity = error # Possible null reference assignment.
dotnet_diagnostic.CS8614.severity = error # Nullability of reference types in type of parameter doesn't match implicitly implemented member.
dotnet_diagnostic.CS8765.severity = error # Nullability of type of parameter 'obj' doesn't match overridden member (possibly because of nullability attributes).
dotnet_diagnostic.CS8619.severity = error # Nullability of reference types in value of type 'GenericType<T?>' doesn't match target type 'GenericType<T>'.

# =================
# Analyzer Rulesets
# =================

# Microsoft.CodeAnalysis.BannedApiAnalyzers
dotnet_diagnostic.RS0030.severity = error # RS0030: Banned API

# Microsoft.VisualStudio.Threading.Analyzers
dotnet_diagnostic.VSTHRD100.severity = error # VSTHRD100: Avoid async void methods
dotnet_diagnostic.VSTHRD101.severity = error # VSTHRD101: Avoid unsupported async delegates
dotnet_diagnostic.VSTHRD110.severity = error # VSTHRD110: Observe result of async calls
dotnet_diagnostic.VSTHRD003.severity = none  # VSTHRD003 Avoid awaiting foreign Tasks

# =================
# Format Rulesets
# =================

# IDE0160: Convert to file-scoped namespace
csharp_style_namespace_declarations = file_scoped:warning

# Microsoft.Analyzers.ManagedCodeAnalysis
dotnet_diagnostic.CA2200.severity = error # Rethrow to preserve stack details

# =================
# Too Match Detail Rulesets
# =================

# CONSIDER: Are IDE0051 and IDE0052 too noisy to be warnings for IDE editing scenarios? Should they be made build-only warnings?
dotnet_diagnostic.IDE0005.severity = warning # Remove unnecessary imports
dotnet_diagnostic.IDE0051.severity = warning # Remove unused private member
dotnet_diagnostic.IDE0052.severity = warning # Remove unread private member
dotnet_diagnostic.IDE0079.severity = none # Remove unnecessary suppression
dotnet_diagnostic.IDE0090.severity = none # Simplify new expression
```

# 考慮が必要な設定

## 対象のファイル

.editorconfigはファイル拡張子やファイル名をターゲットとして指定するため、感覚としては.gitattributesに似ています。ということは注意点も似ているということです。例えば、`*.cs`はC#のソースコードを指定しますが、`*.cs`はC#のプロジェクトファイルではありません。このため、`*.csproj`や`*.props`も指定する必要があります。

また、`*`は全ファイルを対象にする非常に強力な指定です。どのファイルでも原則とする設定を差し込んておいて、調整したいファイル拡張子に対して別途指定することでオーバーライドすると設定がスリムになります。

例えば上記.editorconfigでは、原則改行コードは`lf`、charsetを`utf-8`としています。その後、yamlやjson、csファイルを対象にインデントやcharsetを調整しています。

## OS固有のeol設定

残念ながら.editorconfigはOSの違いを判別する機能を持たないため、OSごとに設定を変えることはできません。[^1]このため、`git config`のautocslfに任せて無指定か`unset`がおすすめです。もし利用するOSを固定できるなら、WindowsかLinux/macOSでend_of_lineの指定は選択するのもいいでしょうが、あまり指定するメリットはないと考えます。避けたい設にて、Windowsで`lf`を用いる弊害を説明します。

| OS | end_of_line | 備考 |
| --- | --- | --- |
| 両OSで利用する場合 | `unset` | `git`のリモート、ローカルEOLに任せる |
| Windows | `crlf` | eolで悩まないために`git config core.autocrlf=true`を前提とする |
| Linux/macOS | `lf` | Windowsではないのでlfになることが期待される |

## 言語によるcharsetの指定

日本語を用いるプロジェクトと英語のみを用いるプロジェクトでcharsetが異なります。Visual Studioは日本語を含むとshift-jisでファイル保存しようとするのですが`git`でshift-jisは文字化けを起こしトラブルの原因となります。このため、コード上で日本語を用いるプロジェクトでは`charset=utf-8-bom`を用いてGitでも日本語表示しつつ、ローカルでも日本語を文字化けさせないのがオススメです。

一方で英語(ascii)のみを用いるプロジェクトでは`charset=utf-8`を用いるのに止める理由も思いつきません。ただ、Roslynチームは`charset=utf-8-bom`を用いているため、`utf-8-bom`を使わない積極的な理由もないと認識しています。[^2]

| 言語 | charset | 備考 |
| --- | --- | --- |
| 日本語を用いるプロジェクト | `utf-8-bom` | Gitで日本語を表示し、ローカルでも日本語を文字化けさせない |
| 英語のみを用いるプジェクト | `utf-8` | 一般的な設定 |

## アナライザー設定

C#のアナライザー設定も.editorconfigで設定できます。ここでアナライザーの警告レベルを調整できるので、プロジェクトで統一したアナライザー設定を展開するときに利用するといいでしょう。例えば、Nullable Reference Typesを導入したプロジェクトでは、`dotnet_diagnostic.CS8618.severity = error`を設定することで、警告をエラーに昇格させることができます。nullableを必須にできるので、プロジェクトの初期から有効にするのがオススメです。

[Microsoft Learn](https://learn.microsoft.com/en-us/visualstudio/ide/create-portable-custom-editor-options?view=vs-2022)にEditorConfigをVisual Studioで利用する方法が紹介されています。ファイルの配置についても詳しく説明されているので、これまで知らなかった人は参考にしてください。

Visual Studio以外にRiderも.editorconfigを尊重しますし、VS Codeも[EditorConfig for VS Code](https://marketplace.visualstudio.com/items?itemName=EditorConfig.EditorConfig)をインストールすることで.editorconfigを尊重します。.editorconfigを尊重するエディター/IDEを使っていると、プロジェクトにおけるコードフォーマットを統一できていいですね。

# 避けたい設定

## ファイルごとの設定

可能であればファイルごとに.editorconfigでルールを調整するのは避けたほうがいいです。.gitattributesもそうですが、エディターによるファイル管理とこういった設定は連動しません。このため、ファイル指定での設定はファイルのパス変更やファイル名変更しても設定を変え忘れて効かなくなる可能性があります。

想像してください、何かしらの理由でディレクトリを移動させて`git commit`、push、PRマージした後、ほかの人がpullしたときに.editorconfigが効かなくなって、原因が.editorconfigでファイル名やファイルパス指定したからだった時を。私はeditorconfigで設定したことに気づく自信はありませんし、気づくためにエラーを出す仕組みも.editorconfigは持ち合わせん。

```ini
# 避ける
[foo/bar.json]
indent_size = 4
[piyo/buz.json]
indent_size = 2

# 可能なら拡張子でまとめる
[*.json]
indent_size = 2
```

## Windowsでend_of_lineをlfに指定する

過去数年`lf`を試してきたのですが、結論は、Windows環境のC#プロジェクトで改行コードを`lf`に統一するのは避けたほうがいいと認識しています。`git config core.autocrlf = true`が好ましいという背景を混みで、`end_of_line=lf`にしていると「Visual StudioのCRLFとLF混在時のダイアログ」がファイルを開くたびに発生してめんどくさいだけです。

![image](https://github.com/user-attachments/assets/d04997ab-3605-497c-83e4-adbace690cc1)

`end_of_line`を指定しないということは、C#のRaw String Literalなどでファイルの改行コードが文字列改行コードになります。このため、テストコードで改行コードを意識しないとWindowsで通るのにLinuxでこけたりします。しかし、このようなケースでも`String.ReplaceLineEndings`や`.Replace("\r\n", "\n")`で文字列の改行コードはLFに統一できます。めんどくさい側面はありますが、利用者の環境でテスト結果が左右するよりコードで解決するほうがいいと考えます。

なお、.editorconfigでlfを設定していてもcrlfが混じる原因はいくつかあるようですが、`git config core.autocrlf=true`が原因のことが多いようです。とはいえ、`core.autocrlf=true`はWindowsにおいてOS間の互換性を向上させるために有効な設定なので、これを有効にするのを前提にします。

<details><summary>なぜcore.autocrlfをtrueにするのか</summary>

蛇足なので、興味がある人だけ読んでください。

`git config core.autocrlf=true`はWindows専用設定でOS間の互換性を向上させます。

具体的には、クローン/チェックアウト時は「リモートにlfで保存されているファイルをローカルではcrlfに変換」し、リモートプッシュ時は「ローカルのcrlfなファイルをlfに変換」するので、リポジトリ内部は常にlfで統一されます。特にUnityを使っている環境でEOLに伴うGit差分を考慮する必要がなくなるため、`git config core.autocrlf=true`はWindowsだけの環境でも有効にしておくのがオススメです。Gitプッシュ時に、EOLによる差分が他の人に影響するかを気にしないで済むのはありがたいです。ただし`.sh`などLFが必須なファイルで困るので`.gitattributes`で個別設定を併用しましょう。

`git config core.autocrlf=false`にするのがオススメされる記事をよく見かけますが、これの問題は割と大きいです。例えば、Windowsで誤ってcrlfでプッシュしたファイルをLinuxやmacOSでチェックアウトすると、改行コードがcrlfのままになり、コードの差分が出てしまいます。また、チーム内でOSが混在していたり、人によって`core.autocrlf=true`が混じっていると、不要な差分やマージ時にコンフリクトが発生しえます。

`core.autocrlf=true`でも`core.autocrlf=false`のいずれを使うにしても、チーム内で統一しましょう。

</details>

## Visual Studioで.editorconfigは開かない

Visual Studioで.editorconfigファイルを開くと、GUIdotnetアナライザー設定を調整できます。ただ、.editorconfigに存在しなかったアナライザ差分まで保存されてしまいます。この差分が1行2行ならいいのですが、100行近く差し込まれるので、Visual Studioで.editorconfigを開くのは避けたほうがいいです。Visual Studioの.editorconfigは読み込み専用で、設定を変更するときはエディターで行いましょう。

幸いにしてアナライザーの設定は[Code analysis | Microsoft Learn](https://learn.microsoft.com/en-us/dotnet/fundamentals/code-analysis/code-style-rule-options)で公開されています。Code style rule optionsやCode quality rulesを見ると、どのような設定や値が可能かがわかります。

Visual Studioで開いてどのような差分が起こるか気になりますか?例えば先に示した.editorconfigをVSで開くと次のようなGUIが開き、ファイルの`*`から差分が発生したとわかります。

![image](https://github.com/user-attachments/assets/4afd6263-5e7f-4965-81c2-1b0837695b58)

ファイルを保存すると、大量の差分が生じます。背景はわかりますが、ちょっとアグレッシブだと感じます。

![image](https://github.com/user-attachments/assets/1758bb44-c69c-4df6-be2b-45ced0e54630)

# まとめ

C#のコード向けに.editorconfigを設定する背景情報を見かけないので、私の経験をもとにおすすめ設定と避けたほうがいい設定をまとめました。C#のコードを統一するために.editorconfigを使うと、エディター/IDEに関係なくコードフォーマットを統一できるので、プロジェクトに.editorconfigを導入することをオススメします。

特に、[プロジェクトのコード規約はMicrosoftのC#コード規則](https://learn.microsoft.com/ja-jp/dotnet/csharp/fundamentals/coding-style/coding-conventions)です。というのではなく、[.editorconfigでそれを設定する](https://learn.microsoft.com/en-us/dotnet/fundamentals/code-analysis/code-style-rule-options)とルールが明解、かつ個人に依存せず、Visual StudioのIDEサポートを引き出せておすすめです。

# 参考

* [.editorconfig | dotnet/roslyn | GitHub](https://github.com/dotnet/roslyn/blob/main/.editorconfig)
* [.editorconfig | dotnet/runtime | GitHub](https://github.com/dotnet/runtime/blob/main/.editorconfig)
* [.editorconfig | dotnet/aspnetcore | GitHub](https://github.com/dotnet/aspnetcore/blob/main/.editorconfig)
* [.editorconfig | dotnet/aspire | GitHub](https://github.com/dotnet/aspire/blob/main/.editorconfig)
* [dotnet format を CI で行って継続的にコードフォーマットしていく - tech.guitarrapc.cóm](https://tech.guitarrapc.com/entry/2021/12/07/232921)


[^1]: 過去に[autocrlfサポート](https://github.com/editorconfig/editorconfig/issues/226)が提案されていましたが投票の結果は却下でした。
[^2]: dotnet/runtimeの.editorconfigは英語で統一されているためかcharsetが指定されていないです。ASP.NETCoreではutf-8が指定されています。
