---
Title: 2024年9月のS3 Lifecyce Transitionの変更に伴うaws_s3_bucket_lifecycle_configurationの破壊的変更
Category:
- Terraform
EditURL: https://blog.hatena.ne.jp/guitarrapc_tech/guitarrapc-tech.hatenablog.com/atom/entry/6802418398329718934
PreviewURL: https://tech.guitarrapc.com/draft/entry/IQnay02F7dx9K-afGG-PzrVIK_s
Draft: true
---

Ephemeral Resourceに対応するにはAWS Providerの更新も必要、ということで更新作業をしていたところ、2024年9月のS3 Lifecyce Transitionの変更に伴うaws_s3_bucket_lifecycle_configurationの破壊的変更があることに気づきました。
ということでその対応メモです。

[:contents]

# Objects smaller than 128 KB will not transition by default to any storage class

[AWS Docs](https://docs.aws.amazon.com/AmazonS3/latest/userguide/lifecycle-transition-general-considerations.html#lifecycle-configuration-constraints)にある通り、2024年9月以降、128KB未満のオブジェクトはデフォルトでどのストレージクラスにも移行されなくなります。[^1]以下は引用です。

> 2024 年 9 月に、Amazon S3 は小さなオブジェクトのデフォルトの遷移動作を次のように更新しました。
>
> デフォルトの移行動作の更新 - 2024 年 9 月以降、デフォルトの動作により、128 KB 未満のオブジェクトはどのストレージ クラスにも移行されなくなります。
>
> 以前のデフォルトの移行動作 - 2024 年 9 月より前のデフォルトの動作では、128 KB 未満のオブジェクトは S3 Glacier および S3 Glacier Deep Archive ストレージクラスにのみ移行できました。
>
> 2024 年 9 月より前に作成された設定は、変更しない限り、以前の移行動作が保持されます。つまり、ルールを作成、編集、または削除すると、設定のデフォルトの移行動作が更新された動作に変わります。ユースケースで必要な場合は、128 KB 未満のオブジェクトが S3 Glacier および S3 Glacier Deep Archive に移行するように、デフォルトの移行動作を変更できます。これを行うには、 PutBucketLifecycleConfigurationx-amz-transition-default-minimum-object-sizeリクエストでオプションのヘッダーを使用します。

以前は以下の構成をすることで128KB未満のオブジェクトをGlacierに移行できましたが、2024年9月以降は明示的に許可しない限り移行を阻止します。

```xml
<LifecycleConfiguration>
  <Rule>
    <ID>Allow small object transitions</ID>
    <Filter>
      <ObjectSizeGreaterThan>1</ObjectSizeGreaterThan>
    </Filter>
    <Status>Enabled</Status>
    <Transition>
      <Days>365</Days>
      <StorageClass>GLACIER_IR</StorageClass>
    </Transition>
  </Rule>
</LifecycleConfiguration>
```

# Terraform Provider 5.70以降の差分

Terraformで`aws_s3_bucket_lifecycle_configuration`を使ってS3のライフサイクル設定を管理している場合を見てみましょう。

AWS Provider 5.70前まで以下のようにしていたとします。

```terraform
# 例えばこうしていたら
resource "aws_s3_bucket_lifecycle_configuration" "bucket-config" {
  bucket = aws_s3_bucket.this.bucket
  # ... 省略
}
```

AWS Provider 5.70.0から次の変更がplan時に表示されます。

```terraform
  ~ resource "aws_s3_bucket_lifecycle_configuration" "bucket-config" {
        id                                     = "example-bucket"
      ~ transition_default_minimum_object_size = "varies_by_storage_class" -> "all_storage_classes_128K"
```

ポイントは`transition_default_minimum_object_size`attributeのデフォルトが変わることです。設定は[ドキュメント](https://docs.aws.amazon.com/AmazonS3/latest/API/API_PutBucketLifecycleConfiguration.html)に記載があります。

> * `varies_by_storage_class` (これまでのデフォルト): Objects smaller than 128 KB will transition to Glacier Flexible Retrieval or Glacier Deep Archive storage classes. By default, all other storage classes will prevent transitions smaller than 128 KB
>* `all_storage_classes_128K ` (2024年9月以降のデフォルト): Objects smaller than 128 KB will not transition to any storage class by default

この修正がかかった理由は、もし128KB未満のオブジェクトをGlacier Instant Retrievalに移行すると**予期せぬコスト増加**につながるためです。[S3価格表に記載](https://aws.amazon.com/s3/pricing/?nc1=h_ls)がある通り、S3 Glacier Instant Retrievalは128KB未満のオブジェクトでも128KBとして請求されます。1KBでも128KBとして請求されるので、128KB未満のオブジェクトをGlacier Instant Retrievalに移行するのはやめようということです。

> S3 Glacier Instant Retrieval has a minimum billable object size of 128 KB.

# AWS Provider更新時の差分に対応する

変更はユーザーが事故らないようにデフォルトが変わる差分なので、その差分にしたがって明示的に`transition_default_minimum_object_size`を指定するのがいいでしょう。

```terraform
resource "aws_s3_bucket_lifecycle_configuration" "bucket-config" {
  bucket = aws_s3_bucket.this.bucket
  transition_default_minimum_object_size = "all_storage_classes_128K"
  # ... 省略
}
```


## もしも128KB未満のオブジェクトをGlacier Instant Retrievalに移行させたい場合

移行する理由がないのでやらないと前提を置いた上ですが.... もしも万が一、何かしらのやむにやまれない事情で、仕方なく128KB以下のオブジェクトをGlacier Instant Retrievalに移行させたい場合は、`transition_default_minimum_object_size`を`varies_by_storage_class`に設定しつつ、フィルタールールで`object_size_greater_than = 1`など128KB未満のオブジェクトも明示的にGlacier移行を指定する必要があります。

```terraform
resource "aws_s3_bucket_lifecycle_configuration" "example" {
  bucket = aws_s3_bucket.this.bucket
  transition_default_minimum_object_size = "varies_by_storage_class"

  rule {
    id = "Allow small object transitions"

    filter {
      object_size_greater_than = 1
    }

    status = "Enabled"

    transition {
      days          = 365
      storage_class = "GLACIER_IR"
    }
  }
}
```

# まとめ

Ephemeral Resourceに対応したかっただけなのに、AWS Providerの更新で差分が出てあららという感じでした。S3 Lifecycle Transitionのデフォルト変更があったのに気づかなかったものの、`object_size_greater_than`を変更する理由がなかったので特に問題はなかったですが気をつけておきたいですね。

AWS Providerの更新で差分が出ることはそこまで多くないので、こういうことがあると楽しいですね。

[^1]: 私の認識はもとより128KBは移行されないだったので、このアナウンスは虚を突かれました
