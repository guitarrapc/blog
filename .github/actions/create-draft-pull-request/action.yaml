name: create draft pull request
description: "Create draft pull request for entry"
inputs:
  title:
    description: "title for pull request"
    required: true
  draft:
    description: "create draft pull request"
    required: true
  BLOG_DOMAIN:
    description: "blog domain"
    required: true
  ENTRY_PATH:
    description: "entry path"
    required: true

runs:
  using: "composite"
  steps:
    - name: set entry variables
      id: set-entry-variables
      run: |
        echo "EDIT_URL=$(yq --front-matter=extract '.EditURL' ${{ inputs.ENTRY_PATH }})" >> $GITHUB_OUTPUT
        echo "ENTRY_ID=$(yq --front-matter=extract '.EditURL' ${{ inputs.ENTRY_PATH }} | grep -oP '[^/]+\d$')" >> $GITHUB_OUTPUT
        echo "PREVIEW_URL=$(yq --front-matter=extract '.PreviewURL' ${{ inputs.ENTRY_PATH }})" >> $GITHUB_OUTPUT
      shell: bash
    - name: set owner
      id: set-owner
      run: |
        owner=$(yq ".[\"${{ inputs.BLOG_DOMAIN }}\"].owner" blogsync.yaml)
        if [[ "$owner" == 'null' ]]; then
          owner=$(yq ".[\"${{ inputs.BLOG_DOMAIN }}\"].username" blogsync.yaml)
        fi
        echo "OWNER_NAME=$owner" >> $GITHUB_OUTPUT
      shell: bash
    - name: delete other files
      run: |
        set +eo pipefail
        delete_files=($(git ls-files -o --exclude-standard | xargs -r grep -xL "EditURL: ${{ steps.set-entry-variables.outputs.EDIT_URL }}"))
        for file in ${delete_files[@]}; do
          rm "$file"
        done

        restore_files=($(git ls-files -m --exclude-standard | xargs -r grep -xL "EditURL: ${{ steps.set-entry-variables.outputs.EDIT_URL }}"))
        for file in ${restore_files[@]}; do
          git restore "$file"
        done
      shell: bash
    - name: move draft and update metadata
      uses: hatena/hatenablog-workflows/.github/actions/move-draft-and-update-metadata@1e932419b6749d6b4ad3d0e30d07df87a1ed3c3e # v1.3.4
    - name: get pull request template
      id: get-pull-request-template
      env:
        GH_TOKEN: ${{ github.token }}
      run: |
        pr_template=$(gh repo view --json pullRequestTemplates | jq -r '.pullRequestTemplates | [map(select(.filename == "draft.md"))[0], map(select(.filename == "PULL_REQUEST_TEMPLATE.md"))[0]] | map(select(. != null)) | first | .body // empty')
        if [[ -z "$pr_template" ]]; then
          pr_template=$(cat<<'EOF'
        ## ${TITLE}

        - 編集ページのURL: ${EDIT_URL}
        - プレビューへのURL: ${PREVIEW_URL}

        EOF
          )
        else
          pr_template=$(cat <<'EOF'

        ## ${TITLE}

        - 編集ページのURL: ${EDIT_URL}
        - プレビューへのURL: ${PREVIEW_URL}

        "${pr_template}"
        EOF
          )
        fi
        echo "PULL_REQUEST_TEMPLATE<<EOF" >> $GITHUB_OUTPUT
        echo "$pr_template" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
      shell: bash
    - name: prepare pull request body
      id: prepare-pull-request-body
      env:
        TITLE: ${{ inputs.title }}
        EDIT_URL: ${{ steps.set-entry-variables.outputs.EDIT_URL }}
        OWNER_NAME: ${{ steps.set-owner.outputs.OWNER_NAME }}
        ENTRY_ID: ${{ steps.set-entry-variables.outputs.ENTRY_ID }}
        PREVIEW_URL: ${{ steps.set-entry-variables.outputs.PREVIEW_URL == 'null' && 'なし' || steps.set-entry-variables.outputs.PREVIEW_URL }}
        PR_TEMPLATE: ${{ steps.get-pull-request-template.outputs.PULL_REQUEST_TEMPLATE }}
      run: |
        echo "PULL_REQUEST_BODY<<EOF" >> $GITHUB_OUTPUT
        echo "${PR_TEMPLATE}" | envsubst '${TITLE} ${EDIT_URL} ${PREVIEW_URL} ${OWNER_NAME} ${ENTRY_ID}' >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
      shell: bash
    - name: commit
      shell: bash
      run: |
        git remote set-url origin "https://github-actions:${GITHUB_TOKEN}@github.com/${{ github.repository }}"
        git config user.name github-actions[bot]
        git config user.email 41898282+github-actions[bot]@users.noreply.github.com

        git checkout -b "${BRANCH_NAME}"
        git add .
        git commit -m "[create-pull-request] automated change by $GITHUB_WORKFLOW" || true
        git push -u origin "${BRANCH_NAME}" --force
      env:
        GITHUB_TOKEN: ${{ github.TOKEN }}
        GITHUB_WORKFLOW: ${{ github.workflow }}
        BRANCH_NAME: draft-entry-${{ steps.set-entry-variables.outputs.ENTRY_ID }}
    - name: Create PullRequest
      shell: bash
      run: |
        pr_exists=$(gh pr list --head "${BRANCH_NAME}" --base "${{ github.event.repository.default_branch}}")
        if [ -n "$pr_exists" ]; then
          echo "PR already exists for  -> ${BRANCH_NAME}. Skipping creation."
          exit 0
        fi

        cat << 'EOF' > pr_body.txt
        ${{ steps.prepare-pull-request-body.outputs.PULL_REQUEST_BODY }}

        ---

        This PR was created automatically via [${{ github.workflow }}]($GITHUB_ACTIONS_RUN_URL), job [link]($GITHUB_ACTIONS_JOB_URL)._
        EOF

        gh pr create --title "${TITLE}" --body-file "./pr_body.txt" --draft
      env:
        BRANCH_NAME: draft-entry-${{ steps.set-entry-variables.outputs.ENTRY_ID }}
        GH_TOKEN: ${{ github.TOKEN }}
        GITHUB_ACTIONS_RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        GITHUB_ACTIONS_JOB_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}/jobs/${{ job.check_run_id }}
        TITLE: ${{ inputs.title }}
