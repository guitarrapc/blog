---
Title: Ubuntu環境のCLIツールをasdfからaquaに移行した話
Category:
- Ubuntu
Date: 2025-01-10T23:58:51+09:00
URL: https://tech.guitarrapc.com/entry/2025/01/10/235851
EditURL: https://blog.hatena.ne.jp/guitarrapc_tech/guitarrapc-tech.hatenablog.com/atom/entry/6802418398319065657
---

私はWindowsでWSL Ubuntu環境を3つ動かしています。そのため、をインストール、アップグレードするにも手でやるのは面倒です。
これまでasdfを使ってツール管理していたのをaquaにした記録を書き出しておきます。

[:contents]

# asdfとaqua

asdfとaquaはともにCLIツールのバージョン管理ツールです。どちらもツールをインストールするまでの流れが似通っていますが、ツールの定義を誰が管理しているかが決定的に異なります。

![image](https://github.com/user-attachments/assets/4b6ab0b9-ee25-4983-87ff-6d7caabb1ab7)

簡単に両者を見てみましょう。

## asdf

[asdf](https://github.com/asdf-vm/asdf)は複数のランタイムバージョン管理、コマンドラインツールのバージョン管理ができるCLIです。asdfの特徴はプラグイン([asdf-vm/asdf-plugins)](https://github.com/asdf-vm/asdf-plugins))で、自分や誰かがCLIツールの定義をGitHubリポジトリに配置すると、asdf利用者はそれを参照して定義されたツールをインストールできます。

**ツールのインストール例**

例えば、Node.jsをインストールするには次のようにします。

```sh
# asdfのnode.jsプラグインを追加
asdf plugin add nodejs https://github.com/asdf-vm/asdf-nodejs.git
# node.jsをインストール
asdf install nodejs latest
```

**ツールのバージョン管理**

ツールのバージョンは`$HOME/.tool-versions`や`$PWD/.tool-versions`に保存されています。これを使ってグローバルやパス単位にツールバージョンを制御できます。

```sh
# global version
asdf global nodejs lastest

# curent dir version
asdf local nodejs latest
```

## aqua

[aqua](https://github.com/aquaproj/aqua)はコマンドラインツールのバージョン管理をするCLIです。aquaはインストールするツールをYAML定義し、[aquaproj/aqua-registry](https://github.com/aquaproj/aqua-registry)に配置されたツール定義を参照してCLIをインストールします。

**ツールのインストール例**

例えば、Node.jsをインストールするには次のようにします。

```sh
# yaml定義を作成
aqua init
# yaml定義にnodejsを追加
aqua g -i nodejs/node
# インストール
aqua i -l
```

aquahは遅延インストール(Lazy Install)がデフォルトで有効になっているので、明示的に`aqua -i`を実行せずともツール定義に記載されていればツール実行時に自動でインストールされます。便利ですが厄介な機能でもあります。

```sh
sed -i "s|cli/cli@.*|cli/cli@v2.1.0|" aqua.yaml
$ gh version
INFO[0000] download and unarchive the package            aqua_version=2.16.4 env=linux/arm64 exe_name=gh package_name=cli/cli package_version=v2.1.0 program=aqua registry=standard
gh version 2.1.0 (2021-10-14)
https://github.com/cli/cli/releases/tag/v2.1.0
```

**ツールのバージョン管理**

ツール定義のバージョンを変えることで任意のツールバージョンを利用できます。
[グローバルなツールバージョンファイル](https://aquaproj.github.io/docs/tutorial/global-config)か`$PWD/aqua.yaml`に保存されています。グローバルなツールをインストールする際は`-a`オプションが必要です、あまり見かけないコマンド体系ですね。

```sh
# global version
mkdir -p "${XDG_CONFIG_HOME:-$HOME/.config}/aquaproj-aqua"
vi "${XDG_CONFIG_HOME:-$HOME/.config}/aquaproj-aqua/aqua.yaml"
export AQUA_GLOBAL_CONFIG=${AQUA_GLOBAL_CONFIG:-}:${XDG_CONFIG_HOME:-$HOME/.config}/aquaproj-aqua/aqua.yaml
aqua i -a

# current dir version
aqua -i
```

## なぜaquaなのか

もともとasdfを使っていたのですがaquaに移行したきっかけは、ここ数年で見かけた悪意を持った第三者の攻撃が入りこむ事例でした。asdfはツール管理を3rdパーティから取得する面で潜在的なセキュリティリスクがあると考えています。一方aquaは公式レジストリがあり多くの人がレジストリをwatchしRenovateで管理されていることから信頼性が高いと考えました。

| 検討ポイント | asdf | aqua |
| --- | --- | --- |
| ツール定義の取得元 | 3rdパーティ | 公式レジストリ |
| ツール定義の更新 | リポジトリによるが基本手動 | Renovateによる自動更新 |
| チェックサム管理 | リポジトリによるがないことが多い | Renovateによる自動更新 |

asdfのプラグインは各自のリポジトリ(3rdパーティ)で管理されており、asdfから使うときにプラグインの定義が今どうなっているか気にする機会はまずありません。asdfプラグインを使うときに定義が変なことをしていないか精査することはあっても、その後プラグインが更新されるたびにチェックすることは困難だなぁ、と気になっていました。[^1]

aquaは公式レジストリがあり、ツールの定義はレジストリに集約されています。レジストリはツール定義の追加時にレビューし、ツール定義更新はRenovateが自動実行しチェックサムも更新されます。ツール定義が公式レジストリで提供され、ツール定義が自動化込みでメンテされているというのは使うときに安心できるポイントです。レジストリの作りの丁寧さは尊敬を覚えます。

自動化するメリットの1つは人の手が入り込みにくいことです。自動化の仕組み自体にアプローチされるとダメですが、自動化されたフローに対して人の手で介入するのは難しくなります。自動化を徹底した運営をすると、自動化対象のマニフェストを変更するPRを出されても目立ち、相応の理由がない限りリジェクトするだろうと予想します。[^2]

# asdfからaquaへの移行

私はAnsibleでWSL構築を自動化しており、asdfからaquaへの移行はAnsibleのプレイブックを修正するだけで済みました。具体的には、次の2点で対応しています。

- Linux用のdotfile管理にaqua定義を追加: [HOME/.config/aquaproj-aqua/aqua.yaml - guitarrapc/dotfiles-linux)](https://github.com/guitarrapc/dotfiles-linux/blob/master/HOME/.config/aquaproj-aqua/aqua.yaml)
- ツールインストールをasdfからaquaに変更: [feat: switch asdf to aqua #51 - guitarrapc/local-provisioner](https://github.com/guitarrapc/local-provisioner/pull/51)

# まとめ

もともと手動でツールインストールするのに疲弊してasdfを長く使っていました。しかし昨今のOSSに対する攻撃を見ていて困難を感じたため、手動に戻すかaquaで管理するか1年あまり悩みaquaを選びました。

Github Actionsのツール管理にもaquaを使っているのですが、今のところ手動インストールに戻す理由がないので楽しく使っていきたいです。

[^1]: プラグインが更新されてもasdf上で利用前に気づくようなフローではないので自分で頑張るしかない
[^2]: 人の考えはわかりませんが、少なくとも現在のaquaはRenovateによる自動更新が徹底されている
