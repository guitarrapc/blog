---
Title: Zxでコマンド中の文字列をエスケープする
Category:
- C#
Date: 2025-01-09T23:56:38+09:00
URL: https://tech.guitarrapc.com/entry/2025/01/09/235638
EditURL: https://blog.hatena.ne.jp/guitarrapc_tech/guitarrapc-tech.hatenablog.com/atom/entry/6802418398318828318
---

Zxを使うとシェルで実行するコマンドを`await "文字列"`で実行できます。ただ、その文字列中に`"`が含まれるとエスケープが必要です。
このエスケープ挙動がWindows(cmd)とLinux(Bash)で異なるというメモです。

[:contents]

# C#でZxを使う

[google/Zx](https://github.com/google/zx)は文字列をawaitするとシェルで実行されるツールです。C#でZx風に書く時は[Cysharp/ProcessX](https://github.com/Cysharp/ProcessX)を使うと便利です。

```cs
using Zx;

var tp = TimeProvider.System;
var ts = tp.GetTimestamp();
var name = await "echo FooBar";
await new[]
{
    $"sleep 1 && echo 1",
    $"sleep 2 && echo 2",
    $"sleep 3 && echo 3",
};
await $"echo Done by {name} in {tp.GetElapsedTime(ts).TotalMilliseconds}ms";

```

実行するとシェルで実行した結果が出力されます。

```sh
FooBar
1
2
3
Done by FooBar in 3114.02ms
```

C#で出力結果をいじれることから、コマンドラインにパイプをつなげてawaitするというよりも、コマンドを単発実行するという使い方が多くなるでしょう。

# `"`のエスケープ

本題はZxの中で`echo "foobar"`のように`"`を含む文字列をエスケープする方法です。`"`をエスケープする方法はOS(シェル)によって異なります。
C#のZxはWindowsにおいては`cmd /c`、その他OS[^1]においては`bash -c`で実行されます。

> [src/ProcessX/Zx/Env.cs - Cysharp//ProcessX](https://github.com/Cysharp/ProcessX/blob/c700b2dbcfce2cdbfba4aa7ea43e46322756ccc2/src/ProcessX/Zx/Env.cs#L23-L38)

```cs
if (RuntimeInformation.IsOSPlatform(OSPlatform.Windows))
{
    _shell = "cmd /c";
}
else
{
    if (Which.TryGetPath("bash", out var bashPath))
    {
        _shell = bashPath + " -c";
    }
    else
    {
        throw new InvalidOperationException("shell is not found in PATH, set Env.shell manually.");
    }
}
```

残念ながらcmdとBashで`"`をエスケープする方法は異なるため、マルチOSで動作させるには工夫することになります。次のコマンドで挙動を見てみましょう。

```cs
using Zx;

await "echo \"foobar\"";
```



[^1]: Windows以外なのでLinux/macOS/他が該当します
