---
Title: CPUなどリソース監視をする時にノイジーアラートを抑制する
Category:
- Onservability
Date: 2025-02-28T23:59:00+09:00
URL: https://tech.guitarrapc.com/entry/2025/02/28/235900
EditURL: https://blog.hatena.ne.jp/guitarrapc_tech/guitarrapc-tech.hatenablog.com/atom/entry/6802418398333258975
---

CPUなどのリソース監視をする際にノイジーアラートを抑制するために普段とっている基本的な方針のメモです。

[:contents]

# ノイジーアラートは抑制しないといけない

監視の文脈でノイジーアラートという言葉があります。システム監視において対応不要なアラートが大量に発生し、重要なアラートを見逃すリスクを高める現象を指す言葉です。ノイジーアラートをいかに抑制するかは監視設計の重要な要素です。

ノイジーアラートを見つけたら即改善というのは、監視におけるファーストアクションとして日々経験を積み重ねることができ餡巣。

# リソースの監視

さて、そもそもCPUやメモリはシステム稼働の監視対象としてはユーザー体験を直接示す指標ではありません。例えば、CPU100％でも応答速度が十分早めければシステムとしては問題ありません。また、CPU50％でも応答速度が劣化する状況ならばシステムとしては問題です。CPUからシステムの状態を直接推し測るだけの関連性を見出すことは難しい、これはほとんどのシステム[^1]では概ね共通しています。

とはいえ、応答速度など**ユーザー体験を直接示すアラート**を優先度トップのアラートとして、CPUやメモリの監視は補足情報になりえます。そのため、CPUやメモリがあまりに異常な状態ならアラートを発生させることに意義はあるでしょう。

## CPUの監視

CPU監視の特徴として、CPUの使用率は瞬時に変動することが多いです。そのため、CPUの使用率が瞬時に上昇しても、その後すぐに下がるような状況が発生いえます。このような状況では、単純な閾値監視ではノイジーアラートとして過剰検出しやすいです。

## メモリの監視

メモリの監視はCPUとは異なる側面があります。OOMの存在です。メモリが不足するとOSがプロセスを強制終了させるのはお約束とも言えます。そのため、メモリの監視はCPUとは別軸でシステム安定性に直接かかわる重要な監視対象です。

メモリはアプリケーションの性質にも寄りますが、ある程度段階的にメモリが変動しつつ、GCなどで一気にメモリ解放されることがあります。CPUとよく似た側面があるのですが、一定の値を超えたらアウトというのが違います。

リソースにはそれぞれ特徴があり、キリがないのでここまで。

# ノイジーアラートを抑えたリソース監視

CPUは振れ幅が激しくなりやすいため、CPU監視には以下のようなアプローチが有効です。Datadogをベースに説明しますが、他の監視ツールでも同様のコンセプトでやっています。

* 値は`average`か`median`を用いる[^2]
* 期間の`average`を用いる
* 期間を短くしすぎない
* 期間中ずっと超える条件にする

順に見ていきましょう。

## 値は`average`か`median`を用いる

システムの瞬間負荷が大きかったらまずいんじゃない?と頭をよぎることはないでしょうか。この考えに基づくと値の`max`を用いたくなりますが、これはノイジーアラートを招きやすいです。

システムに対する瞬間的な負荷ではなく**継続した高負荷**こそが障害トリガーになるケースが多いため、`average`か`median`を用いることでノイジーアラートを抑制できます。

## 期間の`average`を用いる

値を取得したら、期間中の値をどう評価するか決定する必要があります。期間中にCPU使用率が閾値を予想より超えたらアウト!と思ってしまうと`max`を用いたくなりますが、これはノイジーアラートを招きやすいです。

先ほど同様に、**継続した高負荷**こそが障害トリガーになるケースが多いため、期間の`average`を用いることでノイジーアラートを抑制できます。

## 期間を短くしすぎない

期間を5minなど短くしすぎると、5min中にCPU使用率が高くなった瞬間でアラートが発生してしまいます。CPU使用率って面白くて、少し高負荷が続いてもすぐに下がることも多く、このような状況でアラートが発生するとノイジーアラートになりやすいです。

逆に、期間を長くしすぎると、障害が発生してからアラート発生として検知するまでの時間が長くなります。このため期間は適切に...となるのですが、システムに応じてってなりやすいですよね。

私は15min程度に設定することが多いです。これはWebやAPI、ワーカーなど色々なアプリケーション動作形態においてノイズにならず適切なケースが多いです。[^3]

## 期間中ずっと超える条件にする

Datadogは、アラートデフォルト設定で期間中一度でも超えたらアラート発生という設定になっています。これはノイジーアラートを招きやすいです。

![image](https://github.com/user-attachments/assets/acf85c78-085b-4271-b385-36ed249fb12b)

先ほど同様に、**継続した高負荷**こそが障害トリガーになるケースが多いため、期間中ずっと条件を満たした場合アラート、という設定にすることでノイジーアラートを抑制できます。

# Datadogモニターの設定例

Datadogのモニター設定例を示します。

![image](https://github.com/user-attachments/assets/926d5742-67ea-4a39-b887-aad09f4ce0f4)

# まとめ

あくまで一例ですが、DB系も似た考え方を基本にアラートを設定するのがよいでしょう。移動平均とかも使うの検討してもいいのですが、検知が遅れると意味がないのでスムース系はアラートにあまり向いていないです。

監視に関する考え方は、[入門 監視](https://www.oreilly.co.jp/books/9784873118642/)が良いです。2019年の本なため一部内容が古かったりしますが、監視の基本的な考え方として参考になります。

# 参考

* [入門 監視 | O'Reilly Japan](https://www.oreilly.co.jp/books/9784873118642/)

[^1]: シングルコアをきっちりCPU100％使い切るようなアプリケーションはCPUと割と連動する例外的な存在です
[^2]: 個人的には`average`を使うことが多いです。`median`は`avg`よりも外れ値に強いですが、`avg`の方が直感的に理解しやすくAWSなど多くの監視指標と合致します。
[^3]: 5minとかの短期間の高負荷は、メトリクスやAPMなどでみればいいので、監視上は15minなどでいいという発想です
