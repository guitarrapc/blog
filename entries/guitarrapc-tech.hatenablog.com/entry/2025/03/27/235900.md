---
Title: PowerShellでclipコマンドを使ってクリップボードに出力すると文字化けする対策
Category:
- PowerShell
Date: 2025-03-27T23:59:00+09:00
URL: https://tech.guitarrapc.com/entry/2025/03/27/235900
EditURL: https://blog.hatena.ne.jp/guitarrapc_tech/guitarrapc-tech.hatenablog.com/atom/entry/6802418398344876073
---

以前PowerShellの実行結果をクリップボードに入れる[記事](https://tech.guitarrapc.com/entry/2013/07/19/200702)を書きました。`clip`はWSLから使えて大変便利ですが、Windows PowerShell(5.1)やPowerShell 7で日本語を含む文字列をクリップボードに出力したとき文字化けすることがあります。

今回は、質問をコメントで受けたのでその対策と原因を紹介します。こんなことはあまり気にしたくないんですが、現時点ではしょうがないです。

[f:id:guitarrapc_tech:20250416030845p:plain:alt=テキスト文書に貼り付けると文字化けします]

[:contents]

# 簡単まとめ

PowerShell 5.1、PowerShell 7いずれもコンソールの出力エンコーディングと外部プログラムへの出力エンコーディングを合わせましょう。
PowerShell 5.1では、`$global:OutputEncoding`を`[Console]::OutputEncoding`に合わせます。

```ps1
# PowerShell 5.1
PS> $global:OutputEncoding = [Console]::OutputEncoding
```

PowerShell 7では、`[Console]::OutputEncoding`をUTF-8に変更します。

```ps1
# PowerShell 7+
PS> [Console]::OutputEncoding = [System.Text.Encoding]::UTF8
```


# PowerShell 5.1

症状の再現からしましょう。ckipボードに出力を送って、`Get-Clipboard`でクリップボードの内容を確認すると確かに日本語が文字化けしています。

```ps1
PS> $PSVersionTable

Name                           Value
----                           -----
PSVersion                      5.1.26100.3624
PSEdition                      Desktop
PSCompatibleVersions           {1.0, 2.0, 3.0, 4.0...}
BuildVersion                   10.0.26100.3624
CLRVersion                     4.0.30319.42000
WSManStackVersion              3.0
PSRemotingProtocolVersion      2.3
SerializationVersion           1.1.0.1

PS> "テキスト文書に張り付けると文字化けします" | clip
PS> Get-Clipboard
????????????????????
```

Windows PowerShell(5.1)では、「コンソールの出力エンコーディング」と「[PowerShell が外部プログラムとの通信に使用するエンコード](https://learn.microsoft.com/ja-jp/powershell/module/microsoft.powershell.core/about/about_character_encoding?view=powershell-5.1)」の両方を調整する必要があります。前者は`[Console]::OutputEncoding`で、後者は`$global:OutputEncoding`で設定します。

デフォルトの値は次の通りです。

```ps1
PS> $OutputEncoding

IsSingleByte      : True
BodyName          : us-ascii
EncodingName      : US-ASCII
HeaderName        : us-ascii
WebName           : us-ascii
WindowsCodePage   : 1252
IsBrowserDisplay  : False
IsBrowserSave     : False
IsMailNewsDisplay : True
IsMailNewsSave    : True
EncoderFallback   : System.Text.EncoderReplacementFallback
DecoderFallback   : System.Text.DecoderReplacementFallback
IsReadOnly        : True
CodePage          : 20127

# デフォルトはOEMエンコーディングなので、日本語環境ではShiuft-JISになる。
PS> [Console]::OutputEncoding

BodyName          : iso-2022-jp
EncodingName      : Japanese (Shift-JIS)
HeaderName        : iso-2022-jp
WebName           : shift_jis
WindowsCodePage   : 932
IsBrowserDisplay  : True
IsBrowserSave     : True
IsMailNewsDisplay : True
IsMailNewsSave    : True
IsSingleByte      : False
EncoderFallback   : System.Text.InternalEncoderBestFitFallback
DecoderFallback   : System.Text.InternalDecoderBestFitFallback
IsReadOnly        : False
CodePage          : 932
```

**対策**

今回は外部プログラムに渡すエンコーディングがずれているので、`$global:OutputEncoding`を`[Console]::OutputEncoding`に合わせると文字化けが解消します。

```ps1
PS> $global:OutputEncoding = [Console]::OutputEncoding
PS> "テキスト文書に張り付けると文字化けします" | clip
PS> Get-Clipboard
テキスト文書に張り付けると文字化けします
```

**UTF-8直接指定はやめましょう**

ちなみに、外部コマンドに渡すからと`[Console]::OutputEncoding`と`$global:OutputEncoding`にUTF-8を指定すると文字列の先頭にゴミが入るので避けたほうがいいです。納得感がないですね。

```ps1
PS> $global:OutputEncoding = [Console]::OutputEncoding = [System.Text.Encoding]::UTF8
PS> "テキスト文書に張り付けると文字化けします" | clip
PS> Get-Clipboard
﻿テキスト文書に張り付けると文字化けします
```

**chcp指定はやめましょう**

`chcp 65001`でも同じように対応できるケースもありますが、エンコーディングが実際に何かを確認したほうが確実なのでchcpを使うのはオススメしません。今回のケースでも65001では文字化けが解消しないことは明らかです。

```ps1
PS> chcp 65001
PS> "テキスト文書に張り付けると文字化けします" | clip
PS> Get-Clipboard
・ｿ????????????????????
```

# PowerShell 7

PowerShell 7でも文字化けします。ただ、Windows PowerShellとは違う文字化け方ですね。そしてよく見かける文字化けパターンでもあります。

```ps1
PS> $PSVersionTable

Name                           Value
----                           -----
PSVersion                      7.5.0
PSEdition                      Core
GitCommitId                    7.5.0
OS                             Microsoft Windows 10.0.26100
Platform                       Win32NT
PSCompatibleVersions           {1.0, 2.0, 3.0, 4.0…}
PSRemotingProtocolVersion      2.3
SerializationVersion           1.1.0.1
WSManStackVersion              3.0

PS> "テキスト文書に張り付けると文字化けします" | clip
PS> Get-Clipboard
繝・く繧ｹ繝域枚譖ｸ縺ｫ蠑ｵ繧贋ｻ倥￠繧九→譁・ｭ怜喧縺代＠縺ｾ縺・
```

エンコーディングを確認してみると、案の定Shift-JISとUTF-8のずれと分かります。

```ps1
PS> $OutputEncoding

Preamble          :
BodyName          : utf-8
EncodingName      : Unicode (UTF-8)
HeaderName        : utf-8
WebName           : utf-8
WindowsCodePage   : 1200
IsBrowserDisplay  : True
IsBrowserSave     : True
IsMailNewsDisplay : True
IsMailNewsSave    : True
IsSingleByte      : False
EncoderFallback   : System.Text.EncoderReplacementFallback
DecoderFallback   : System.Text.DecoderReplacementFallback
IsReadOnly        : True
CodePage          : 65001

PS> [Console]::OutputEncoding

EncodingName      : Japanese (Shift-JIS)
WebName           : shift_jis
HeaderName        : iso-2022-jp
BodyName          : iso-2022-jp
Preamble          :
WindowsCodePage   :
IsBrowserDisplay  :
IsBrowserSave     :
IsMailNewsDisplay :
IsMailNewsSave    :
IsSingleByte      : False
EncoderFallback   : System.Text.InternalEncoderBestFitFallback
DecoderFallback   : System.Text.InternalDecoderBestFitFallback
IsReadOnly        : False
CodePage          : 932
```

**対策**

PowerShell 7では、`$global:OutputEncoding`はUTF-8がデフォルトなので、単純に`[Console]::OutputEncoding`をUTF-8に変更することで、クリップボードに出力できます。だいぶん素直ですね。

```ps1
PS> [Console]::OutputEncoding = [System.Text.Encoding]::UTF8
PS> "テキスト文書に張り付けると文字化けします" | clip
PS> Get-Clipboard
テキスト文書に張り付けると文字化けします
```



# 参考

* [about_Character_Encoding - PowerShell | Microsoft Learn](https://learn.microsoft.com/ja-jp/powershell/module/microsoft.powershell.core/about/about_character_encoding)
* [$OutputEncoding to the rescue - PowerShell Team](https://devblogs.microsoft.com/powershell/outputencoding-to-the-rescue/)
