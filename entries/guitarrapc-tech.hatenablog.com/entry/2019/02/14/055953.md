---
Title: Sharplab ã®MemoryGraph ã‚’ä½¿ã£ã¦ãƒ¡ãƒ¢ãƒªã®çŠ¶æ…‹ã‚’ç¢ºèªã™ã‚‹
Category:
- C#
Date: 2019-02-14T05:59:53+09:00
URL: https://tech.guitarrapc.com/entry/2019/02/14/055953
EditURL: https://blog.hatena.ne.jp/guitarrapc_tech/guitarrapc-tech.hatenablog.com/atom/entry/26003855889263752
---

ä»¥å‰TryRoslynã¨è¨€ã‚ã‚Œã¦ãŸã‚µãƒ¼ãƒ“ã‚¹ã§ã™ãŒã€ä»Šã¯Sharplabã¨ã„ã†åã«ãªã£ã¦ã„ã¾ã™ã€‚

ã“ã®ã‚µãƒ¼ãƒ“ã‚¹ã‚’ä½¿ã†ã¨ã€ã‚³ãƒ¼ãƒ‰ãŒILã‚„ãƒã‚¤ãƒ†ã‚£ãƒ–ã‚³ãƒ¼ãƒ‰ã«ã©ã®ã‚ˆã†ã«ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã•ã‚Œã‚‹ã‹ç¢ºèªã—ãŸã‚Šã€å®Ÿè¡Œã—ãŸã‚Šã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ¡ãƒ¢ãƒªçŠ¶æ…‹ã‚’ç¢ºèªã§ãã¾ã™ã€‚

ä¾‹ãˆã°æ¬¡ã®å›³ã¯ã€æ§‹é€ ä½“ã®æ–‡å­—åˆ—ãŒã©ã®ã‚ˆã†ãªãƒ¡ãƒ¢ãƒªçŠ¶æ…‹ãªã®ã‹ã‚’ç¤ºã—ãŸã‚‚ã®ã§ã™ã€‚

[f:id:guitarrapc_tech:20190214043230p:plain]

Sharplabã‚’ä½¿ã£ã¦ã€ã‚³ãƒ¼ãƒ‰ã ã‘ã§ãªããƒ¡ãƒ¢ãƒªçŠ¶æ…‹ã‚’å¯è¦–åŒ–ã™ã‚‹ã“ã¨ã§ç†è§£ã‚’æ·±ã‚ã‚‹ãã£ã‹ã‘ã«ã§ãã‚‹ã‹è¦‹ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

[:contents]

# æ¦‚è¦

Shaplabã‚’ä½¿ã£ã¦å¯è¦–åŒ–ã™ã‚‹ã“ã¨ã§ã€Œåˆ†ã‹ã‚‰ãªã„ã“ã¨ã‚’ã€ä½•ãŒåˆ†ã‹ã‚‰ãªã„ã‹ã‚ã‹ã‚‹ã‚ˆã†ã«ã§ãã‚‹ã€ã®ã§æ´»ç”¨ã™ã‚‹ã¨ã„ã„ã§ã™ã€‚

LinqPadã‚‚ä¼¼ã¦ã¾ã™ãŒã€ä½µç”¨ã™ã‚‹ã¨ã‚ˆã‚Šå¹¸ã›ã«ãªã‚Œã¾ã™ã€‚

# Sharplabã®åŸºæœ¬

Sharplabã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

> https://sharplab.io/

æ¬¡ã®ã‚ˆã†ãªã‚·ãƒ³ãƒ—ãƒ«ãªã‚¯ãƒ©ã‚¹ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã¾ã™ã€‚

```cs
using System;
public class C {
    public void M() {
    }
}
```

ã“ã“ã«è‰²ã€…ã‚³ãƒ¼ãƒ‰ã‚’æ›¸ã„ã¦è©¦ã™ã“ã¨ãŒã§ãã¾ã™ã€‚

## ã„ã¤ä½¿ã†ã®ã‹

ã‚¹ãƒãƒ›ã‚„PCã§ã‚‚å…¥åŠ›ã«å›°ã‚‰ãªã„ãƒ¬ãƒ™ãƒ«ã§ã‚¤ãƒ³ãƒ†ãƒªã‚»ãƒ³ã‚¹ã«ã‚ˆã‚‹ã‚³ãƒ¼ãƒ‰å…¥åŠ›è£œåŠ©ãŒã‚ã‚Šã¾ã™ã€‚ã•ã‚‰ã«å¾Œè¿°ã™ã‚‹ã‚³ãƒ¼ãƒ‰ã®å®Ÿè¡Œã€è§£æã€C#ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®é¸æŠã¾ã§ã§ãã¾ã™ã€‚

åŠ ãˆã¦ã€å…¥åŠ›ã—ãŸã‚³ãƒ¼ãƒ‰ãŒè‡ªå‹•çš„ã«ä¸€æ„ãªurlã§å†è¡¨ç¤ºã§ãã‚‹ã®ã§ã€ã‚³ãƒ¼ãƒ‰ã®å…±æœ‰ã«ã‚‚ã„ã„ã§ã—ã‚‡ã†ã€‚

ã ã„ãŸã„ã“ã“ã¾ã§ã§ãã‚‹ã¨LinqPadã§ã§ãã‚‹ã“ã¨ãŒç¶²ç¾…ã•ã‚Œã¦ãŠã‚Šã€nugetã‚’ä½¿ã‚ãªã„é™ã‚Šã¯LinqPadã‚ˆã‚Šæ°—è»½ã§ä¾¿åˆ©ãªé¢ã‚‚å¤šã„ã§ã—ã‚‡ã†ã€‚

åŸºæœ¬çš„ãªæ–‡æ³•ã€Decompileã‚„è¨€èªãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®é•ã„ã®ç¢ºèªç¨‹åº¦ãªã‚‰ã€Sharplabã§ã„ã„æ„Ÿã˜ãŒã—ã¾ã™ã€‚

<figure class="figure-image figure-image-fotolife" title="ã‚¤ãƒ³ãƒ†ãƒªã‚»ãƒ³ã‚¹">[f:id:guitarrapc_tech:20190214045112p:plain]<figcaption>ã‚¤ãƒ³ãƒ†ãƒªã‚»ãƒ³ã‚¹</figcaption></figure>

## ã‚³ãƒ¼ãƒ‰ã®å…±æœ‰

ä½•ã‹ã—ã‚‰ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã™ã‚‹ã¨URLãŒã¤ã„ã¦ã€å…¥åŠ›ã”ã¨ã«å¤‰åŒ–ã—ã¦ã„ã‚‹ã®ãŒåˆ†ã‹ã‚Šã¾ã™ã€‚

<figure class="figure-image figure-image-fotolife" title="ä¸€æ„ãªURLãŒã‚³ãƒ¼ãƒ‰ã”ã¨ã«ç”Ÿæˆã•ã‚Œã‚‹">[f:id:guitarrapc_tech:20190214050821p:plain]<figcaption>ä¸€æ„ãªURLãŒã‚³ãƒ¼ãƒ‰ã”ã¨ã«ç”Ÿæˆã•ã‚Œã‚‹</figcaption></figure>

ã“ã®URLã‚’è¸ã‚€ã¨ãã®ã‚³ãƒ¼ãƒ‰ã‚’è¡¨ç¤ºã§ãã‚‹ã®ã§ã‚³ãƒ¼ãƒ‰ã§çŠ¶æ…‹ã‚’å…±æœ‰å‡ºæ¥ã¦éå¸¸ã«ä¾¿åˆ©ã§ã™ã€‚å®Ÿéš›ã€C# ã®GitHub Issueãªã©ã§SharpLabã®URLã§å†ç¾ã‚³ãƒ¼ãƒ‰ã‚’ã‚·ã‚§ã‚¢ã—ã¦ã„ã‚‹ã®ã‚‚è¦‹ã‹ã‘ã¾ã™ã€‚

ã“ã®è¨˜äº‹ã§ã‚‚ã‚³ãƒ¼ãƒ‰ã”ã¨ã«URLã‚’ã‚·ã‚§ã‚¢ã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

## è¨€èªé¸æŠ

ç”»é¢ä¸Šéƒ¨ã®Codeã‹ã‚‰C# ä»¥å¤–ã«Visual Basic.NETã‚„F# ãŒé¸ã¹ã¾ã™ã€‚

<figure class="figure-image figure-image-fotolife" title="è¨€èªé¸æŠ">[f:id:guitarrapc_tech:20190214045443p:plain]<figcaption>è¨€èªé¸æŠ</figcaption></figure>

## è¡¨ç¤ºã®åˆ‡ã‚Šæ›¿ãˆ(Decompile)

ä¸‹(ã‚ã‚‹ã„ã¯å³)ãƒšã‚¤ãƒ³Resultsã‚’é¸ã¶ã¨ã„ãã¤ã‹é¸æŠè‚¢ãŒã‚ã‚Šã¾ã™ã€‚Decompileã®ã¾ã¨ã¾ã‚Šã‹ã‚‰è¦‹ã¦ã„ãã¾ã—ã‚‡ã†ã€‚

[f:id:guitarrapc_tech:20190214043741p:plain]

[f:id:guitarrapc_tech:20190214043750p:plain]

Decompileã®ä¸­ã§C# ã‚’é¸ã¶ã¨ãƒ‡ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã—ãŸC#ã‚³ãƒ¼ãƒ‰ã€ILã‚’é¸ã¶ã¨ILçŠ¶æ…‹ã€JIT Asmã‚’é¸ã¶ã¨ãƒã‚¤ãƒ†ã‚£ãƒ–ã‚³ãƒ¼ãƒ‰ã‚’ç¢ºèªã§ãã¾ã™ã€‚

<figure class="figure-image figure-image-fotolife" title="Decompile C#">[f:id:guitarrapc_tech:20190214043638p:plain]<figcaption>Decompile C#</figcaption></figure>

<figure class="figure-image figure-image-fotolife" title="Decompile IL">[f:id:guitarrapc_tech:20190214043829p:plain]<figcaption>Decompile IL</figcaption></figure>

<figure class="figure-image figure-image-fotolife" title="Decompile JIT Asm">[f:id:guitarrapc_tech:20190214043849p:plain]<figcaption>Decompile JIT Asm</figcaption></figure>

## è¨€èªã”ã¨ã®ãƒ‡ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«çµæœã®æ¯”è¼ƒ

ä½™è«‡ã§ã™ãŒã€C#ã€Visual Basic.NETã€F# ãã‚Œãã‚Œã§åŒã˜ã‚ˆã†ãªã‚³ãƒ¼ãƒ‰ã‚’æ›¸ã„ãŸæ™‚ã®ãƒ‡ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«çµæœã‚’æœ€ã‚‚ç°¡å˜ã«ç¢ºèªã§ãã‚‹ã‚µãƒ¼ãƒ“ã‚¹ã®1ã¤ã§ã™ã€‚


C# ã®æ¬¡ã®ã‚³ãƒ¼ãƒ‰ã‚’ä½¿ã£ã¦ãƒ‡ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«çµæœã‚’è¦‹ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

> [ã‚·ãƒ³ãƒ—ãƒ«ãªã‚¯ãƒ©ã‚¹ã®ã‚³ãƒ¼ãƒ‰](https://sharplab.io/#v2:EYLgZgpghgLgrgJwgZwLQBEJinANjASQDsYIFsBjCAgWwAdcIaITYBLAeyIBoATEANQAfAAIAGAAQiAjAG4AsACgRAZikAmCQGEJAbyUTDUtSIAsEgLIAKAJR6DRgL5LHQA=)

```cs
using System;
public class C {
    public void M() {
    }
}
```

```cs
using System.Diagnostics;
using System.Reflection;
using System.Runtime.CompilerServices;
using System.Security;
using System.Security.Permissions;

[assembly: CompilationRelaxations(8)]
[assembly: RuntimeCompatibility(WrapNonExceptionThrows = true)]
[assembly: Debuggable(DebuggableAttribute.DebuggingModes.Default | DebuggableAttribute.DebuggingModes.DisableOptimizations | DebuggableAttribute.DebuggingModes.IgnoreSymbolStoreSequencePoints | DebuggableAttribute.DebuggingModes.EnableEditAndContinue)]
[assembly: SecurityPermission(SecurityAction.RequestMinimum, SkipVerification = true)]
[assembly: AssemblyVersion("0.0.0.0")]
[module: UnverifiableCode]
public class C
{
    public void M()
    {
    }
}
```

Visual Basic.NETã‚’é¸ã‚“ã§è¡¨ç¤ºã•ã‚Œã‚‹C# Decompileçµæœã¯C# ã¨ã»ã¼åŒã˜ã§ã™ã­ã€‚

```vb
Imports System
Public Class C
    Public Sub M()
    End Sub
End Class
```

```cs
using System.Diagnostics;
using System.Reflection;
using System.Runtime.CompilerServices;

[assembly: CompilationRelaxations(8)]
[assembly: RuntimeCompatibility(WrapNonExceptionThrows = true)]
[assembly: Debuggable(DebuggableAttribute.DebuggingModes.Default | DebuggableAttribute.DebuggingModes.DisableOptimizations | DebuggableAttribute.DebuggingModes.IgnoreSymbolStoreSequencePoints | DebuggableAttribute.DebuggingModes.EnableEditAndContinue)]
[assembly: AssemblyVersion("0.0.0.0")]
public class C
{
    public void M()
    {
    }
}
```

F# ã ã¨ã‚¬ãƒ©ãƒƒã¨é›°å›²æ°—é•ã†ã®ã¯èˆˆå‘³æ·±ã„ã§ã™ã€‚

```fsharp
open System
type C() =
    member this.M() = ()
```

```cs
using Microsoft.FSharp.Core;
using System;
using System.Reflection;

[assembly: FSharpInterfaceDataVersion(2, 0, 0)]
[assembly: AssemblyVersion("0.0.0.0")]
[CompilationMapping(SourceConstructFlags.Module)]
public static class _
{
    [Serializable]
    [CompilationMapping(SourceConstructFlags.ObjectType)]
    public class C
    {
        public C()
        {
            ((object)this)..ctor();
        }

        public void M()
        {
        }
    }
}
namespace <StartupCode$_>
{
    internal static class $_
    {
    }
}
```

<figure class="figure-image figure-image-fotolife" title="F#ã‹ã‚‰C# Decompile">[f:id:guitarrapc_tech:20190214044411p:plain]<figcaption>F#ã‹ã‚‰C# Decompile</figcaption></figure>

## Other

è¡¨ç¤ºåˆ‡æ›¿ã®ä¸­ã«ã€Decompileä»¥å¤–ã«OtherãŒã‚ã‚Šã¾ã™ã€‚

**Syntax** ã‚‚ãã®1ã¤ã§ã€Sharplabã‚’ä½¿ã†ã“ã¨ã§Roslynã«ã‚ˆã‚‹SyntaxTreeã®çŠ¶æ…‹ã‚‚ç¢ºèªã§ãã¾ã™ã€‚

<figure class="figure-image figure-image-fotolife" title="SyntaxTreeçŠ¶æ…‹">[f:id:guitarrapc_tech:20190214044802p:plain]<figcaption>SyntaxTreeçŠ¶æ…‹</figcaption></figure>

Roslynæ‹¡å¼µã‚’æ›¸ãã¨ããªã©ã«ã«ã‚‰ã‚ã£ã“ã—ãŸã‚Šã™ã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ãŒã€LinqPadä»¥å¤–ã§ã‚‚ãã‚Œã„ã«ã¿ã‚Œã‚‹ã®ã¯ã†ã‚Œã—ã„ã‚‚ã®ãŒã‚ã‚Šã¾ã™ã€‚

**Verify Only** ã‚’é¸ã¶ã“ã¨ã§ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã§ãã‚‹ã‹ã®ç¢ºèªãŒã§ãã¾ã™ã€‚ãã‚‚ãã‚‚ã‚³ãƒ¼ãƒ‰å…¥åŠ›ä¸­ã«ãŒã—ãŒã—è©•ä¾¡ã•ã‚Œã¦ã‚¨ãƒ©ãƒ¼ãŒãšã‚‰ãšã‚‰ã§ã‚‹ã®ã§ã€Verifyã—ãªãã¨ã‚‚æ°—ä»˜ã‘ã‚‹ã®ã§ã™ãŒã€‚

<figure class="figure-image figure-image-fotolife" title="Verify">[f:id:guitarrapc_tech:20190214045947p:plain]<figcaption>Verify</figcaption></figure>


**Explain** ã‚’é¸ã¶ã¨ã€ä½™ã‚Šä½¿ã‚ã‚Œãªã„ã‚·ãƒ³ã‚¿ãƒƒã‚¯ã‚¹ã®èª¬æ˜ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚ä¾‹ãˆã°ã€äºˆç´„èªã‚’å¤‰æ•°åã«ä½¿ã†`@var`ã‚·ãƒ³ã‚¿ãƒƒã‚¯ã‚¹ã‚’ä½¿ã£ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

> [@varã®ã‚³ãƒ¼ãƒ‰](https://sharplab.io/#v2:EYLgZgpghgLgrgJwgZwLQBEJinANjASQDsYIFsBjCAgWwAdcIaITYBLAeyIBoYQIAHgyhseAExABqAD4ABAAwACWQEYA3AFgAULIDMygEyKAwooDe2xVeX7ZAFkUBZABQBKc5eteAblATLZX38AXkUAIjDNLS8AX204rW1RUnIoKkUACQ4AcwgPaOtVJQAVQRhzXJg1ZAgqhK9PKz1lBwAxOGyoN0b8ry9VAE5nUoEYVyjY+KA==)


```cs
using System;
public class C {
    public void M() {
        var @var = "";
    }
}
```

```
@var is a verbatim identifier. [Docs]
Prefix @ allows keywords to be used as a name (for a variable, parameter, field, class, etc).
For example, M(string string) doesn't compile, while M(string @string) does.
```

<figure class="figure-image figure-image-fotolife" title="Explainã«ã‚ˆã‚‹åˆ©ç”¨é »åº¦ã®ä½ã„ã‚·ãƒ³ã‚¿ãƒƒã‚¯ã‚¹ã®èª¬æ˜">[f:id:guitarrapc_tech:20190214050433p:plain]<figcaption>Explainã«ã‚ˆã‚‹åˆ©ç”¨é »åº¦ã®ä½ã„ã‚·ãƒ³ã‚¿ãƒƒã‚¯ã‚¹ã®èª¬æ˜</figcaption></figure>

ã‚¤ãƒ³ã‚¿ãƒ•ã‚§ãƒ¼ã‚¹ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå®Ÿè£…ãªã©ã€æ–°ã—ã„æ©Ÿèƒ½ã¯ã¾ã èª¬æ˜ãŒãªã„ã®ã§ã¡ã¾ã¡ã¾Issueã‚’è¦‹ã‚‹ã¨ã„ã„ã§ã™ã€‚


```chsarp
interface Hoge {
    string Text {get;set;}

    public void Fuga()
    {
        Console.WriteLine(Text);
    }
}
```

> https://github.com/ashmind/language-syntax-explanations/issues

## Run

ã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œã§ãã‚‹ã®ã§ã€LinqPadã§è»½ãå®Ÿè¡Œã™ã‚‹ã®ã‚’Webã§è©¦ã›ã‚‹ã®ã§ã€C# ã®æ›¸ãæ¨ã¦ã‚³ãƒ¼ãƒ‰ã¨ã—ã¦ã¯ç›¸å½“æ¥½ãªã®ã§ã¯ãªã„ã§ã—ã‚‡ã†ã‹ã€‚
ã“ã®æ™‚ã€çµæœè¡¨ç¤ºã«ã¯`Console.WriteLine()`ã«ã‚ˆã‚‹stdoutä»¥å¤–ã«ã‚‚ã€`<ä½•ã‹ã—ã‚‰ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ>.Inspect()`æ‹¡å¼µãƒ¡ã‚½ãƒƒãƒ‰ã§ã‚‚è¡¨ç¤ºã§ãã¾ã™ã€‚Inspectãƒ¡ã‚½ãƒƒãƒ‰ã¯ã€LinqPadã®`.Dump()`ã«è¿‘ã„æ„Ÿè¦šã§ã‚°ãƒ©ãƒ•ã‚£ã‚«ãƒ«ã«ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒè¡¨ç¤ºã•ã‚Œã‚‹ã®ã§ã„ã„æ„Ÿã˜ã§ã™ã€‚

<figure class="figure-image figure-image-fotolife" title="ä¸Š Console.WriteLine()ã€ä¸‹ .Inspect() æ‹¡å¼µãƒ¡ã‚½ãƒƒãƒ‰">[f:id:guitarrapc_tech:20190214052446p:plain]<figcaption>ä¸Š Console.WriteLine()ã€ä¸‹ .Inspect() æ‹¡å¼µãƒ¡ã‚½ãƒƒãƒ‰</figcaption></figure>

ä»–ã«ã‚‚ãƒ’ãƒ¼ãƒ—çŠ¶æ…‹ã®ç¢ºèªã«ä½¿ãˆã‚‹`Inspect.Heap()`ãƒ¡ã‚½ãƒƒãƒ‰ã‚„ã€ã‚¹ã‚¿ãƒƒã‚¯çŠ¶æ…‹ã®ç¢ºèªã«ä½¿ãˆã‚‹`Inspect.Stack()`ãƒ¡ã‚½ãƒƒãƒ‰ãŒã‚ã‚Šã¾ã™ã€‚

> [Runã«ã‚ˆã‚‹ã‚³ãƒ¼ãƒ‰å®Ÿè¡Œ](https://sharplab.io/#v2:C4LgTgrgdgNAJiA1AHwAIAYAEqCMBuAWAChUAmdY1AZmxwDZtTaB2TAb2My+xtwdQAsmALIBDAJZQAFAEp2nbotwBOKQCJAPBuAQfbUzCRRYqgBTAO6YA2gF12agBYB7AObG1MTGoC2z1wF8AdACSUADOAA7GAMbAsvqG3MHhUcD+ABLGomFSJubWtmHibh4Ang5qvnoK8YkR0f4AysCikQDW2WaWNmw47qQVcdy+xL5AA==)

```chsarp
using System;
// Run mode:
//   value.Inspect()      â€” often better than Console.WriteLine
//   Inspect.Heap(object) â€” structure of an object in memory (heap)
//   Inspect.Stack(value) â€” structure of a stack value
public static class Program {
    public static void Main() {
        Console.WriteLine("ğŸŒ„");
        new [] {"hoge", "moge"}.Inspect();
        Inspect.Heap(new [] {"pi", "yo"});
        Inspect.Stack(new [] {1, 2});
    }
}
```

<figure class="figure-image figure-image-fotolife" title="Runã®è¡¨ç¤ºçµæœ">[f:id:guitarrapc_tech:20190214052423p:plain]<figcaption>Runã®è¡¨ç¤ºçµæœ</figcaption></figure>

# C# ã®ãƒ¡ãƒ¢ãƒªçŠ¶æ…‹ã‚’ç¢ºèªã™ã‚‹

ã•ã¦ã€ã“ã®è¨˜äº‹ã®æœ¬ç­‹ã«æˆ»ã‚Šã¾ã—ã‚‡ã†ã€‚C# ã‚’æ›¸ã„ã¦ã„ã‚‹ã¨ã‚³ãƒ¼ãƒ‰ã‹ã‚‰ã¯æŒ™å‹•ã‚„ILã‚’è¦‹ãªã„ã¨åˆ¤æ–­ã«è¿·ã†ã‚±ãƒ¼ã‚¹ã¯å°‘ãªã‹ã‚‰ãšã‚ã‚Šã¾ã™ã€‚ç§ã¯å°‘ãªãã¨ã‚‚ãŸãã•ã‚“ã‚ã‚Šã¾ã™ã€‚

Visual Studioã‚„VS Codeã§ãƒ‘ãƒƒã¨æ€ã„ã¤ãã„ã„æ„Ÿã˜ã®ã‚„ã‚Šæ–¹ãŒãªãã€ç§ã¯ã‚‚ã£ã±ã‚‰LinqPadã§ã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œã—ã¤ã¤ILã‚’è¦‹ãŸã‚Šã—ã¦ç¢ºèªã—ã¦ã„ã¾ã—ãŸã€‚Unityã®Profilerã‚’ä½¿ã†ã¨ã„ã†æ‰‹ã‚‚ã‚ã‚Šã¾ã™ãŒã€å°‘ã—ãƒã‚¤ã‚ºãŒå¤šãã‚„ã‚Šã«ãã•ã¯ã¬ããˆã¾ã›ã‚“ã€‚

ãƒ¡ãƒ¢ãƒªã®çŠ¶æ…‹ã‚’ç¢ºèªã™ã‚‹ã«ã¯ã€ãƒ¡ãƒ¢ãƒªã®çŠ¶æ…‹ãŒå¯è¦–åŒ–ã•ã‚Œã‚‹ã¨ç›´æ„Ÿçš„ã§ã™ãŒã€ãã‚ŒãŒãªã„/ãã“ã¾ã§ãŒé ã„ã®ã§ã™ã­ã€‚

ãã‚“ãªæ™‚ã«Sharplabã®``Inspect.MemoryGraph()`ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ä½¿ã†ã¨ãƒ¡ãƒ¢ãƒªãƒãƒƒãƒ—ãŒå¯è¦–åŒ–ã•ã‚Œã€ã‚ã‹ã‚Šã‚„ã™ã•ã‚’å¤§ã„ã«åŠ©ã‘ã¦ãã‚Œã¾ã™ã€‚æ—©é€Ÿã“ã‚Œã‚’ä½¿ã£ã¦Boxing (ãƒœãƒƒã‚¯ã‚¹åŒ–) ã¨ã€æ§‹é€ ä½“ã«ãŠã‘ã‚‹stringã®å‚ç…§ã®ã•ã‚Œæ–¹ã€ã‚¯ãƒ©ã‚¹ã§ã¯ã©ã†å¤‰ã‚ã‚‹ã®ã‹ã‚’è¦‹ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

## Boxing ã‚’å¯è¦–åŒ–ã™ã‚‹

Boxingã¯ã€C# ã§èµ·ã“ã‚Šã‚„ã™ã„å‰²ã«æ¡ˆå¤–åˆ†ã‹ã‚Šã«ãã„ã¨æ„Ÿã˜ã‚‹çŠ¶æ…‹ã®1ã¤ã§ã™ã€‚èª¬æ˜ã¯é©å½“ã«è³‡æ–™ã«è­²ã‚‹ã¨ã—ã¦ã€intã‚’ãƒœãƒƒã‚¯ã‚¹åŒ–ã—ã¦objectã«ä»£å…¥ã—ãŸçŠ¶æ…‹ã‚’è€ƒãˆã¦ã¿ã¾ã—ã‚‡ã†ã€‚

> https://docs.microsoft.com/ja-jp/dotnet/csharp/programming-guide/types/boxing-and-unboxing

> [int ã‚’ãƒœãƒƒã‚¯ã‚¹åŒ–ã—ã¦objectã«ä»£å…¥ã—ãŸã‚³ãƒ¼ãƒ‰](https://sharplab.io/#v2:C4LgTgrgdgNAJiA1AHwAIAYAEqCMBuAWAChUBmbHANmwCYKB2TAb2Mze3N2tQBZMBZAIYBLKAAoAlM1btZAN0FhMAD0wBeTAFZCRAJCyA9gCMAVgFMAxsEwBPdSp2zZASSgBnAA6XgAOn5mAWwMwGwBxMEEPAAsxGwlHdgBfYkSgA===)

```cs
using System;
public static class Program {
    public static void Main() {
        var x = 5;
        object y = x;
        Inspect.MemoryGraph(y);
    }
}
```

æ˜ã‚‰ã‹ã«æ™®æ®µæ›¸ã‹ãªã„ã‚³ãƒ¼ãƒ‰ã®ã‚ˆã†ã«è¦‹ãˆã¾ã™ãŒã€å ´åˆã«ã‚ˆã£ã¦ã¯æ›¸ãã¾ã™ã€‚ã“ã“ã¾ã§ã‚ã‹ã‚Šã‚„ã™ã„ã¨ãƒ‘ãƒƒãƒˆé ­ã§BoxingçŠ¶æ…‹ãŒæ›¸ã‘ãã†ã§ã™ãŒã€å®Ÿéš›ã«æ€ã„æã„ãŸã‚‚ã®ã¨ä¸€ç·’ã‹è¦‹ã‚‹ã®ã«å¤‰æ•°`y`ã‚’`Inspect.MemoryGraph(o)`ã¨ã—ã¦å¯è¦–åŒ–ã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

<figure class="figure-image figure-image-fotolife" title="intã‚’ãƒœãƒƒã‚¯ã‚¹åŒ–ã—ã¦objectã«ä»£å…¥ã—ãŸçŠ¶æ…‹">[f:id:guitarrapc_tech:20190214053758p:plain]<figcaption>intã‚’ãƒœãƒƒã‚¯ã‚¹åŒ–ã—ã¦objectã«ä»£å…¥ã—ãŸçŠ¶æ…‹</figcaption></figure>

ã§ã¯ã€inté…åˆ—ã‚’objecté…åˆ—ã§ãƒœãƒƒã‚¯ã‚¹åŒ–ã™ã‚‹ã¨ã©ã†ãªã‚‹ã§ã—ã‚‡ã†ã‹ã€‚

> [int ã‚’ãƒœãƒƒã‚¯ã‚¹åŒ–ã—ã¦objecté…åˆ—ã«ä»£å…¥ã—ãŸ](https://sharplab.io/#v2:C4LgTgrgdgNAJiA1AHwAIAYAEqCMBuAWAChUBmbHANmwCYKB2TAb2Mze3N2tQBZMBZAIYBLKAAoAlM1btZAN0FhMAe0wBeTFACmAdxUAjAFZaAxsADaAXWY4YmGndIBfQkVmyAklADOAB1PAAHT8WgC2ymAAngDiYIK+ABZiyhKusk7ETkA=)

```cs
using System;
public static class Program {
    public static void Main() {
        var o = new object[] {1, 2, 3};
        Inspect.MemoryGraph(o);
    }
}
```

å¤‰æ•°`o`ã‚’`Inspect.MemoryGraph(o)`ã¨ã—ã¦å¯è¦–åŒ–ã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

<figure class="figure-image figure-image-fotolife" title="Boxingã®å¯è¦–åŒ–">[f:id:guitarrapc_tech:20190214053532p:plain]<figcaption>Boxingã®å¯è¦–åŒ–</figcaption></figure>

æˆ»ã‚Šå€¤ãŒvoidã ã¨Inspectã—ã‚ˆã†ãŒãªã„ã®ã§å¯è¦–åŒ–ã§ããšã€æ¬¡ã®ã‚³ãƒ¼ãƒ‰ã¯ã‚¨ãƒ©ãƒ¼ã«ãªã‚Šã¾ã™ã€‚

> [voidã¯Inspectã§ããªã„](https://sharplab.io/#v2:C4LgTgrgdgNAJiA1AHwAIAYAEqCMBuAWAChUBmbHANmwCYKB2TAb2Mze3N2tQBZMBZAIYBLKAAoAlM1btZASSgBnAA4BTAMbAAdP1UBbAPZgAngHEwg5QAsxuAJxicEiYSKyAvsXdA==)

```cs
using System;
public static class Program {
    public static void Main() {
        Inspect.MemoryGraph(Console.WriteLine(1));
    }
}
```

ã€ŒintãŒobjectã§ãƒœãƒƒã‚¯ã‚¹åŒ–ã•ã‚Œã¦ã„ã‚‹ã€ã¨è¨€è‘‰ã§èã„ã¦ã€ã‚³ãƒ¼ãƒ‰ã§ã‚‚æ›¸ã‘ã‚‹ã¨ãã¯ã„ã„ã®ã§ã™ãŒã€ã€Œã“ã‚Œã‚‚ã—ã‹ã—ã¦ãƒœãƒƒã‚¯ã‚¹åŒ–ã—ã¦ã‚‹?ã€ã¨ã„ã†æ™‚ã«ã‚µã‚¯ãƒƒã¨æ›¸ã„ã¦ã€ãƒ¡ãƒ¢ãƒªã®çŠ¶æ…‹ã‚’å¯è¦–åŒ–ã§ãã‚‹ã®ã¯ã‹ãªã‚Šä¾¿åˆ©ã§ã™ã€‚

## æ§‹é€ ä½“ã«ãŠã‘ã‚‹æ–‡å­—åˆ—ã®å‚ç…§çŠ¶æ…‹ã‚’ç¢ºèªã™ã‚‹

ã“ã‚“ãªç–‘å•ãŒã‚ã‚Šã¾ã™ã€‚

<blockquote class="twitter-tweet" data-lang="en"><p lang="ja" dir="ltr">string ã‚’ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«æŒã¤æ§‹é€ ä½“ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’å¼•æ•°ã«å…¥ã‚ŒãŸã‚Šã™ã‚‹ã¨ãã€string ã¯æ–‡å­—åˆ—å…¨ä½“ä¸¸ã£ã¨ã‚³ãƒ”ãƒ¼ã•ã‚Œã‚‹ã®ã‹å‚ç…§ (å…ˆé ­ã‚¢ãƒ‰ãƒ¬ã‚¹) ã ã‘ã‚³ãƒ”ãƒ¼ã•ã‚Œã‚‹ã®ã‹ã©ã£ã¡ã ã£ã‘ï¼Ÿ<br><br>(ã“ã‚“ãªã“ã¨ã§æ‚©ã‚“ã§ã‚‹ã‚ãŸã‚Šãƒ€ãƒ¡ãƒ€ãƒ¡éãã‚‹æ„Ÿã‚ã‚‹ã‘ã©ã€å®Ÿéš›ã‚ã‹ã‚“ãªã„)</p>&mdash; ã˜ã‚“ãã‚‹ (@xin9le) <a href="https://twitter.com/xin9le/status/1095467424365764608?ref_src=twsrc%5Etfw">February 12, 2019</a></blockquote>
<script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>

ILã‚’è¦‹ã‚Œã°ã™ãã«ã‚ã‹ã‚‹ã‚±ãƒ¼ã‚¹ã§ã™ãŒSharplabã‚’ä½¿ãˆã°å¯è¦–åŒ–ã•ã‚Œã¾ã™ã€‚æ¬¡ã®ã‚³ãƒ¼ãƒ‰ã‚’æ¨¡æ“¬ã‚³ãƒ¼ãƒ‰ã¨ã—ã¦ã¿ã¦ã¿ã¾ã—ã‚‡ã†ã€‚å€¤å‹ã®intã‚‚æŒãŸã›ã¦å‚ç…§å‹ã®stringã¨ã©ã†é•ã†ã‹ã¤ã„ã§ã«ç¢ºèªã—ã¾ã™ã€‚

> [æ§‹é€ ä½“ã§æ–‡å­—åˆ—ã‚’æŒãŸã›ãŸã¨ãã®ãƒ¡ãƒ¢ãƒªçŠ¶æ…‹](https://sharplab.io/#v2:C4LgTgrgdgNAJiA1AHwAIGYAEqCMA2bAJmxwHZMBvAWAChN7stcDUAWTAWQEMBLKACgCUlWgzGYAblzCYAzpgC8mKAFMA7pgDKQgNyjx9WQDpgKgB7BFmAEQAjFQDMA9mBXW9dA3KNQIAWyscDwBIMX0DKRlLJWNTCw8xYPDxSMwACytZBK80n38rQmyDZLFY82ibLgdTMHcShnr6AEkoWQAHFQBjYCMOFT8XAE8AcTAuNrT+WRhMYBm0wSLMAF9k5NlgSG6tZOpPemCMEgAGWfKQsSO+S18/JdWaZaA)

```cs
public static class Program {
    public static void Main() {
        var s = new S();
        s.text = "before";
        s.num = 1;

        var t = s.text;

        var h = s;
        h.num = 2;

        s.text = "after";

        Inspect.MemoryGraph(s, t, h);
    }

    struct S
    {
    	public string text;
	    public int num;
    }
}
```

<figure class="figure-image figure-image-fotolife" title="æ§‹é€ ä½“ã«ãŠã‘ã‚‹å‚ç…§çŠ¶æ…‹ã®ç¢ºèª">[f:id:guitarrapc_tech:20190214054719p:plain]<figcaption>æ§‹é€ ä½“ã«ãŠã‘ã‚‹å‚ç…§çŠ¶æ…‹ã®ç¢ºèª</figcaption></figure>

æ§‹é€ ä½“ã¯ã€å‚ç…§å‹ã§ã‚ã‚‹string(æ–‡å­—åˆ—) ã‚’å‚ç…§ã§æŒã£ã¦ã„ã‚‹ã“ã¨ãŒ`ref`ã‹ã‚‰ã‚ã‹ã‚Šã¾ã™ã­ã€‚
å¤‰æ•°`s`ã¯ã€`after`ã¨ã„ã†æ–‡å­—åˆ—ã‚’ä»£å…¥ã—ã¦ã„ã‚‹ã®ã§åˆ¥ã®æ–‡å­—åˆ—ã‚’å‚ç…§ã—ã¦ã„ã‚‹ã“ã¨ãŒåˆ†ã‹ã‚Šã¾ã™ã€‚

ã¡ãªã¿ã«LinqPadã§çµæœã‚’è¦‹ã‚‹ã¨æ¬¡ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

<figure class="figure-image figure-image-fotolife" title="LinqPadã«ã‚ˆã‚‹æ§‹é€ ä½“ã®çŠ¶æ…‹ç¢ºèª">[f:id:guitarrapc_tech:20190214054944p:plain]<figcaption>LinqPadã«ã‚ˆã‚‹æ§‹é€ ä½“ã®çŠ¶æ…‹ç¢ºèª</figcaption></figure>

ILè¦‹ã‚Œã°ã€ãªã‚‹ã»ã©`ldloca`ã€`Ldfld`ã€‚

```
IL_0000:  nop
IL_0001:  ldloca.s    00 // s
IL_0003:  initobj     UserQuery.S
IL_0009:  ldloca.s    00 // s
IL_000B:  ldstr       "before"
IL_0010:  stfld       UserQuery+S.text
IL_0015:  ldloca.s    00 // s
IL_0017:  ldc.i4.1
IL_0018:  stfld       UserQuery+S.num
IL_001D:  ldloc.0     // s
IL_001E:  ldfld       UserQuery+S.text
IL_0023:  stloc.1     // t
IL_0024:  ldloc.0     // s
IL_0025:  stloc.2     // h
IL_0026:  ldloca.s    02 // h
IL_0028:  ldc.i4.2
IL_0029:  stfld       UserQuery+S.num
IL_002E:  ldloca.s    00 // s
IL_0030:  ldstr       "after"
IL_0035:  stfld       UserQuery+S.text
IL_003A:  ldloc.0     // s
IL_003B:  call        LINQPad.Extensions.Dump<S>
IL_0040:  pop
IL_0041:  ldloc.1     // t
IL_0042:  call        LINQPad.Extensions.Dump<String>
IL_0047:  pop
IL_0048:  ldloc.2     // h
IL_0049:  call        LINQPad.Extensions.Dump<S>
IL_004E:  pop
IL_004F:  ret
```

## ã‚¯ãƒ©ã‚¹ã«ãŠã‘ã‚‹å‚ç…§çŠ¶æ…‹ã‚’ç¢ºèªã™ã‚‹

å…ˆã»ã©ã®æ§‹é€ ä½“Sã‚’ã€ã‚¯ãƒ©ã‚¹ã«ã™ã‚‹ã¨ã©ã†ãªã‚‹ã‹è¦‹ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

> [ã‚¯ãƒ©ã‚¹ã§æ–‡å­—åˆ—ã‚’æŒãŸã›ãŸã¨ãã®ãƒ¡ãƒ¢ãƒªçŠ¶æ…‹](https://sharplab.io/#v2:C4LgTgrgdgNAJiA1AHwAIGYAEqCMA2bAJmxwHZMBvAWAChN7stcDUAWTAWQEMBLKACgCUlWgzGYAblzCYAzpgC8mKAFMA7pgDKQgNyjx9WQDpgKgB7BFmAEQAjFQDMA9mBXW9dA3KNQIAWyscDwBIMX0DKRlLJWNTCw8xYPDxSMwACytZBK80n38rQmyDZLFY82ibLgdTMHcShnr6AEkoWQAHFQBjYCMOFT8XAE8AcTAuNrT+WRhMYBm0wSLMAF9k5NRiTWTqT3pgjBIABlnykLEDvktfPyXVmmWgA==)

```cs
public static class Program {
    public static void Main() {
        var s = new S();
        s.text = "before";
        s.num = 1;

        var t = s.text;

        var h = s;
        h.num = 2;

        s.text = "after";

        Inspect.MemoryGraph(s, t, h);
    }

    class S
    {
    	public string text;
	    public int num;
    }
}
```

<figure class="figure-image figure-image-fotolife" title="ã‚¯ãƒ©ã‚¹ã«ãŠã‘ã‚‹å‚ç…§çŠ¶æ…‹ã®ç¢ºèª">[f:id:guitarrapc_tech:20190214055135p:plain]<figcaption>ã‚¯ãƒ©ã‚¹ã«ãŠã‘ã‚‹å‚ç…§çŠ¶æ…‹ã®ç¢ºèª</figcaption></figure>

æ§‹é€ ä½“ã¨é•ã„ã€ãã‚Œãã‚Œã®å€¤ãŒå‚ç…§ã§ã¤ãªãŒã£ã¦ã„ã‚‹ã®ãŒåˆ†ã‹ã‚Šã¾ã™ãŒã€åˆ†ã‹ã‚Šã«ãã„ã§ã™ã­ï¼ LinqPadã§å®Ÿè¡Œã™ã‚‹ã¨ã€ã‚¯ãƒ©ã‚¹ã®æ™‚ã¨æ§‹é€ ä½“ã®æ™‚ã§çµæœãŒå¤‰ã‚ã£ã¦ã„ã‚‹ã“ã¨ãŒåˆ†ã‹ã‚Šã¾ã™ã€‚

<figure class="figure-image figure-image-fotolife" title="LinqPadã«ã‚ˆã‚‹ã‚¯ãƒ©ã‚¹ã®çŠ¶æ…‹ç¢ºèª">[f:id:guitarrapc_tech:20190214055323p:plain]<figcaption>LinqPadã«ã‚ˆã‚‹ã‚¯ãƒ©ã‚¹ã®çŠ¶æ…‹ç¢ºèª</figcaption></figure>

é•ã„ã¯æ¬¡ã®é€šã‚Šã§ã™ã€‚

ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ | æ§‹é€ ä½“ | ã‚¯ãƒ©ã‚¹
---- | ---- | ----
s.text | after | after
s.num | 1 | 2
t | before | before
h.text | before | after
h.num | 2 | 2

ã‚³ãƒ¼ãƒ‰ã¨ãƒ¡ãƒ¢ãƒªã®çŠ¶æ…‹ã‚’è¦‹ã‚‹ã¨ç†ç”±ã¯æ˜ã‚‰ã‹ã§ã™ã€‚

<figure class="figure-image figure-image-fotolife" title="æ§‹é€ ä½“ã«ãŠã‘ã‚‹å‚ç…§çŠ¶æ…‹ã®ç¢ºèª">[f:id:guitarrapc_tech:20190214054719p:plain]<figcaption>æ§‹é€ ä½“ã«ãŠã‘ã‚‹å‚ç…§çŠ¶æ…‹ã®ç¢ºèª</figcaption></figure>
<figure class="figure-image figure-image-fotolife" title="ã‚¯ãƒ©ã‚¹ã«ãŠã‘ã‚‹å‚ç…§çŠ¶æ…‹ã®ç¢ºèª">[f:id:guitarrapc_tech:20190214055135p:plain]<figcaption>ã‚¯ãƒ©ã‚¹ã«ãŠã‘ã‚‹å‚ç…§çŠ¶æ…‹ã®ç¢ºèª</figcaption></figure>

ShapLabã§æ¥½ã—ã„C# ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚’éã”ã—ã¾ã—ã‚‡ã†ï¼
