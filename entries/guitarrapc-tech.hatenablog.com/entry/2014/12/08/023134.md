---
Title: 'PowerShell DSC Advent Calendar 2014 : Day 8 ConfigurationData を使ったロールや属性の指定'
Category:
- PowerShell
- DSC
- AdventCalendar
Date: 2014-12-08T23:51:34+09:00
URL: https://tech.guitarrapc.com/entry/2014/12/08/023134
EditURL: https://blog.hatena.ne.jp/guitarrapc_tech/guitarrapc-tech.hatenablog.com/atom/entry/8454420450075212894
---

これは、[http://www.adventar.org/calendars/579:title]8日目の記事です。

[http://www.adventar.org/calendars/579:embed]

7日目は、MOFファイルの生成について説明しました。コンフィグレーションの実行でMOFファイルがコンパイルされる。はい簡単です。

8日目の今日は、コンフィグレーションの実行時に出てきたコンフィグレーションデータ(ConfiguraionData)の利用についてです。

[:contents]

順番に見ていきましょう。

# コンフィグレーションデータとは

MSDNにあります。

> - [http://technet.microsoft.com/en-us/library/dn249925.aspx:title]

コンフィグレーションデータを使う目的は、**あるべき状態 と 環境データの分離**です。

つまり、コンフィグレーションで「あるべき状態」の記述をしたくても、対象のノード名など環境データが混じってしまうと「あるべき状態」の流用が困難になるでしょう。

では`Param`で渡すのはどうでしょうか？ やはりこれも余り適しません。なぜならCMツールは、**役割(ロール)ごとにノード共通のあるべき状態**を収束するためのものだからです。つまり、そのロールにはあるべき状態が定まっており、それは静的に定まるでしょう。`Param`は動的にコンフィグレーションを実行する時に便利ですが、それは実行時まであるべき状態が定まっていないなら使えますがそうではない。ということです。

たとえば、WebサーバーにインストールするのはIISやASP.NET。DBサーバーならSQLServer。ほら、ロールごとにいれるもの決まってますよね？ これが、静的に事前に定まっているということです。

まとめるとこうです。

あるべき状態の記述|環境データの記述
----|----
コンフィグレーション |コンフィグレーションデータ

具体的に見てみましょう。

# コンフィグレーションデータの記述

7日目に示したノードを含むサービスに関するコンフィグレーションを使って「コンフィグレーション(あるべき状態)」と「コンフィグレーションデータ(環境データ)」に分離してみましょう。

**元々のコンフィグレーション**

[https://gist.github.com/d89fbd801be78b907924:embed#gistd89fbd801be78b907924]


まずコンフィグレーションデータです。コンフィグレーションの中から、環境に依存するであろうノード名とサービス名を分離しました。これらを`Hashtable`形式で記述します。((産廃がここでも....ほげ...まぁはい。))

**コンフィグレーションデータ**

[https://gist.github.com/d07986082c25e8a895f3:embed#gistd07986082c25e8a895f3]

1つのHashtable内で、利用するロールごとに分離できる要素を記述しています。あるべき状態はそのままに、環境に属するデータを分離。これが、コンフィグレーションデータの役割です。

# コンフィグレーション でロールや属性を指定する

コンフィグレーションです。ロールベースで指定できるようにしています。

**環境データを分離したコンフィグレーション**

[https://gist.github.com/3d52bab84734149ffba8:embed#gist3d52bab84734149ffba8]

先ほどのハッシュテーブルを利用して、ロールからキーを指定して、さらに必要な属性をキーを使って指定します。

そこで`Param()`ブロックを設けて、`Param()`を渡してコンフィグレーションデータからロールを選択で切る用にしました。これで、コンフィグレーションデータを渡せば、任意の環境に合わせた構成になります。

# コンフィグレーションデータを渡して実行する

`Configuraion`構文の実行時におけるデフォルトパラメータにある`Configuraion`がそれです。

```
パラメーター
    -ConfigurationData <hashtable>

        必須                         false
        位置                         2
        パイプライン入力を許可する   false
        パラメーター セット名           (すべて)
        エイリアス                      なし
        動的                     false
```

コンフィグレーションデータをコンフィグレーションの実行時に渡してみましょう。今回は対象をDSCとするため、`-Role`に`-Role`を指定します。

[https://gist.github.com/2b1871a54ffe786c6b36:embed#gist2b1871a54ffe786c6b36]


では実行してみましょう。`Role`に`Role`をフィルタした通りに、Nodeが`Role`になっていることがMOFファイル名からわかりますね。

```
    Directory: D:\service


Mode                LastWriteTime         Length Name
----                -------------         ------ ----
-a----       2014/12/09      2:59           1858 127.0.0.1.mof
```

実行結果のMOFファイルです。サービス名も`ConfiguraionData`で指定した通りに、`ConfiguraionData`と`ConfiguraionData`になっていますね。

[https://gist.github.com/62fa66390af54b64a3f5:embed#gist62fa66390af54b64a3f5]

# まとめ

今回はコンフィグレーションデータの基本をお伝えしました。あるべき状態、環境依存のデータ。いろいろな分離方法がありますが、`Node`に関してはコンフィグレーションデータを使うのが定石になっています。

コンフィグレーションデータからしか渡せないパラメータなどもあるため、それは後日説明します。

ちなみに、コンフィグレーションの分離しすぎは無用な混乱をもたらすことがあるのと同様、コンフィグレーションデータもむやみに分離すると柔軟性が失われたり可読性を損なったりします。

そこはあえて、似たようなコンフィグレーションでも許容することも大事です。
