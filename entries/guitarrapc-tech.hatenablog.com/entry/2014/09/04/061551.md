---
Title: PowerShell Cmdlet のデバッグとかなんとか
Category:
- C#
- PowerShell
Date: 2014-09-04T06:15:51+09:00
URL: https://tech.guitarrapc.com/entry/2014/09/04/061551
EditURL: https://blog.hatena.ne.jp/guitarrapc_tech/guitarrapc-tech.hatenablog.com/atom/entry/12921228815731972594
---

最近は、もっぱらRespClientがお気に入りで欲しいと思ったものをちょいちょい追加しています。

> - [neuecc/RespClient](https://github.com/neuecc/RespClient)

Cmdletなので、VSでC# となります。

PowerShell ISEでのfunctionデバッグといえば、まぁごにょごにょ。

これが、Cmdletとなるとどうやるのかをちらっと見てみましょう。

[:contents]

# 手順

いたってふつーです。

1. Cnmdletを書く
2. ビルドしたdllをてきとーに配置
3. PowreShell.exeを開く
4. VSでプロセスをアタッチ
5. `Import-Module .\dllの名前.dll`でモジュールをインポート
6. ブレークポイントをテキトーにはってCmdletを実行


これで、VS内で設定したブレークポイントで停止、デバッグが可能になります。

##### Cmdlet を書く

書いてください。

##### ビルドしたdll をテキトーに配置

はい、てきとーです。

<p><span itemscope itemtype="https://schema.org/Photograph"><img src="https://cdn-ak.f.st-hatena.com/images/fotolife/g/guitarrapc_tech/20140904/20140904060432.png" alt="f:id:guitarrapc_tech:20140904060432p:plain" title="f:id:guitarrapc_tech:20140904060432p:plain" class="hatena-fotolife" itemprop="image"></span></p>

##### PowerShell.exeを開く

dllのパスで、`File > Open PowerShell`が楽でしょう。

<p><span itemscope itemtype="https://schema.org/Photograph"><img src="https://cdn-ak.f.st-hatena.com/images/fotolife/g/guitarrapc_tech/20140904/20140904060545.png" alt="f:id:guitarrapc_tech:20140904060545p:plain" title="f:id:guitarrapc_tech:20140904060545p:plain" class="hatena-fotolife" itemprop="image"></span></p>

##### VS でプロセスをアタッチ

PowerShell.exeを開いたら開いたPowerShellプロセスをVSにアタッチしましょう。

<p><span itemscope itemtype="https://schema.org/Photograph"><img src="https://cdn-ak.f.st-hatena.com/images/fotolife/g/guitarrapc_tech/20140904/20140904060620.png" alt="f:id:guitarrapc_tech:20140904060620p:plain" title="f:id:guitarrapc_tech:20140904060620p:plain" class="hatena-fotolife" itemprop="image"></span></p>

<p><span itemscope itemtype="https://schema.org/Photograph"><img src="https://cdn-ak.f.st-hatena.com/images/fotolife/g/guitarrapc_tech/20140904/20140904060645.png" alt="f:id:guitarrapc_tech:20140904060645p:plain" title="f:id:guitarrapc_tech:20140904060645p:plain" class="hatena-fotolife" itemprop="image"></span></p>

これでみんな大好きウォッチ式も使えます。

<p><span itemscope itemtype="https://schema.org/Photograph"><img src="https://cdn-ak.f.st-hatena.com/images/fotolife/g/guitarrapc_tech/20140904/20140904060733.png" alt="f:id:guitarrapc_tech:20140904060733p:plain" title="f:id:guitarrapc_tech:20140904060733p:plain" class="hatena-fotolife" itemprop="image"></span></p>

##### .dll からモジュールをインポート

.dllと同一パスでPowershell.exeを開いていれば簡単でしょう。

```ps1
Import-Module .\RespClient.dll
```

<p><span itemscope itemtype="https://schema.org/Photograph"><img src="https://cdn-ak.f.st-hatena.com/images/fotolife/g/guitarrapc_tech/20140904/20140904060900.png" alt="f:id:guitarrapc_tech:20140904060900p:plain" title="f:id:guitarrapc_tech:20140904060900p:plain" class="hatena-fotolife" itemprop="image"></span></p>

##### ブレークポイントをテキトーにはってCmdletを実行

VSでテキトーにブレークポイントを貼ります。

<p><span itemscope itemtype="https://schema.org/Photograph"><img src="https://cdn-ak.f.st-hatena.com/images/fotolife/g/guitarrapc_tech/20140904/20140904061031.png" alt="f:id:guitarrapc_tech:20140904061031p:plain" title="f:id:guitarrapc_tech:20140904061031p:plain" class="hatena-fotolife" itemprop="image"></span></p>

PowerShell.exeでCmdletを実行しましょう。

VSで張ったブレークポイントにフォーカスが遷移して止まったはずです。

<p><span itemscope itemtype="https://schema.org/Photograph"><img src="https://cdn-ak.f.st-hatena.com/images/fotolife/g/guitarrapc_tech/20140904/20140904061224.png" alt="f:id:guitarrapc_tech:20140904061224p:plain" title="f:id:guitarrapc_tech:20140904061224p:plain" class="hatena-fotolife" itemprop="image"></span></p>

ローカルも、ウォッチ式も使えますねー。

<p><span itemscope itemtype="https://schema.org/Photograph"><img src="https://cdn-ak.f.st-hatena.com/images/fotolife/g/guitarrapc_tech/20140904/20140904061328.png" alt="f:id:guitarrapc_tech:20140904061328p:plain" title="f:id:guitarrapc_tech:20140904061328p:plain" class="hatena-fotolife" itemprop="image"></span></p>

<p><span itemscope itemtype="https://schema.org/Photograph"><img src="https://cdn-ak.f.st-hatena.com/images/fotolife/g/guitarrapc_tech/20140904/20140904061347.png" alt="f:id:guitarrapc_tech:20140904061347p:plain" title="f:id:guitarrapc_tech:20140904061347p:plain" class="hatena-fotolife" itemprop="image"></span></p>

あとは、F10やF11など、ステップイン/アウトを使ったりブレークポイントをずらしたりしてはかどってください。

# 注意点

Add-Typeなどで気づかれている方も多いかと思いますが、PowerShell.exeやPowerShell ISEは、そのプロセスでインポートしたモジュール`.dll`やスナップインとして読み込んだ`.dll`をハンドルしっぱなしになります。

そのため、ビルドしなおしてdllを再配置使用としたらファイルロックと怒られたりします。 えー、やだー

PowerShellスクリプトで書いた、スクリプトモジュールはハンドルしないのにふぇぇです。

そのため、「一度 .dllを読み込んだら、プロセスを終了しないと .dllがハンドルされる」ことを覚えておいてください。うざいですね。

Roslynや .NET Native 、 vNextなどが出て来たら改善するんでしょうか？ ((いやしないだろう))

# まとめ

VSのデバッグは、間違いなくISEよりはかどります。

PowerShell ScriptをISEやVSで書くよりもはかどったりするので、ぜひぜひどうぞ。
